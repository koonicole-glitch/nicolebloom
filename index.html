<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3f4a2a" />
  <title>Nicole 2026 Health Log â€” FIX6-R1</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Fallback minimal styles if Tailwind CDN is blocked */
    body{font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Microsoft JhengHei", Arial, "Apple Color Emoji","Segoe UI Emoji";}
    .no-tailwind .tw{all:unset}
  </style>
  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-[#fbf7ef] text-[#1f2a16] min-h-screen">
  <div id="app" class="max-w-md mx-auto pb-24">
    <!-- Top bar -->
    <header class="px-4 pt-4">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-xs opacity-70">Nicole 2026 Health Log</div>
          <div class="text-xl font-semibold">ä»Šæ—¥ç¸½è¦½ <span class="text-xs font-normal opacity-60" id="verTag">FIX6-R1</span></div>
          <div class="text-xs opacity-70 mt-1">åŒæ­¥ä»£è™Ÿï¼š<span class="font-mono" id="syncIdText">-</span></div>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnPrevDay" class="px-3 py-2 rounded-xl border border-[#d9d2c2] bg-white active:scale-[0.98]">â—€</button>
          <div class="px-3 py-2 rounded-xl border border-[#d9d2c2] bg-white font-mono text-sm" id="dateText">-</div>
          <button id="btnNextDay" class="px-3 py-2 rounded-xl border border-[#d9d2c2] bg-white active:scale-[0.98]">â–¶</button>
        </div>
      </div>
    </header>

    <!-- Pages -->
    <main class="px-4 mt-4">
      <!-- Overview -->
      <section id="page-overview" class="space-y-4">
        <div class="rounded-3xl bg-[#3f4a2a] text-white p-5 shadow-sm">
          <div class="flex items-center justify-between">
            <div class="text-sm opacity-90">ä»Šæ—¥ç¸½è¦½</div>
            <div class="text-xs bg-white/15 px-3 py-1 rounded-full" id="restDayPill">ä¸€èˆ¬æ—¥</div>
          </div>
          <div class="mt-2 flex items-end justify-between">
            <div>
              <div class="text-5xl font-bold leading-none" id="kcalRemaining">-</div>
              <div class="text-sm opacity-90 mt-1">kcal å‰©é¤˜</div>
            </div>
            <div class="text-right">
              <div class="text-xs opacity-90">æ”å– <span id="kcalTaken">-</span> / <span id="kcalTarget">-</span></div>
              <div class="text-xs opacity-75 mt-1">P <span id="pTaken">-</span>/<span id="pTarget">-</span> Â· C <span id="cTaken">-</span>/<span id="cTarget">-</span> Â· F <span id="fTaken">-</span>/<span id="fTarget">-</span></div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="rounded-3xl bg-white p-4 border border-[#e8e0d0] shadow-sm">
            <div class="flex items-start justify-between">
              <div>
                <div class="font-semibold">å–æ°´</div>
                <div class="text-4xl font-bold mt-2" id="waterNow">0</div>
                <div class="text-xs opacity-70">ml / ç›®æ¨™ <span id="waterGoal">3000</span></div>
              </div>
              <button id="btnWaterAdd" class="px-3 py-2 rounded-xl bg-[#3f4a2a] text-white font-semibold shadow-sm active:scale-[0.98]">+250</button>
            </div>
            <div class="text-xs opacity-60 mt-2">ï¼ˆåªåœ¨ã€Œç¸½è¦½ã€åŠ æ°´ï¼Œé¿å…é‡è¤‡ï¼‰</div>
          </div>

          <div class="rounded-3xl bg-white p-4 border border-[#e8e0d0] shadow-sm">
            <div class="flex items-start justify-between">
              <div>
                <div class="font-semibold">æ­¥æ•¸</div>
                <div class="text-4xl font-bold mt-2" id="stepsNow">0</div>
                <div class="text-xs opacity-70">æ­¥ / ç›®æ¨™ <span id="stepsGoal">8000</span></div>
              </div>
              <button id="btnStepsAdd" class="px-3 py-2 rounded-xl bg-[#3f4a2a] text-white font-semibold shadow-sm active:scale-[0.98]">+500</button>
            </div>
            <div class="text-xs opacity-60 mt-2">ï¼ˆåªåœ¨ã€Œç¸½è¦½ã€åŠ æ­¥æ•¸ï¼Œé¿å…é‡è¤‡ï¼‰</div>
          </div>
        </div>

        <div class="rounded-3xl bg-white p-4 border border-[#e8e0d0] shadow-sm">
          <div class="flex items-center justify-between">
            <div class="font-semibold flex items-center gap-2">
              <span>ğŸ“‹</span><span>æ•™ç·´å›å ±</span>
            </div>
            <button id="btnCopyCoach" class="px-3 py-2 rounded-xl border border-[#d9d2c2] bg-white active:scale-[0.98]">è¤‡è£½</button>
          </div>
          <div class="mt-3 text-sm leading-6 whitespace-pre-wrap bg-[#fbf7ef] border border-[#efe7d8] rounded-2xl p-3" id="coachText">-</div>
          <div class="text-xs opacity-60 mt-2">å›å ±æœƒä»¥ã€Œæ‰€é¸æ—¥æœŸ=è¨˜éŒ„æ—¥ã€ï¼Œä¸¦æŠ“ã€Œå‰ä¸€æ—¥ã€çš„é£²é£Ÿ/æ°´é‡/æ­¥æ•¸/æœ‰æ°§ã€‚</div>
        </div>
      </section>

      <!-- Log -->
      <section id="page-log" class="space-y-4 hidden">
        <div class="rounded-3xl bg-white p-4 border border-[#e8e0d0] shadow-sm">
          <div class="font-semibold flex items-center gap-2"><span>ğŸ½ï¸</span><span>é£²é£Ÿè¨˜éŒ„</span></div>

          <div class="mt-3 flex gap-2">
            <button class="mealTab px-3 py-2 rounded-xl border border-[#d9d2c2] bg-white active:scale-[0.98]" data-meal="breakfast">æ—©é¤</button>
            <button class="mealTab px-3 py-2 rounded-xl border border-[#d9d2c2] bg-white active:scale-[0.98]" data-meal="lunch">åˆé¤</button>
            <button class="mealTab px-3 py-2 rounded-xl border border-[#d9d2c2] bg-white active:scale-[0.98]" data-meal="dinner">æ™šé¤</button>
            <button class="mealTab px-3 py-2 rounded-xl border border-[#d9d2c2] bg-white active:scale-[0.98]" data-meal="snack">é»å¿ƒ</button>
          </div>

          <div class="mt-3 flex items-center gap-2">
            <select id="presetSelect" class="w-1/2 px-3 py-3 rounded-2xl bg-[#fbf7ef] border border-[#e8e0d0] text-sm">
              <option value="">ï¼ˆå¸¸ç”¨é¤é»ï¼šé¸æ“‡å¯ç›´æ¥åŠ å…¥ï¼‰</option>
            </select>
            <button id="btnAddPreset" class="px-3 py-3 rounded-2xl border border-[#d9d2c2] bg-white active:scale-[0.98]">åŠ å…¥</button>
            <button id="btnManualAddToggle" class="ml-auto px-3 py-3 rounded-2xl border border-[#d9d2c2] bg-white active:scale-[0.98]">æ‰‹å‹•</button>
          </div>

          <div class="mt-3 flex items-center gap-2">
            <input id="foodInput" class="flex-1 px-4 py-4 rounded-2xl bg-[#fbf7ef] border border-[#e8e0d0] outline-none" placeholder="ä¾‹å¦‚ï¼šè›‹ã€åœ°ç“œã€æ‹¿éµ" />
            <button id="btnAddFood" class="w-14 h-14 rounded-2xl bg-[#3f4a2a] text-white text-2xl font-semibold shadow-sm active:scale-[0.98]">+</button>
          </div>

          <div class="mt-4 space-y-3" id="mealList"></div>

          <div class="text-xs opacity-60 mt-3">
            AI ä¼°ç®—ï¼šè«‹åœ¨ã€Œè¨­å®šã€å¡« Gemini API Keyï¼›å¤±æ•—æ™‚æœƒå…ˆç”¨ 0 é¡¯ç¤ºï¼Œå»ºè­°ç”¨ âœï¸ æ”¹æ­£ä¸¦å¯å­˜ç‚ºå¸¸ç”¨é¤é»ã€‚
          </div>
        </div>

        <div class="rounded-3xl bg-white p-4 border border-[#e8e0d0] shadow-sm">
          <div class="font-semibold flex items-center gap-2"><span>ğŸ‹ï¸</span><span>é‹å‹•ï¼ˆå‰ä¸€æ—¥å›å ±ç”¨ï¼‰</span></div>
          <div class="mt-3 grid grid-cols-2 gap-3">
            <div>
              <div class="text-sm opacity-80 mb-1">é‡è¨“ï¼ˆæ–‡å­—ï¼‰</div>
              <input id="strengthInput" class="w-full px-3 py-3 rounded-2xl bg-[#fbf7ef] border border-[#e8e0d0]" placeholder="ä¾‹å¦‚ï¼šé‡è¨“ä¸€å°æ™‚" />
            </div>
            <div>
              <div class="text-sm opacity-80 mb-1">æœ‰æ°§ï¼ˆæ–‡å­—ï¼‰</div>
              <input id="cardioInput" class="w-full px-3 py-3 rounded-2xl bg-[#fbf7ef] border border-[#e8e0d0]" placeholder="ä¾‹å¦‚ï¼š20åˆ†é˜è·‘æ­¥æ©Ÿæ…¢èµ°" />
            </div>
          </div>
          <button id="btnSaveWorkout" class="mt-3 w-full px-4 py-3 rounded-2xl bg-[#3f4a2a] text-white font-semibold shadow-sm active:scale-[0.98]">å„²å­˜é‹å‹•</button>
        </div>

        <div class="rounded-3xl bg-white p-4 border border-[#e8e0d0] shadow-sm">
          <div class="font-semibold flex items-center gap-2"><span>ğŸ§â€â™€ï¸</span><span>æ™¨é–“ç‹€æ…‹ï¼ˆè¨˜éŒ„æ—¥ï¼‰</span></div>
          <div class="mt-3 grid grid-cols-2 gap-3">
            <div>
              <div class="text-sm opacity-80 mb-1">ç©ºè…¹é«”é‡ï¼ˆkgï¼‰</div>
              <input id="weightInput" type="number" step="0.1" class="w-full px-3 py-3 rounded-2xl bg-[#fbf7ef] border border-[#e8e0d0]" />
            </div>
            <div>
              <div class="text-sm opacity-80 mb-1">æ—©èµ·ç–²å‹åº¦ï¼ˆ0-10ï¼‰</div>
              <input id="fatigueInput" type="number" step="1" min="0" max="10" class="w-full px-3 py-3 rounded-2xl bg-[#fbf7ef] border border-[#e8e0d0]" />
            </div>
            <div class="col-span-2">
              <div class="text-sm opacity-80 mb-1">å‰ä¸€æ—¥ç¡çœ æ™‚é•·ï¼ˆhrsï¼‰</div>
              <input id="sleepInput" type="number" step="0.1" class="w-full px-3 py-3 rounded-2xl bg-[#fbf7ef] border border-[#e8e0d0]" />
            </div>
          </div>
          <button id="btnSaveVitals" class="mt-3 w-full px-4 py-3 rounded-2xl bg-[#3f4a2a] text-white font-semibold shadow-sm active:scale-[0.98]">å„²å­˜ç‹€æ…‹</button>
          <div class="text-xs opacity-60 mt-2">ï¼ˆæ°´é‡/æ­¥æ•¸è«‹åœ¨ã€Œç¸½è¦½ã€èª¿æ•´ï¼Œé¿å…é‡è¤‡ï¼‰</div>
        </div>
      </section>

      <!-- History -->
      <section id="page-history" class="space-y-4 hidden">
        <div class="rounded-3xl bg-white p-4 border border-[#e8e0d0] shadow-sm">
          <div class="font-semibold flex items-center gap-2"><span>ğŸ“ˆ</span><span>æ­·å²ï¼ˆæœ€è¿‘ 14 å¤©ï¼‰</span></div>
          <div class="mt-3 space-y-2" id="historyList"></div>
        </div>
      </section>

      <!-- Settings -->
      <section id="page-settings" class="space-y-4 hidden">
        <div class="rounded-3xl bg-white p-4 border border-[#e8e0d0] shadow-sm">
          <div class="font-semibold flex items-center gap-2"><span>ğŸ”—</span><span>è·¨è£ç½®åŒæ­¥</span></div>
          <div class="text-sm opacity-75 mt-2">ç”¨åŒä¸€çµ„ã€ŒåŒæ­¥ä»£è™Ÿã€åœ¨å…¬å¸æ¡Œæ©Ÿ/æ‰‹æ©Ÿ/NB ç™»å…¥å³å¯åŒæ­¥ã€‚</div>
          <div class="mt-3">
            <div class="text-sm opacity-80 mb-1">ç›®å‰åŒæ­¥ä»£è™Ÿ</div>
            <div class="font-mono px-3 py-3 rounded-2xl bg-[#fbf7ef] border border-[#e8e0d0]" id="syncIdBox">-</div>
          </div>
          <div class="mt-3">
            <div class="text-sm opacity-80 mb-1">åˆ‡æ› / åŠ å…¥æ—¢æœ‰åŒæ­¥ä»£è™Ÿ</div>
            <input id="syncIdInput" class="w-full px-3 py-3 rounded-2xl bg-white border border-[#d9d2c2] font-mono" placeholder="è²¼ä¸ŠåŒæ­¥ä»£è™Ÿ" />
            <button id="btnUseSyncId" class="mt-2 w-full px-4 py-3 rounded-2xl bg-[#3f4a2a] text-white font-semibold shadow-sm active:scale-[0.98]">ä½¿ç”¨é€™çµ„åŒæ­¥ä»£è™Ÿ</button>
            <button id="btnNewSyncId" class="mt-2 w-full px-4 py-3 rounded-2xl border border-[#d9d2c2] bg-white font-semibold active:scale-[0.98]">é‡æ–°ç”¢ç”Ÿæ–°ä»£è™Ÿ</button>
          </div>
          <div class="text-xs opacity-60 mt-2">æé†’ï¼šè‹¥ä½ ä¹‹å‰ç”¨äº† Service Worker/PWAï¼Œè«‹ç”¨ã€Œç¡¬é‡æ–°æ•´ç†ã€é¿å…èˆŠç‰ˆå¿«å–ã€‚</div>
        </div>

        <div class="rounded-3xl bg-white p-4 border border-[#e8e0d0] shadow-sm">
          <div class="font-semibold flex items-center gap-2"><span>ğŸ¤–</span><span>AI ä¼°ç®—ï¼ˆGeminiï¼‰</span></div>
          <div class="text-sm opacity-75 mt-2">å»ºè­°ç”¨ JSON Modeï¼Œé¿å… AI å›å‚³ ```json``` é€ æˆè§£æå¤±æ•—ã€‚</div>
          <div class="mt-3">
            <div class="text-sm opacity-80 mb-1">Gemini API Key</div>
            <input id="apiKeyInput" class="w-full px-3 py-3 rounded-2xl bg-white border border-[#d9d2c2] font-mono" placeholder="AIza..." />
            <button id="btnSaveApiKey" class="mt-2 w-full px-4 py-3 rounded-2xl bg-[#3f4a2a] text-white font-semibold shadow-sm active:scale-[0.98]">å„²å­˜ API Key</button>
          </div>
          <div class="mt-3 text-xs opacity-60" id="aiStatus">AI ç‹€æ…‹ï¼šæœªè¨­å®š</div>
        </div>

        <div class="rounded-3xl bg-white p-4 border border-[#e8e0d0] shadow-sm">
          <div class="font-semibold flex items-center gap-2"><span>â¬‡ï¸</span><span>åŒ¯å‡º</span></div>
          <button id="btnExportCsv" class="mt-2 w-full px-4 py-3 rounded-2xl bg-[#3f4a2a] text-white font-semibold shadow-sm active:scale-[0.98]">åŒ¯å‡º CSVï¼ˆå…¨éƒ¨ï¼‰</button>
          <button id="btnExportCsvToday" class="mt-2 w-full px-4 py-3 rounded-2xl border border-[#d9d2c2] bg-white font-semibold active:scale-[0.98]">åŒ¯å‡º CSVï¼ˆç›®å‰æ—¥æœŸï¼‰</button>
        </div>
      </section>
    </main>

    <!-- Bottom nav -->
    <nav class="fixed bottom-0 left-0 right-0 bg-[#fbf7ef]/95 backdrop-blur border-t border-[#efe7d8]">
      <div class="max-w-md mx-auto px-4 py-3 grid grid-cols-4 text-center text-xs">
        <button class="navBtn py-2 rounded-2xl" data-page="overview">ç¸½è¦½</button>
        <button class="navBtn py-2 rounded-2xl" data-page="log">ç´€éŒ„</button>
        <button class="navBtn py-2 rounded-2xl" data-page="history">æ­·å²</button>
        <button class="navBtn py-2 rounded-2xl" data-page="settings">è¨­å®š</button>
      </div>
    </nav>

    <!-- Edit Meal Modal -->
    <div id="modalBackdrop" class="fixed inset-0 bg-black/40 hidden items-end justify-center p-4">
      <div class="w-full max-w-md rounded-3xl bg-white p-4 border border-[#e8e0d0] shadow-lg">
        <div class="flex items-center justify-between">
          <div class="font-semibold">âœï¸ ä¿®æ”¹é¤é»</div>
          <button id="btnCloseModal" class="px-3 py-2 rounded-xl border border-[#d9d2c2] bg-white">é—œé–‰</button>
        </div>
        <div class="mt-3 space-y-2">
          <div>
            <div class="text-sm opacity-80 mb-1">åç¨±</div>
            <input id="editName" class="w-full px-3 py-3 rounded-2xl bg-[#fbf7ef] border border-[#e8e0d0]" />
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <div class="text-sm opacity-80 mb-1">ç†±é‡ kcal</div>
              <input id="editKcal" type="number" step="1" class="w-full px-3 py-3 rounded-2xl bg-[#fbf7ef] border border-[#e8e0d0]" />
            </div>
            <div>
              <div class="text-sm opacity-80 mb-1">è›‹ç™½ P</div>
              <input id="editP" type="number" step="1" class="w-full px-3 py-3 rounded-2xl bg-[#fbf7ef] border border-[#e8e0d0]" />
            </div>
            <div>
              <div class="text-sm opacity-80 mb-1">ç¢³æ°´ C</div>
              <input id="editC" type="number" step="1" class="w-full px-3 py-3 rounded-2xl bg-[#fbf7ef] border border-[#e8e0d0]" />
            </div>
            <div>
              <div class="text-sm opacity-80 mb-1">è„‚è‚ª F</div>
              <input id="editF" type="number" step="1" class="w-full px-3 py-3 rounded-2xl bg-[#fbf7ef] border border-[#e8e0d0]" />
            </div>
          </div>
          <div class="flex items-center gap-2">
            <input id="editAlsoPreset" type="checkbox" class="w-5 h-5" />
            <label for="editAlsoPreset" class="text-sm">åŒæ™‚å­˜ç‚ºå¸¸ç”¨é¤é»</label>
          </div>
          <button id="btnSaveMealEdit" class="w-full px-4 py-3 rounded-2xl bg-[#3f4a2a] text-white font-semibold shadow-sm active:scale-[0.98]">å„²å­˜</button>
        </div>
        <div class="text-xs opacity-60 mt-2">å„²å­˜å¾Œæœƒç«‹å³å¯«å…¥ Firestoreï¼Œè·¨è£ç½®åŒæ­¥ã€‚</div>
      </div>
    </div>

  </div>

<script>
/** =========================
 *  Basic utilities
 *  ========================= */
const APP_VERSION = "FIX6-R1";
const MEAL_LABEL = { breakfast: "æ—©é¤", lunch: "åˆé¤", dinner: "æ™šé¤", snack: "é»å¿ƒ" };

const DEFAULT_DAY = {
  water: 0,
  steps: 0,
  weight: null,
  fatigue: null,
  sleepHours: null,
  strengthText: "",
  cardioText: "",
  calorieTarget: 1800,
  macroTarget: { p: 90, c: 200, f: 70 },
  meals: { breakfast: [], lunch: [], dinner: [], snack: [] },
  updatedAt: null
};

function pad2(n){ return String(n).padStart(2,"0"); }
function fmtDate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function parseDateStr(s){
  const [y,m,d]=s.split("-").map(Number);
  return new Date(y, (m||1)-1, d||1);
}
function clampNum(v, fallback=0){
  const n = Number(v);
  return Number.isFinite(n) ? n : fallback;
}
function safeText(v){
  return (v ?? "").toString().replace(/[\u0000-\u001f]/g,"").trim();
}
function uid(){
  return "m_" + Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(2,7);
}
function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
}
function toCsv(rows){
  const esc = (s) => {
    const t = (s ?? "").toString();
    if (/[",\n]/.test(t)) return `"${t.replace(/"/g,'""')}"`;
    return t;
  };
  const header = Object.keys(rows[0]||{});
  const lines = [header.map(esc).join(",")];
  for (const r of rows){
    lines.push(header.map(k => esc(r[k])).join(","));
  }
  return lines.join("\n");
}

/** =========================
 *  Firebase setup
 *  ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyD6FsP4PtdeeD_uuIRnWbbLzsKwHlgS9cM",
  authDomain: "health-tracker-b37e4.firebaseapp.com",
  projectId: "health-tracker-b37e4",
  storageBucket: "health-tracker-b37e4.firebasestorage.app",
  messagingSenderId: "802888614022",
  appId: "1:802888614022:web:e7ec85eef3dfc088aed107"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/** =========================
 *  App state
 *  ========================= */
let syncId = localStorage.getItem("health_sync_id") || "";
let apiKey = localStorage.getItem("gemini_api_key") || "";
let selectedDate = fmtDate(new Date());
let activePage = "overview";
let activeMealType = "breakfast";

let dayData = structuredClone(DEFAULT_DAY);
let presets = []; // [{id,name,calories,protein,carbs,fat,raw?}]
let unsubDay = null;
let unsubPresets = null;

/** =========================
 *  Firestore path helpers
 *  ========================= */
function userDoc(){ return db.collection("users").doc(syncId); }
function dayDoc(dateStr){ return userDoc().collection("days").doc(dateStr); }
function presetsDoc(){ return userDoc().collection("meta").doc("presets"); }

async function ensureSyncId(){
  if (syncId && safeText(syncId).length >= 6) return;
  syncId = "MF" + Math.random().toString(36).slice(2, 10) + Math.random().toString(36).slice(2, 6);
  localStorage.setItem("health_sync_id", syncId);
}

function setSyncId(newId){
  const id = safeText(newId);
  if (id.length < 6) { alert("åŒæ­¥ä»£è™Ÿå¤ªçŸ­"); return; }
  syncId = id;
  localStorage.setItem("health_sync_id", syncId);
  attachListeners();
  renderAll();
}

/** =========================
 *  Attach listeners
 *  ========================= */
function attachListeners(){
  if (!syncId) return;
  if (unsubDay) { unsubDay(); unsubDay=null; }
  if (unsubPresets) { unsubPresets(); unsubPresets=null; }

  unsubDay = dayDoc(selectedDate).onSnapshot((snap)=>{
    if (snap.exists){
      const d = snap.data() || {};
      // merge with DEFAULT_DAY to avoid missing fields
      dayData = {
        ...structuredClone(DEFAULT_DAY),
        ...d,
        macroTarget: { ...DEFAULT_DAY.macroTarget, ...(d.macroTarget||{}) },
        meals: { ...structuredClone(DEFAULT_DAY.meals), ...(d.meals||{}) },
      };
    } else {
      dayData = structuredClone(DEFAULT_DAY);
    }
    renderAll();
  }, (err)=>{
    console.error("day onSnapshot error", err);
    alert("åŒæ­¥å¤±æ•—ï¼šè«‹æª¢æŸ¥ Firestore è¦å‰‡æˆ–ç¶²è·¯ã€‚\n" + (err?.message||""));
  });

  unsubPresets = presetsDoc().onSnapshot((snap)=>{
    const d = snap.data() || {};
    presets = Array.isArray(d.items) ? d.items : [];
    renderPresets();
  }, (err)=>{
    console.error("preset onSnapshot error", err);
  });
}

/** =========================
 *  Data mutations
 *  ========================= */
async function writeMerge(dateStr, patch){
  if (!syncId) return;
  patch = { ...patch, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
  await dayDoc(dateStr).set(patch, { merge: true });
}

async function incrementField(field, delta){
  const f = safeText(field);
  const v = clampNum(delta, 0);
  // optimistic UI
  dayData = { ...dayData, [f]: clampNum(dayData[f], 0) + v };
  renderAll();
  try{
    await writeMerge(selectedDate, { [f]: firebase.firestore.FieldValue.increment(v) });
  } catch(err){
    console.error("incrementField error", err);
    alert("å¯«å…¥å¤±æ•—ï¼š" + (err?.message||""));
  }
}

async function addMeal(mealType, meal){
  const mt = mealType;
  const item = { ...meal, id: uid(), createdAt: Date.now() };
  // optimistic
  const nextMeals = structuredClone(dayData.meals||structuredClone(DEFAULT_DAY.meals));
  nextMeals[mt] = [...(nextMeals[mt]||[]), item];
  dayData = { ...dayData, meals: nextMeals };
  renderAll();

  try{
    await dayDoc(selectedDate).set({
      ["meals."+mt]: firebase.firestore.FieldValue.arrayUnion(item),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
  } catch(err){
    console.error("addMeal error", err);
    alert("æ–°å¢å¤±æ•—ï¼š" + (err?.message||""));
  }
}

async function deleteMeal(mealType, mealId){
  const mt = mealType;
  const cur = (dayData.meals?.[mt]||[]);
  const target = cur.find(x => x.id === mealId);
  if (!target) return;
  // optimistic
  const nextMeals = structuredClone(dayData.meals||structuredClone(DEFAULT_DAY.meals));
  nextMeals[mt] = cur.filter(x => x.id !== mealId);
  dayData = { ...dayData, meals: nextMeals };
  renderAll();

  try{
    // We cannot arrayRemove by partial if object changed; remove exact snapshot.
    await dayDoc(selectedDate).set({
      ["meals."+mt]: firebase.firestore.FieldValue.arrayRemove(target),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
  } catch(err){
    console.error("deleteMeal error", err);
    alert("åˆªé™¤å¤±æ•—ï¼š" + (err?.message||""));
  }
}

async function updateMeal(mealType, mealId, patch){
  const mt = mealType;
  const patchClean = {
    name: safeText(patch.name),
    calories: clampNum(patch.calories, 0),
    protein: clampNum(patch.protein, 0),
    carbs: clampNum(patch.carbs, 0),
    fat: clampNum(patch.fat, 0),
    updatedAt: Date.now()
  };

  // optimistic local update
  const cur = (dayData.meals?.[mt]||[]);
  const nextMeals = structuredClone(dayData.meals||structuredClone(DEFAULT_DAY.meals));
  nextMeals[mt] = cur.map(m => m.id === mealId ? ({...m, ...patchClean}) : m);
  dayData = { ...dayData, meals: nextMeals };
  renderAll();

  // Use compat transaction to avoid modular/compat mismatch (é€™æ˜¯ FIX6 åŸæœ¬é‰›ç­†ä¸æ›´æ–°çš„ä¸»å› )
  try{
    const ref = dayDoc(selectedDate);
    await ref.runTransaction(async (tx)=>{
      const snap = await tx.get(ref);
      const data = snap.exists ? (snap.data()||{}) : {};
      const meals = { ...structuredClone(DEFAULT_DAY.meals), ...(data.meals||{}) };
      const arr = Array.isArray(meals[mt]) ? meals[mt] : [];
      meals[mt] = arr.map(m => m.id === mealId ? ({...m, ...patchClean}) : m);
      tx.set(ref, { meals, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
    });
  } catch(err){
    console.error("updateMeal error", err);
    alert("æ›´æ–°å¤±æ•—ï¼š" + (err?.message||""));
  }
}

/** =========================
 *  Presets
 *  ========================= */
function isPresetByName(name){
  const n = safeText(name).toLowerCase();
  return presets.some(p => safeText(p.name).toLowerCase() === n);
}

async function savePresetFromMeal(meal){
  const clean = {
    id: meal.id || uid(),
    name: safeText(meal.name),
    calories: clampNum(meal.calories, 0),
    protein: clampNum(meal.protein, 0),
    carbs: clampNum(meal.carbs, 0),
    fat: clampNum(meal.fat, 0),
    raw: safeText(meal.raw || "")
  };
  if (!clean.name) { alert("é¤é»åç¨±ä¸å¯ç©º"); return; }
  if (isPresetByName(clean.name)) { alert("å¸¸ç”¨é¤é»å·²å­˜åœ¨ï¼ˆåŒåï¼‰"); return; }

  const next = [...presets, clean].slice(-200);
  presets = next;
  renderPresets();

  try{
    await presetsDoc().set({
      items: next,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
  } catch(err){
    console.error("savePreset error", err);
    alert("å­˜å¸¸ç”¨å¤±æ•—ï¼š" + (err?.message||""));
  }
}

async function addPresetToMealType(presetId, mealType){
  const p = presets.find(x => x.id === presetId);
  if (!p) return;
  await addMeal(mealType, { ...p, raw: p.raw || p.name });
}

/** =========================
 *  Gemini AI (JSON Mode)
 *  ========================= */
const GEMINI_API_BASE = "https://generativelanguage.googleapis.com";
const GEMINI_API_VERSION = "v1beta"; // keep compatible for most keys
const GEMINI_MODEL = "gemini-1.5-flash";

function buildGeminiPrompt(userText){
  const text = safeText(userText);
  return [
    "ä½ æ˜¯ä¸€ä½ç‡Ÿé¤Šå¸«ï¼Œè«‹æ ¹æ“šä½¿ç”¨è€…çš„é¤é»æè¿°ï¼Œä¼°ç®—æ•´ä»½é¤é»çš„ç†±é‡èˆ‡ä¸‰å¤§ç‡Ÿé¤Šç´ ã€‚",
    "è«‹åªå›å‚³ JSONï¼ˆä¸è¦ Markdownã€ä¸è¦ ```ï¼‰ã€‚",
    "JSON Schemaï¼š",
    "{",
    '  "name": "string",',
    '  "calories": number,',
    '  "protein": number,',
    '  "carbs": number,',
    '  "fat": number',
    "}",
    "é¤é»æè¿°ï¼š" + text
  ].join("\n");
}

function safeParseJsonFromText(raw){
  const t = safeText(raw);
  if (!t) return null;
  // try direct
  try { return JSON.parse(t); } catch(e){}
  // strip markdown fences
  const noFence = t.replace(/```json\s*/gi,"").replace(/```/g,"").trim();
  try { return JSON.parse(noFence); } catch(e){}
  // try find first { ... } block
  const m = noFence.match(/\{[\s\S]*\}/);
  if (m){
    try { return JSON.parse(m[0]); } catch(e){}
  }
  return null;
}

async function estimateWithGemini(foodText){
  if (!apiKey) throw new Error("NO_API_KEY");
  const endpoint = `${GEMINI_API_BASE}/${GEMINI_API_VERSION}/models/${GEMINI_MODEL}:generateContent?key=${encodeURIComponent(apiKey)}`;
  const prompt = buildGeminiPrompt(foodText);

  const body = {
    contents: [{ parts: [{ text: prompt }] }],
    generationConfig: {
      temperature: 0.1,
      responseMimeType: "application/json",
      // Some SDKs/versions use snake_case; sending both is safe (unknown fields are ignored)
      response_mime_type: "application/json"
    }
  };

  const res = await fetch(endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  if (!res.ok){
    const err = await res.text().catch(()=> "");
    throw new Error(`GEMINI_HTTP_${res.status}: ${err.slice(0,200)}`);
  }

  const data = await res.json();
  const rawText = data?.candidates?.[0]?.content?.parts?.[0]?.text ?? "";
  const parsed = safeParseJsonFromText(rawText);
  if (!parsed) throw new Error("GEMINI_PARSE_FAIL");

  const out = {
    name: safeText(parsed.name) || safeText(foodText),
    calories: clampNum(parsed.calories, 0),
    protein: clampNum(parsed.protein, 0),
    carbs: clampNum(parsed.carbs, 0),
    fat: clampNum(parsed.fat, 0),
    raw: safeText(foodText),
    ai: true
  };
  return out;
}

function estimateFallback(foodText){
  // Minimal fallback: keep name, 0 macros. (User will edit and can save as preset)
  return { name: safeText(foodText), calories: 0, protein: 0, carbs: 0, fat: 0, raw: safeText(foodText), ai: false };
}

/** =========================
 *  Coach report
 *  ========================= */
function sumMeals(meals){
  let kcal=0,p=0,c=0,f=0;
  for (const mt of Object.keys(MEAL_LABEL)){
    for (const m of (meals?.[mt]||[])){
      kcal += clampNum(m.calories,0);
      p += clampNum(m.protein,0);
      c += clampNum(m.carbs,0);
      f += clampNum(m.fat,0);
    }
  }
  return {kcal,p,c,f};
}

function linesForMeals(meals){
  const out=[];
  for (const mt of Object.keys(MEAL_LABEL)){
    const arr=(meals?.[mt]||[]);
    if (!arr.length) continue;
    const names = arr.map(x=>safeText(x.raw||x.name)).filter(Boolean).join("ã€");
    out.push(`${MEAL_LABEL[mt]}ï¼š${names}`);
  }
  return out.length ? out.join("\n") : "ï¼ˆå°šç„¡ç´€éŒ„ï¼‰";
}

async function buildCoachText(){
  const recordDate = selectedDate;
  const today = dayData;
  // previous day
  const prevDateObj = parseDateStr(recordDate);
  prevDateObj.setDate(prevDateObj.getDate() - 1);
  const prevDate = fmtDate(prevDateObj);

  let prev = structuredClone(DEFAULT_DAY);
  try{
    const snap = await dayDoc(prevDate).get();
    if (snap.exists){
      const d=snap.data()||{};
      prev = {
        ...structuredClone(DEFAULT_DAY),
        ...d,
        macroTarget: { ...DEFAULT_DAY.macroTarget, ...(d.macroTarget||{}) },
        meals: { ...structuredClone(DEFAULT_DAY.meals), ...(d.meals||{}) },
      };
    }
  } catch(e){
    // ignore
  }

  const prevSums = sumMeals(prev.meals);

  return [
    `âœ… è¨˜éŒ„æ—¥æœŸï¼š${recordDate.replaceAll("-","/")}`,
    `âœ… ä»Šæ—¥ç©ºè…¹é«”é‡ï¼š${today.weight ?? "-"}`,
    `âœ… ä»Šæ—¥æ—©èµ·ç–²å‹åº¦ï¼š${today.fatigue ?? "-"}/10`,
    `âœ… å‰ä¸€æ—¥ç¡çœ æ™‚é•·ï¼š${today.sleepHours ?? "-"} hrs`,
    `âœ… å‰ä¸€æ—¥å–æ°´é‡ï¼š${clampNum(prev.water,0)} ml`,
    `âœ… å‰ä¸€æ—¥èµ°è·¯æ­¥æ•¸ï¼š${clampNum(prev.steps,0)} æ­¥`,
    `âœ… å‰ä¸€æ—¥æœ‰æ°§æ™‚é•·ï¼š${safeText(prev.cardioText)||"-"}`,
    `âœ… å‰ä¸€æ—¥ç†±é‡æ”å–ï¼š${Math.round(prevSums.kcal)} kcal`,
    ``,
    `ğŸ½ é£²é£Ÿè¨˜éŒ„ï¼š`,
    linesForMeals(prev.meals),
    ``,
    `ğŸ¯ å‰ä¸€æ—¥é‹å‹•é …ç›®ï¼š`,
    safeText(prev.strengthText) || "ï¼ˆæœªå¡«ï¼‰"
  ].join("\n");
}

/** =========================
 *  Rendering
 *  ========================= */
function setActivePage(page){
  activePage = page;
  document.querySelectorAll("[id^='page-']").forEach(el => el.classList.add("hidden"));
  document.getElementById("page-" + page).classList.remove("hidden");
  document.querySelectorAll(".navBtn").forEach(b=>{
    const on = b.dataset.page === page;
    b.classList.toggle("bg-white", on);
    b.classList.toggle("border", on);
    b.classList.toggle("border-[#d9d2c2]", on);
    b.classList.toggle("shadow-sm", on);
  });
}

function setActiveMealType(mt){
  activeMealType = mt;
  document.querySelectorAll(".mealTab").forEach(btn=>{
    const on = btn.dataset.meal === mt;
    btn.classList.toggle("bg-[#3f4a2a]", on);
    btn.classList.toggle("text-white", on);
    btn.classList.toggle("border-[#3f4a2a]", on);
  });
  renderMealList();
}

function renderPresets(){
  const sel = document.getElementById("presetSelect");
  const cur = sel.value;
  sel.innerHTML = `<option value="">ï¼ˆå¸¸ç”¨é¤é»ï¼šé¸æ“‡å¯ç›´æ¥åŠ å…¥ï¼‰</option>` + presets
    .slice().reverse()
    .map(p => `<option value="${p.id}">${safeText(p.name)} Â· ${clampNum(p.calories,0)}kcal (P${clampNum(p.protein,0)} C${clampNum(p.carbs,0)} F${clampNum(p.fat,0)})</option>`)
    .join("");
  // try keep selection
  if ([...sel.options].some(o=>o.value===cur)) sel.value=cur;
}

function renderMealList(){
  const wrap = document.getElementById("mealList");
  const arr = (dayData.meals?.[activeMealType]||[]);
  if (!arr.length){
    wrap.innerHTML = `<div class="text-center py-6 text-sm opacity-60">ï¼ˆå°šç„¡ç´€éŒ„ï¼‰</div>`;
    return;
  }
  wrap.innerHTML = arr.map(m=>{
    const name = safeText(m.name);
    const kcal = Math.round(clampNum(m.calories,0));
    const p = Math.round(clampNum(m.protein,0));
    const c = Math.round(clampNum(m.carbs,0));
    const f = Math.round(clampNum(m.fat,0));
    const isZero = (kcal===0 && p===0 && c===0 && f===0);
    return `
      <div class="rounded-2xl bg-white border border-[#efe7d8] p-4 shadow-sm">
        <div class="flex items-center justify-between gap-2">
          <div class="font-semibold">${name || "ï¼ˆæœªå‘½åï¼‰"}</div>
          <div class="flex items-center gap-2">
            <button class="btnEdit px-2 py-1 rounded-xl border border-[#d9d2c2] bg-white" data-id="${m.id}">âœï¸</button>
            <button class="btnStar px-2 py-1 rounded-xl border border-[#d9d2c2] bg-white" data-id="${m.id}" title="å­˜ç‚ºå¸¸ç”¨">â˜†</button>
            <button class="btnDel px-2 py-1 rounded-xl border border-[#ffd2d2] bg-white text-[#c62828]" data-id="${m.id}">ğŸ—‘ï¸</button>
          </div>
        </div>
        <div class="text-sm opacity-80 mt-1">${kcal} kcal (P${p} C${c} F${f}) ${isZero ? '<span class="text-[#c62828] font-semibold">â†å»ºè­°ä¿®æ”¹</span>' : ''}</div>
        ${safeText(m.raw) ? `<div class="text-xs opacity-60 mt-1">å…§å®¹ï¼š${safeText(m.raw)}</div>` : ""}
      </div>
    `;
  }).join("");

  wrap.querySelectorAll(".btnDel").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.id;
      if (confirm("åˆªé™¤é€™ç­†ï¼Ÿ")) deleteMeal(activeMealType, id);
    });
  });
  wrap.querySelectorAll(".btnEdit").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.id;
      openEditModal(activeMealType, id);
    });
  });
  wrap.querySelectorAll(".btnStar").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.id;
      const item = (dayData.meals?.[activeMealType]||[]).find(x=>x.id===id);
      if (item) savePresetFromMeal(item);
    });
  });
}

function renderHistory(){
  const box = document.getElementById("historyList");
  const base = parseDateStr(selectedDate);
  const dates = [];
  for (let i=0;i<14;i++){
    const d = new Date(base);
    d.setDate(d.getDate()-i);
    dates.push(fmtDate(d));
  }
  box.innerHTML = dates.map(d=>`
    <button class="histRow w-full text-left px-3 py-3 rounded-2xl border border-[#efe7d8] bg-white active:scale-[0.99]" data-date="${d}">
      <div class="flex items-center justify-between">
        <div class="font-mono">${d}</div>
        <div class="text-xs opacity-70">é»æˆ‘åˆ‡æ›</div>
      </div>
      <div class="text-xs opacity-70 mt-1" id="hist-${d}">è¼‰å…¥ä¸­...</div>
    </button>
  `).join("");

  box.querySelectorAll(".histRow").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      selectedDate = btn.dataset.date;
      attachListeners();
      renderAll();
      setActivePage("overview");
    });
  });

  // load summaries
  for (const d of dates){
    dayDoc(d).get().then(snap=>{
      let t = "ï¼ˆç„¡è³‡æ–™ï¼‰";
      if (snap.exists){
        const dd = snap.data()||{};
        const sums = sumMeals(dd.meals||{});
        t = `æ”å– ${Math.round(sums.kcal)} kcal Â· æ°´ ${clampNum(dd.water,0)} Â· æ­¥ ${clampNum(dd.steps,0)}`;
      }
      const el = document.getElementById("hist-"+d);
      if (el) el.textContent = t;
    }).catch(()=>{});
  }
}

async function renderCoach(){
  const el = document.getElementById("coachText");
  el.textContent = "ç”¢ç”Ÿä¸­...";
  try{
    const t = await buildCoachText();
    el.textContent = t;
  } catch(e){
    el.textContent = "ï¼ˆç”¢ç”Ÿå¤±æ•—ï¼‰";
  }
}

function renderOverviewNumbers(){
  const sums = sumMeals(dayData.meals);
  const target = clampNum(dayData.calorieTarget, DEFAULT_DAY.calorieTarget);
  const remaining = Math.max(0, Math.round(target - sums.kcal));

  document.getElementById("kcalRemaining").textContent = remaining;
  document.getElementById("kcalTaken").textContent = Math.round(sums.kcal);
  document.getElementById("kcalTarget").textContent = target;

  document.getElementById("pTaken").textContent = Math.round(sums.p);
  document.getElementById("cTaken").textContent = Math.round(sums.c);
  document.getElementById("fTaken").textContent = Math.round(sums.f);

  const mt = dayData.macroTarget || DEFAULT_DAY.macroTarget;
  document.getElementById("pTarget").textContent = clampNum(mt.p, 90);
  document.getElementById("cTarget").textContent = clampNum(mt.c, 200);
  document.getElementById("fTarget").textContent = clampNum(mt.f, 70);

  document.getElementById("waterNow").textContent = clampNum(dayData.water,0);
  document.getElementById("stepsNow").textContent = clampNum(dayData.steps,0);
}

function renderSettings(){
  document.getElementById("syncIdText").textContent = syncId || "-";
  document.getElementById("syncIdBox").textContent = syncId || "-";
  document.getElementById("apiKeyInput").value = apiKey || "";
  document.getElementById("aiStatus").textContent = apiKey ? "AI ç‹€æ…‹ï¼šå·²è¨­å®šï¼ˆå»ºè­°ç”¨ JSON Modeï¼‰" : "AI ç‹€æ…‹ï¼šæœªè¨­å®š";
}

function renderDateHeader(){
  document.getElementById("dateText").textContent = selectedDate;
}

function renderLogInputs(){
  document.getElementById("strengthInput").value = safeText(dayData.strengthText);
  document.getElementById("cardioInput").value = safeText(dayData.cardioText);
  document.getElementById("weightInput").value = (dayData.weight ?? "");
  document.getElementById("fatigueInput").value = (dayData.fatigue ?? "");
  document.getElementById("sleepInput").value = (dayData.sleepHours ?? "");
}

function renderAll(){
  document.getElementById("verTag").textContent = APP_VERSION;
  document.getElementById("syncIdText").textContent = syncId || "-";
  renderDateHeader();
  renderOverviewNumbers();
  renderMealList();
  renderLogInputs();
  renderSettings();
  renderPresets();
  renderCoach();
}

/** =========================
 *  Modal
 *  ========================= */
let editing = { mealType: null, id: null };

function openEditModal(mealType, mealId){
  const item = (dayData.meals?.[mealType]||[]).find(x=>x.id===mealId);
  if (!item) return;
  editing = { mealType, id: mealId };

  document.getElementById("editName").value = safeText(item.name);
  document.getElementById("editKcal").value = clampNum(item.calories,0);
  document.getElementById("editP").value = clampNum(item.protein,0);
  document.getElementById("editC").value = clampNum(item.carbs,0);
  document.getElementById("editF").value = clampNum(item.fat,0);
  document.getElementById("editAlsoPreset").checked = false;

  document.getElementById("modalBackdrop").classList.remove("hidden");
  document.getElementById("modalBackdrop").classList.add("flex");
}

function closeEditModal(){
  document.getElementById("modalBackdrop").classList.add("hidden");
  document.getElementById("modalBackdrop").classList.remove("flex");
  editing = { mealType: null, id: null };
}

/** =========================
 *  Events
 *  ========================= */
document.getElementById("btnPrevDay").addEventListener("click", ()=>{
  const d = parseDateStr(selectedDate);
  d.setDate(d.getDate()-1);
  selectedDate = fmtDate(d);
  attachListeners();
  renderAll();
});
document.getElementById("btnNextDay").addEventListener("click", ()=>{
  const d = parseDateStr(selectedDate);
  d.setDate(d.getDate()+1);
  selectedDate = fmtDate(d);
  attachListeners();
  renderAll();
});

document.getElementById("btnWaterAdd").addEventListener("click", ()=>incrementField("water", 250));
document.getElementById("btnStepsAdd").addEventListener("click", ()=>incrementField("steps", 500));

document.querySelectorAll(".navBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const p = btn.dataset.page;
    setActivePage(p);
    if (p === "history") renderHistory();
  });
});

document.querySelectorAll(".mealTab").forEach(btn=>{
  btn.addEventListener("click", ()=>setActiveMealType(btn.dataset.meal));
});

document.getElementById("btnAddPreset").addEventListener("click", ()=>{
  const id = document.getElementById("presetSelect").value;
  if (!id) return;
  addPresetToMealType(id, activeMealType);
});

let manualMode = false;
document.getElementById("btnManualAddToggle").addEventListener("click", ()=>{
  manualMode = !manualMode;
  document.getElementById("btnManualAddToggle").textContent = manualMode ? "æ‰‹å‹•âœ“" : "æ‰‹å‹•";
});

document.getElementById("btnAddFood").addEventListener("click", async ()=>{
  const input = safeText(document.getElementById("foodInput").value);
  if (!input) return;
  document.getElementById("foodInput").value = "";

  let meal = null;
  if (manualMode || !apiKey){
    meal = estimateFallback(input);
  } else {
    try{
      meal = await estimateWithGemini(input);
    } catch(e){
      console.warn("Gemini fail => fallback", e);
      alert("AI åˆ†æå¤±æ•—ï¼šAI å›å‚³æ ¼å¼ç•°å¸¸æˆ– API å¤±æ•—ã€‚\nå·²æ”¹ç”¨ 0 ä¼°ç®—åŠ å…¥ï¼Œè«‹ç”¨ âœï¸ ä¿®æ­£å¾Œå¯å­˜ç‚ºå¸¸ç”¨é¤é»ã€‚");
      meal = estimateFallback(input);
    }
  }
  await addMeal(activeMealType, meal);
});

document.getElementById("btnSaveWorkout").addEventListener("click", async ()=>{
  const strengthText = safeText(document.getElementById("strengthInput").value);
  const cardioText = safeText(document.getElementById("cardioInput").value);
  dayData = { ...dayData, strengthText, cardioText };
  renderAll();
  try{
    await writeMerge(selectedDate, { strengthText, cardioText });
    alert("å·²å„²å­˜é‹å‹•");
  } catch(e){
    alert("å„²å­˜å¤±æ•—");
  }
});

document.getElementById("btnSaveVitals").addEventListener("click", async ()=>{
  const weight = safeText(document.getElementById("weightInput").value);
  const fatigue = safeText(document.getElementById("fatigueInput").value);
  const sleepHours = safeText(document.getElementById("sleepInput").value);

  const patch = {
    weight: weight === "" ? null : clampNum(weight, null),
    fatigue: fatigue === "" ? null : clampNum(fatigue, null),
    sleepHours: sleepHours === "" ? null : clampNum(sleepHours, null),
  };
  dayData = { ...dayData, ...patch };
  renderAll();
  try{
    await writeMerge(selectedDate, patch);
    alert("å·²å„²å­˜ç‹€æ…‹");
  } catch(e){
    alert("å„²å­˜å¤±æ•—");
  }
});

document.getElementById("btnCopyCoach").addEventListener("click", async ()=>{
  try{
    const text = document.getElementById("coachText").textContent;
    await navigator.clipboard.writeText(text);
    alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿");
  } catch(e){
    alert("è¤‡è£½å¤±æ•—ï¼ˆå¯èƒ½ç€è¦½å™¨é™åˆ¶ï¼‰");
  }
});

document.getElementById("btnCloseModal").addEventListener("click", closeEditModal);
document.getElementById("modalBackdrop").addEventListener("click", (e)=>{
  if (e.target.id === "modalBackdrop") closeEditModal();
});

document.getElementById("btnSaveMealEdit").addEventListener("click", async ()=>{
  const name = safeText(document.getElementById("editName").value);
  const calories = clampNum(document.getElementById("editKcal").value, 0);
  const protein = clampNum(document.getElementById("editP").value, 0);
  const carbs = clampNum(document.getElementById("editC").value, 0);
  const fat = clampNum(document.getElementById("editF").value, 0);
  const alsoPreset = document.getElementById("editAlsoPreset").checked;

  const mt = editing.mealType;
  const id = editing.id;
  if (!mt || !id) return;

  await updateMeal(mt, id, { name, calories, protein, carbs, fat });

  if (alsoPreset){
    const updated = (dayData.meals?.[mt]||[]).find(x=>x.id===id);
    if (updated) await savePresetFromMeal(updated);
  }
  closeEditModal();
});

document.getElementById("btnSaveApiKey").addEventListener("click", ()=>{
  apiKey = safeText(document.getElementById("apiKeyInput").value);
  localStorage.setItem("gemini_api_key", apiKey);
  renderSettings();
  alert("å·²å„²å­˜ API Key");
});

document.getElementById("btnUseSyncId").addEventListener("click", ()=>{
  const v = safeText(document.getElementById("syncIdInput").value);
  if (v) setSyncId(v);
});
document.getElementById("btnNewSyncId").addEventListener("click", ()=>{
  if (!confirm("é‡æ–°ç”¢ç”Ÿæ–°ä»£è™Ÿå¾Œï¼Œæœƒåˆ‡åˆ°æ–°çš„è³‡æ–™åº«è·¯å¾‘ã€‚ç¢ºå®šï¼Ÿ")) return;
  localStorage.removeItem("health_sync_id");
  syncId = "";
  init();
});

document.getElementById("btnExportCsvToday").addEventListener("click", async ()=>{
  const d = selectedDate;
  const snap = await dayDoc(d).get();
  if (!snap.exists) { alert("é€™å¤©æ²’æœ‰è³‡æ–™"); return; }
  const dd = snap.data()||{};
  const rows=[];
  const meals = dd.meals||{};
  for (const mt of Object.keys(MEAL_LABEL)){
    for (const m of (meals[mt]||[])){
      rows.push({
        date: d,
        meal_type: mt,
        meal_name: safeText(m.name),
        raw: safeText(m.raw),
        calories: clampNum(m.calories,0),
        protein: clampNum(m.protein,0),
        carbs: clampNum(m.carbs,0),
        fat: clampNum(m.fat,0),
        water: clampNum(dd.water,0),
        steps: clampNum(dd.steps,0),
        weight: dd.weight ?? "",
        fatigue: dd.fatigue ?? "",
        sleepHours: dd.sleepHours ?? "",
        strengthText: safeText(dd.strengthText),
        cardioText: safeText(dd.cardioText),
      });
    }
  }
  if (!rows.length){
    rows.push({date:d, meal_type:"", meal_name:"", raw:"", calories:"", protein:"", carbs:"", fat:"", water: clampNum(dd.water,0), steps: clampNum(dd.steps,0), weight: dd.weight ?? "", fatigue: dd.fatigue ?? "", sleepHours: dd.sleepHours ?? "", strengthText: safeText(dd.strengthText), cardioText: safeText(dd.cardioText)});
  }
  downloadText(`healthlog_${d}.csv`, toCsv(rows));
});

document.getElementById("btnExportCsv").addEventListener("click", async ()=>{
  const daysSnap = await userDoc().collection("days").get();
  const rows=[];
  daysSnap.forEach(doc=>{
    const d = doc.id;
    const dd = doc.data()||{};
    const meals = dd.meals||{};
    let has=false;
    for (const mt of Object.keys(MEAL_LABEL)){
      for (const m of (meals[mt]||[])){
        has=true;
        rows.push({
          date: d,
          meal_type: mt,
          meal_name: safeText(m.name),
          raw: safeText(m.raw),
          calories: clampNum(m.calories,0),
          protein: clampNum(m.protein,0),
          carbs: clampNum(m.carbs,0),
          fat: clampNum(m.fat,0),
          water: clampNum(dd.water,0),
          steps: clampNum(dd.steps,0),
          weight: dd.weight ?? "",
          fatigue: dd.fatigue ?? "",
          sleepHours: dd.sleepHours ?? "",
          strengthText: safeText(dd.strengthText),
          cardioText: safeText(dd.cardioText),
        });
      }
    }
    if (!has){
      rows.push({date:d, meal_type:"", meal_name:"", raw:"", calories:"", protein:"", carbs:"", fat:"", water: clampNum(dd.water,0), steps: clampNum(dd.steps,0), weight: dd.weight ?? "", fatigue: dd.fatigue ?? "", sleepHours: dd.sleepHours ?? "", strengthText: safeText(dd.strengthText), cardioText: safeText(dd.cardioText)});
    }
  });
  if (!rows.length){ alert("æ²’æœ‰ä»»ä½•è³‡æ–™"); return; }
  downloadText(`healthlog_all.csv`, toCsv(rows));
});

/** =========================
 *  Init
 *  ========================= */
async function init(){
  document.getElementById("verTag").textContent = APP_VERSION;
  await ensureSyncId();
  apiKey = apiKey || localStorage.getItem("gemini_api_key") || "";
  document.getElementById("syncIdText").textContent = syncId;
  document.getElementById("syncIdBox").textContent = syncId;
  attachListeners();
  setActivePage("overview");
  setActiveMealType("breakfast");
  renderAll();
}
init();
</script>
</body>
</html>
