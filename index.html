<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nicole 2026 ç¾å¤¢æˆçœŸè¨ˆç•« v3.2 (AI Fixed)</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ¿</text></svg>">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4322/4322991.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#FFFBF5">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bgMain: '#FFFBF5', cardBg: '#FFFFFF', primary: '#4A5D23', secondary: '#6B5E52',
                        inputBg: '#F5F2EB', borderBeige: '#E8E4D9', activeTab: '#4A5D23', inactiveTab: '#A8A29E'
                    },
                    borderRadius: { 'xl': '14px', '2xl': '20px' },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body { background-color: #FFFBF5; color: #4A5D23; font-family: system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        input, select, button, textarea, p, span, div { font-size: 18px; }
        h1 { font-size: 24px; } h2 { font-size: 22px; } h3 { font-size: 20px; }
        .big-num { font-size: 48px; font-weight: 800; line-height: 1; }
        .card-shadow { box-shadow: 0 4px 12px rgba(74, 93, 35, 0.08); }
        input:focus, textarea:focus { outline: 2px solid #4A5D23; background-color: #ffffff; }
        .markdown-body p { margin-bottom: 1em; line-height: 1.6; }
        .markdown-body ul { list-style: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; line-height: 1.5; margin-bottom: 8px; position: relative; word-wrap: break-word; }
        .chat-user { background-color: #4A5D23; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-ai { background-color: #F5F2EB; color: #4A5D23; align-self: flex-start; border-bottom-left-radius: 4px; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 50; display: flex; align-items: center; justify-content: center; }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        /* Hide scrollbar for IE, Edge and Firefox */
        .hide-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root">
        <div style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #4A5D23;">
            <div style="font-size: 40px; margin-bottom: 20px;" class="animate-bounce">ğŸŒ¿</div>
            <div>æ­£åœ¨å•Ÿå‹• Health Log...</div>
            <div id="error-msg" style="font-size: 12px; margin-top: 20px; color: red; max-width: 80%; text-align: center;"></div>
        </div>
    </div>

    <script>
        window.onerror = function(msg, url, line) {
            document.getElementById('error-msg').innerText = "ç³»çµ±éŒ¯èª¤: " + msg + " (Line: " + line + ")";
        };
    </script>

    <script type="text/babel">
        // --- Firebase è¨­å®š ---
        // è«‹ç¢ºä¿é€™è£¡çš„ config èˆ‡ä½ çš„ Firebase Console ä¸€è‡´
        const firebaseConfig = {
            apiKey: "AIzaSyD6FsP4PtdeeD_uuIRnWbbLzsKwHlgS9cM",
            authDomain: "health-tracker-b37e4.firebaseapp.com",
            projectId: "health-tracker-b37e4",
            storageBucket: "health-tracker-b37e4.firebasestorage.app",
            messagingSenderId: "802888614022",
            appId: "1:802888614022:web:e7ec85eef3dfc088aed107"
        };

        if (typeof firebase !== 'undefined' && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- React å…ƒä»¶ ---
        const { useState, useEffect, useMemo, useRef } = React;
        const Recharts = window.Recharts || {};
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = Recharts;

        // --- AI API æ ¸å¿ƒå‡½å¼ (å·²ä¿®å¾©) ---
        // ä½¿ç”¨æ›´ç©©å®šçš„æ¨¡å‹åç¨±ï¼Œä¸¦å¢åŠ éŒ¯èª¤è™•ç†
        const callGeminiAPI = async (apiKey, prompt, isJson = false) => {
            const models = ['gemini-1.5-flash', 'gemini-1.5-flash-latest', 'gemini-pro']; // å˜—è©¦é †åº
            let lastError = null;

            for (const model of models) {
                try {
                    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                    
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }]
                    };
                    
                    // åªæœ‰ Flash 1.5 æ”¯æ´ JSON mode åƒæ•¸ï¼ŒèˆŠæ¨¡å‹ä¸åŠ æ­¤åƒæ•¸ä»¥å…å ±éŒ¯
                    if (isJson && model.includes('1.5')) {
                        payload.generationConfig = { response_mime_type: "application/json" };
                    }

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errText = await response.text();
                        // å¦‚æœæ˜¯ 404 (Model not found) æˆ– 429 (Quota)ï¼Œå˜—è©¦ä¸‹ä¸€å€‹æ¨¡å‹
                        if (response.status === 404 || response.status === 429) {
                            console.warn(`Model ${model} failed (${response.status}), trying next...`);
                            lastError = new Error(`API Error ${response.status}: ${errText}`);
                            continue;
                        }
                        throw new Error(`API Error ${response.status}: ${errText}`);
                    }

                    const result = await response.json();
                    if (!result.candidates || !result.candidates[0].content) {
                        throw new Error("API å›å‚³æ ¼å¼ç•°å¸¸ï¼Œæ²’æœ‰ candidates");
                    }
                    return result.candidates[0].content.parts[0].text;
                } catch (e) {
                    lastError = e;
                    console.error(`Error with model ${model}:`, e);
                }
            }
            throw lastError || new Error("All models failed");
        };

        // --- å·¥å…·å‡½å¼ ---
        const getTodayString = () => {
            const d = new Date();
            const offset = d.getTimezoneOffset() * 60000;
            return new Date(d.getTime() - offset).toISOString().split('T')[0];
        };

        const shiftDate = (dateStr, days) => {
            const d = new Date(dateStr);
            d.setDate(d.getDate() + days);
            return d.toISOString().split('T')[0];
        };

        const MEAL_CATEGORIES = { 'breakfast': 'æ—©é¤', 'lunch': 'åˆé¤', 'dinner': 'æ™šé¤', 'snack': 'é»å¿ƒ' };

        const getDefaultMealCategory = () => {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 11) return 'breakfast';
            if (hour >= 11 && hour < 15) return 'lunch';
            if (hour >= 17 && hour < 21) return 'dinner';
            return 'snack';
        };

        const fallbackAnalysis = (text) => {
            let c=0, p=0, cb=0, f=0;
            const t = text.toLowerCase();
            // ç°¡å–®ä¼°ç®—é‚è¼¯
            if (t.includes('é›') || t.includes('è‚‰') || t.includes('é­š') || t.includes('ç‰›') || t.includes('è±¬')) { c+=200; p+=25; f+=10; }
            if (t.includes('é£¯') || t.includes('ç²¥') || t.includes('éºµ') || t.includes('ç²‰')) { c+=280; p+=4; cb+=60; }
            if (t.includes('èœ') || t.includes('è”¬') || t.includes('æ²™æ‹‰')) { c+=50; cb+=10; }
            if (t.includes('è›‹')) { c+=75; p+=7; f+=5; }
            if (t.includes('æœ') || t.includes('banana') || t.includes('apple')) { c+=90; cb+=23; }
            if (t.includes('å¥¶') || t.includes('æ‹¿éµ')) { c+=120; p+=6; f+=6; }
            if (c===0 && t.length > 0) c=200; // é è¨­å€¼
            return { name: text, calories: c, protein: p, carbs: cb, fat: f };
        };

        // --- UI å…ƒä»¶ ---
        const Loading = () => {
            const [showReset, setShowReset] = useState(false);
            useEffect(() => {
                const timer = setTimeout(() => setShowReset(true), 5000);
                return () => clearTimeout(timer);
            }, []);
            return (
                <div className="flex h-screen items-center justify-center bg-bgMain text-primary flex-col p-6 text-center">
                    <span className="material-icons text-6xl animate-bounce mb-4">fitness_center</span>
                    <p className="text-xl font-bold mb-8">è¼‰å…¥ä¸­...</p>
                    {showReset && (
                        <button onClick={()=>{localStorage.removeItem('health_log_sync_id');window.location.reload()}} 
                            className="bg-red-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg">
                            âš ï¸ é‡ç½®
                        </button>
                    )}
                </div>
            );
        };

        const Card = ({ children, className = "", onClick }) => {
            return (
                <div onClick={onClick} className={"bg-cardBg rounded-2xl p-6 card-shadow border border-borderBeige " + className}>
                    {children}
                </div>
            );
        };

        const Button = ({ children, onClick, variant = 'primary', className = "", disabled=false }) => {
            const base = "w-full py-4 rounded-xl font-bold text-lg active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed transition-transform ";
            let color = "bg-primary text-white shadow-lg shadow-primary/30";
            if (variant === 'secondary') color = "bg-secondary text-white";
            if (variant === 'outline') color = "border-2 border-primary text-primary bg-transparent";
            
            return (
                <button onClick={onClick} disabled={disabled} className={base + color + " " + className}>
                    {children}
                </button>
            );
        };

        const InputGroup = ({ label, value, onChange, type = "text", placeholder }) => {
            return (
                <div className="mb-4">
                    <label className="block text-secondary mb-2 font-bold">{label}</label>
                    <input type={type} value={value} onChange={onChange} placeholder={placeholder}
                        className="w-full bg-inputBg rounded-xl p-4 text-primary font-bold border-none focus:ring-2 focus:ring-primary/50" />
                </div>
            );
        };

        // --- é é¢å…ƒä»¶ ---
        const Dashboard = ({ data, targets, totals, onQuickAdd, onCopy, isWorkoutDay }) => {
            const currentTargets = isWorkoutDay ? targets.workout : targets.rest;
            const remainingCal = currentTargets.calories - totals.cal;
            
            const getAdvice = () => {
                if (data.water < targets.water * 0.5) return { icon: 'water_drop', text: "æ°´åˆ†ä¸è¶³ï¼Œå¿«å–æ¯æ°´ï¼", color: "text-blue-500" };
                if (totals.pro < currentTargets.protein * 0.4) return { icon: 'egg_alt', text: "è›‹ç™½è³ªè½å¾Œï¼Œå¤šåƒè‚‰æˆ–è›‹ã€‚", color: "text-primary" };
                if (isWorkoutDay) return { icon: 'fitness_center', text: "è¨“ç·´æ—¥ç›®æ¨™å·²èª¿é«˜ï¼", color: "text-orange-500" };
                return { icon: 'thumb_up', text: "ç‹€æ…‹ä¸éŒ¯ï¼Œç¹¼çºŒä¿æŒï¼", color: "text-primary" };
            };
            const advice = getAdvice();

            return (
                <div className="space-y-6 animate-fade-in">
                    <Card className="bg-primary text-white border-none">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h2 className="text-white/90 text-lg">ä»Šæ—¥å‰©é¤˜</h2>
                                <div className="big-num">{Math.round(remainingCal)}</div>
                                <div className="text-white/80 text-sm">kcal</div>
                            </div>
                            <div className="text-right">
                                <div className={"px-3 py-1 rounded-full text-sm font-bold inline-block mb-1 " + (isWorkoutDay ? 'bg-orange-400 text-white' : 'bg-white/20')}>
                                    {isWorkoutDay ? 'ğŸ”¥ é‹å‹•æ—¥' : 'â˜• ä¼‘æ¯æ—¥'}
                                </div>
                                <div className="text-white/90 text-sm">æ”å– {Math.round(totals.cal)} / {currentTargets.calories}</div>
                            </div>
                        </div>
                        <div className="grid grid-cols-3 gap-2 mt-4">
                            <div className="bg-white/10 p-2 rounded-lg text-center"><div className="text-xs opacity-70">è›‹ç™½è³ª</div><div className="font-bold">{Math.round(totals.pro)}/{currentTargets.protein}</div></div>
                            <div className="bg-white/10 p-2 rounded-lg text-center"><div className="text-xs opacity-70">ç¢³æ°´</div><div className="font-bold">{Math.round(totals.carb)}/{currentTargets.carbs}</div></div>
                            <div className="bg-white/10 p-2 rounded-lg text-center"><div className="text-xs opacity-70">è„‚è‚ª</div><div className="font-bold">{Math.round(totals.fat)}/{currentTargets.fat}</div></div>
                        </div>
                    </Card>

                    <Card className="flex items-center gap-4 bg-yellow-50 border-yellow-100">
                        <span className={"material-icons text-3xl " + advice.color}>{advice.icon}</span>
                        <div>
                            <h3 className="font-bold text-secondary">AI å°åŠ©æ‰‹</h3>
                            <p className="text-sm text-secondary">{advice.text}</p>
                        </div>
                    </Card>

                    <div className="grid grid-cols-2 gap-4">
                        <Card onClick={() => onQuickAdd('water', 250)} className="cursor-pointer active:scale-95 transition-transform relative overflow-hidden">
                            <div className="absolute right-[-10px] bottom-[-10px] opacity-10"><span className="material-icons text-8xl text-blue-500">water_drop</span></div>
                            <h3 className="text-secondary font-bold">æ°´åˆ†</h3>
                            <div className="flex items-baseline gap-1 mt-1"><span className="text-3xl font-bold text-blue-600">{data.water}</span><span className="text-sm">ml</span></div>
                            <div className="mt-2 text-xs text-secondary bg-inputBg inline-block px-2 py-1 rounded">+250ml</div>
                        </Card>
                        <Card onClick={() => onQuickAdd('steps', 500)} className="cursor-pointer active:scale-95 transition-transform relative overflow-hidden">
                            <div className="absolute right-[-10px] bottom-[-10px] opacity-10"><span className="material-icons text-8xl text-orange-500">directions_run</span></div>
                            <h3 className="text-secondary font-bold">æ­¥æ•¸</h3>
                            <div className="flex items-baseline gap-1 mt-1"><span className="text-3xl font-bold text-orange-600">{data.steps}</span><span className="text-sm">æ­¥</span></div>
                            <div className="mt-2 text-xs text-secondary bg-inputBg inline-block px-2 py-1 rounded">+500æ­¥</div>
                        </Card>
                    </div>

                    <Button variant="secondary" onClick={onCopy}>
                        <span className="material-icons">content_copy</span> è¤‡è£½çµ¦æ•™ç·´
                    </Button>
                </div>
            );
        };

        const LogPage = ({ data, onUpdate, onAddMeal, deleteMeal, apiKey, favorites, onToggleFavorite }) => {
            const [mealInput, setMealInput] = useState('');
            const [manualMode, setManualMode] = useState(false);
            const [analyzing, setAnalyzing] = useState(false);
            const [selectedCategory, setSelectedCategory] = useState(getDefaultMealCategory());
            const [manualMeal, setManualMeal] = useState({ name: '', calories: '', protein: '', carbs: '', fat: '' });
            const [showFavModal, setShowFavModal] = useState(false);

            const analyzeMeal = async (text) => {
                if (!apiKey) return fallbackAnalysis(text);
                try {
                    const prompt = `åˆ†æé£Ÿç‰©ç‡Ÿé¤Šï¼š${text}ã€‚è«‹å›å‚³ç´” JSON æ ¼å¼ï¼Œä¸è¦æœ‰ markdown code blockï¼Œæ ¼å¼ç‚ºï¼š{"name": "${text}", "calories": æ•¸å­—, "protein": æ•¸å­—, "carbs": æ•¸å­—, "fat": æ•¸å­—}ã€‚ç¢ºä¿æ¬„ä½ç‚ºå°å¯«è‹±æ–‡ã€‚`;
                    
                    const resultText = await callGeminiAPI(apiKey, prompt, true);
                    
                    // å˜—è©¦è§£æ JSON (è™•ç†æœ‰æ™‚ AI é‚„æ˜¯å›å‚³ markdown çš„æƒ…æ³)
                    let cleanJson = resultText.replace(/```json/g, '').replace(/```/g, '').trim();
                    const parsed = JSON.parse(cleanJson);
                    
                    return { 
                        name: parsed.name || text, 
                        calories: Number(parsed.calories) || 0, 
                        protein: Number(parsed.protein) || 0, 
                        carbs: Number(parsed.carbs) || 0, 
                        fat: Number(parsed.fat) || 0 
                    };
                } catch (e) { 
                    console.error("AI Analysis Failed:", e);
                    alert(`AI åˆ†æå¤±æ•— (${e.message})ï¼Œå·²åˆ‡æ›è‡³ä¼°ç®—æ¨¡å¼`); 
                    return fallbackAnalysis(text); 
                }
            };

            const handleAdd = async (override = null) => {
                let toAdd = override;
                if (!toAdd) {
                    if(manualMode) {
                        toAdd = { name: manualMeal.name || 'è‡ªè¨‚', calories: Number(manualMeal.calories), protein: Number(manualMeal.protein), carbs: Number(manualMeal.carbs), fat: Number(manualMeal.fat) };
                        setManualMeal({ name: '', calories: '', protein: '', carbs: '', fat: '' }); setManualMode(false);
                    } else {
                        if (!mealInput) return;
                        if (apiKey) { 
                            setAnalyzing(true); 
                            toAdd = await analyzeMeal(mealInput); 
                            setAnalyzing(false); 
                        } else { 
                            toAdd = fallbackAnalysis(mealInput); 
                        }
                        setMealInput('');
                    }
                }
                if (toAdd) onAddMeal({ ...toAdd, category: selectedCategory });
            };

            const mealsByCat = useMemo(() => { 
                const g = { breakfast: [], lunch: [], dinner: [], snack: [] }; 
                (data.meals || []).forEach(m => { 
                    const c = m.category || 'snack'; 
                    if (g[c]) g[c].push(m); 
                }); 
                return g; 
            }, [data.meals]);

            return (
                <div className="space-y-6 pb-20">
                    <Card>
                        <h3 className="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                            <span className="material-icons">accessibility</span> èº«é«”èˆ‡ç‹€æ…‹
                        </h3>
                        <div className="grid grid-cols-2 gap-4">
                            <InputGroup label="é«”é‡ (kg)" type="number" value={data.weight || ''} onChange={e => onUpdate({weight: e.target.value})} placeholder="0.0" />
                            <InputGroup label="ç¡çœ  (hr)" type="number" value={data.sleep || ''} onChange={e => onUpdate({sleep: e.target.value})} placeholder="7.0" />
                        </div>
                        <div>
                            <label className="block text-secondary mb-2 font-bold flex justify-between">
                                <span>ç–²å‹åº¦ (1-10)</span><span className="text-primary font-bold">{data.fatigue}</span>
                            </label>
                            <input type="range" min="1" max="10" value={data.fatigue} onChange={e => onUpdate({fatigue: parseInt(e.target.value)})} className="w-full h-3 bg-inputBg rounded-lg appearance-none cursor-pointer accent-primary"/>
                        </div>
                    </Card>

                    <Card>
                        <h3 className="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                            <span className="material-icons">restaurant</span> é£²é£Ÿç´€éŒ„
                        </h3>
                        <div className="flex bg-inputBg rounded-xl p-1 mb-4 overflow-x-auto">
                            {Object.entries(MEAL_CATEGORIES).map(([key, label]) => (
                                <button key={key} onClick={() => setSelectedCategory(key)} 
                                    className={"flex-1 py-2 px-2 rounded-lg font-bold text-sm whitespace-nowrap transition-all " + (selectedCategory === key ? 'bg-white shadow text-primary' : 'text-gray-400')}>
                                    {label}
                                </button>
                            ))}
                        </div>
                        <div className="flex gap-2 mb-2">
                            <button onClick={() => setManualMode(false)} className={"flex-1 py-2 rounded-lg font-bold text-sm " + (!manualMode ? 'bg-primary text-white' : 'bg-inputBg text-secondary')}>
                                {apiKey ? 'âœ¨ AI æ™ºèƒ½è¼¸å…¥' : 'å¿«é€Ÿè¼¸å…¥'}
                            </button>
                            <button onClick={() => setManualMode(true)} className={"flex-1 py-2 rounded-lg font-bold text-sm " + (manualMode ? 'bg-primary text-white' : 'bg-inputBg text-secondary')}>
                                æ‰‹å‹•è¼¸å…¥
                            </button>
                        </div>
                        
                        {!manualMode ? (
                            <div className="flex gap-2 mb-4">
                                <button onClick={()=>setShowFavModal(true)} className="bg-yellow-400 text-white px-3 rounded-xl shadow-md flex items-center justify-center">
                                    <span className="material-icons">star</span>
                                </button>
                                <input type="text" placeholder={apiKey ? "è¼¸å…¥é¤é» (AI)" : "è¼¸å…¥é¤é»"} 
                                    className="flex-1 bg-inputBg rounded-xl p-4 text-lg border-none min-w-0" 
                                    value={mealInput} onChange={e => setMealInput(e.target.value)} 
                                    onKeyDown={e => e.key === 'Enter' && !analyzing && handleAdd()} />
                                <button onClick={() => handleAdd()} disabled={analyzing} 
                                    className="bg-primary text-white px-4 rounded-xl text-xl shadow-md min-w-[50px] flex items-center justify-center">
                                    {analyzing ? <span className="material-icons animate-spin text-lg">sync</span> : '+'}
                                </button>
                            </div>
                        ) : (
                            <div className="bg-inputBg p-4 rounded-xl mb-4 space-y-2">
                                <input placeholder="åç¨±" className="w-full p-2 rounded" value={manualMeal.name} onChange={e=>setManualMeal({...manualMeal, name: e.target.value})}/>
                                <div className="grid grid-cols-4 gap-2">
                                    <input type="number" placeholder="ç†±" className="p-2 rounded" value={manualMeal.calories} onChange={e=>setManualMeal({...manualMeal, calories: e.target.value})}/>
                                    <input type="number" placeholder="è›‹" className="p-2 rounded" value={manualMeal.protein} onChange={e=>setManualMeal({...manualMeal, protein: e.target.value})}/>
                                    <input type="number" placeholder="ç¢³" className="p-2 rounded" value={manualMeal.carbs} onChange={e=>setManualMeal({...manualMeal, carbs: e.target.value})}/>
                                    <input type="number" placeholder="è„‚" className="p-2 rounded" value={manualMeal.fat} onChange={e=>setManualMeal({...manualMeal, fat: e.target.value})}/>
                                </div>
                                <button onClick={() => handleAdd()} className="w-full bg-secondary text-white py-2 rounded font-bold">æ–°å¢</button>
                            </div>
                        )}

                        <div className="space-y-4">
                            {['breakfast', 'lunch', 'dinner', 'snack'].map(catKey => { 
                                const list = mealsByCat[catKey]; 
                                if (!list.length) return null; 
                                return (
                                    <div key={catKey}>
                                        <h4 className="text-sm font-bold text-gray-400 mb-2 pl-1 border-b border-gray-100 pb-1">{MEAL_CATEGORIES[catKey]}</h4>
                                        <ul className="space-y-2">
                                            {list.map((m) => (
                                                <li key={m.id} className="flex justify-between items-center bg-inputBg p-3 rounded-xl">
                                                    <div className="flex-1">
                                                        <div className="text-base font-bold text-secondary flex items-center gap-1">
                                                            {m.name}
                                                            <button onClick={() => onToggleFavorite(m)} className="text-yellow-400 opacity-50 hover:opacity-100"><span className="material-icons text-base">star_border</span></button>
                                                        </div>
                                                        <div className="text-xs text-gray-500">{m.calories} kcal (P{m.protein} C{m.carbs} F{m.fat})</div>
                                                    </div>
                                                    <button onClick={() => deleteMeal(m.id)} className="text-red-400 p-2"><span className="material-icons text-lg">delete</span></button>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                ) 
                            })}
                        </div>
                    </Card>

                    <Card>
                        <h3 className="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                            <span className="material-icons">fitness_center</span> é‹å‹•ç´€éŒ„
                        </h3>
                        <div className="space-y-4">
                            <div className="grid grid-cols-3 gap-2">
                                <div className="col-span-2">
                                    <input className="w-full bg-inputBg p-3 rounded-xl" placeholder="é‡è¨“é …ç›®" value={data.workoutType || ''} onChange={e => onUpdate({workoutType: e.target.value})} />
                                </div>
                                <div className="relative">
                                    <input type="number" className="w-full bg-inputBg p-3 rounded-xl text-center" placeholder="åˆ†" value={data.workoutTime || ''} onChange={e => onUpdate({workoutTime: parseInt(e.target.value) || 0})} />
                                </div>
                            </div>
                            <div className="grid grid-cols-3 gap-2">
                                <div className="col-span-2">
                                    <input className="w-full bg-inputBg p-3 rounded-xl" placeholder="æœ‰æ°§é …ç›®" value={data.cardioType || ''} onChange={e => onUpdate({cardioType: e.target.value})} />
                                </div>
                                <div className="relative">
                                    <input type="number" className="w-full bg-inputBg p-3 rounded-xl text-center" placeholder="åˆ†" value={data.cardioTime || ''} onChange={e => onUpdate({cardioTime: parseInt(e.target.value) || 0})} />
                                </div>
                            </div>
                        </div>
                    </Card>
                    
                    {showFavModal && (
                        <div className="modal-overlay" onClick={()=>setShowFavModal(false)}>
                            <div className="bg-white p-6 rounded-2xl w-4/5 max-w-sm max-h-[80vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-primary mb-4">å¸¸ç”¨é¤é»</h3>
                                {favorites.length === 0 ? <p className="text-gray-400">é»æ“Šç´€éŒ„æ—çš„æ˜Ÿæ˜Ÿå¯åŠ å…¥å¸¸ç”¨</p> : (
                                    <ul className="space-y-2">
                                        {favorites.map((fav, i) => (
                                            <li key={i} onClick={() => { handleAdd(fav); setShowFavModal(false); }} className="bg-inputBg p-3 rounded-xl cursor-pointer hover:bg-gray-100 flex justify-between items-center">
                                                <span>{fav.name}</span>
                                                <span className="text-xs text-gray-500">{fav.calories} kcal</span>
                                            </li>
                                        ))}
                                    </ul>
                                )}
                                <button onClick={()=>setShowFavModal(false)} className="mt-4 w-full py-2 text-gray-500">é—œé–‰</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const AdvisorPage = ({ user, apiKey }) => {
            const [mode, setMode] = useState('chat');
            const [report, setReport] = useState('');
            const [generating, setGenerating] = useState(false);
            const [messages, setMessages] = useState([{role: 'ai', text: 'ä½ å¥½ï¼æˆ‘æ˜¯ AI æ•™ç·´ã€‚'}]);
            const [input, setInput] = useState('');
            const [chatting, setChatting] = useState(false);
            const chatEndRef = useRef(null);
            
            const getMd = () => window.markdownit ? window.markdownit() : { render: (t) => t };
            const md = getMd();
            
            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            const generateReport = async () => {
                if (!apiKey) return alert("è«‹å…ˆè¨­å®š API Key");
                setGenerating(true);
                try {
                    const logsRef = db.collection('artifacts/health-tracker-v1/users/'+user.uid+'/daily_logs').orderBy(firebase.firestore.FieldPath.documentId()).limitToLast(7);
                    const snap = await logsRef.get();
                    if (snap.empty) { alert("æ²’æœ‰è¶³å¤ çš„è³‡æ–™å¯ä»¥ç”Ÿæˆé€±å ±"); setGenerating(false); return; }
                    
                    const data = snap.docs.map(d => d.id + ": " + JSON.stringify(d.data())).join('\n');
                    const prompt = "é€±å ±åˆ†æï¼š\n\n" + data;
                    
                    const text = await callGeminiAPI(apiKey, prompt);
                    setReport(text);
                } catch (e) { 
                    alert("ç”Ÿæˆå¤±æ•—: " + e.message); 
                } finally { 
                    setGenerating(false); 
                }
            };

            const sendChat = async () => {
                if (!input.trim() || !apiKey) return;
                const userMsg = input; 
                setMessages(prev => [...prev, {role: 'user', text: userMsg}]); 
                setInput(''); 
                setChatting(true);
                try {
                    const text = await callGeminiAPI(apiKey, "æ•™ç·´å›ç­”ï¼š" + userMsg);
                    setMessages(prev => [...prev, {role: 'ai', text: text}]);
                } catch (e) { 
                    setMessages(prev => [...prev, {role: 'ai', text: 'é€£ç·šå¤±æ•—: ' + e.message}]); 
                } finally { 
                    setChatting(false); 
                }
            };

            return (
                <div className="space-y-6 pb-20 h-[calc(100vh-160px)] flex flex-col">
                    <div className="flex bg-cardBg rounded-2xl p-1 mb-2 shrink-0">
                        <button onClick={() => setMode('chat')} className={"flex-1 py-3 rounded-xl font-bold transition-all " + (mode==='chat'?'bg-primary text-white shadow':'text-gray-400')}>AI èŠèŠ</button>
                        <button onClick={() => setMode('report')} className={"flex-1 py-3 rounded-xl font-bold transition-all " + (mode==='report'?'bg-primary text-white shadow':'text-gray-400')}>å¥åº·é€±å ±</button>
                    </div>
                    
                    {!apiKey && <Card className="text-center py-8"><p className="text-secondary mb-4">è«‹å…ˆè¨­å®š API Key</p><Button variant="outline" onClick={()=>document.querySelector('button[data-nav="settings"]').click()}>å‰å¾€è¨­å®š</Button></Card>}
                    
                    {apiKey && mode === 'chat' && (
                        <Card className="flex-1 flex flex-col overflow-hidden !p-4">
                            <div className="flex-1 overflow-y-auto mb-4 hide-scrollbar space-y-4">
                                {messages.map((m, i) => (
                                    <div key={i} className={"flex flex-col " + (m.role === 'user' ? 'items-end' : 'items-start')}>
                                        <div className={"chat-bubble " + (m.role === 'user' ? 'chat-user' : 'chat-ai')}>
                                            <div dangerouslySetInnerHTML={{ __html: md.render(m.text) }} />
                                        </div>
                                    </div>
                                ))}
                                {chatting && <div className="text-gray-400 text-sm animate-pulse ml-2">AI æ­£åœ¨è¼¸å…¥...</div>}
                                <div ref={chatEndRef} />
                            </div>
                            <div className="flex gap-2 border-t border-borderBeige pt-4">
                                <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&sendChat()} className="flex-1 bg-inputBg rounded-xl px-4 py-3" placeholder="å•å€‹å•é¡Œ..." />
                                <button onClick={sendChat} disabled={chatting} className="bg-primary text-white px-4 rounded-xl material-icons">send</button>
                            </div>
                        </Card>
                    )}
                    
                    {apiKey && mode === 'report' && (
                        <div className="overflow-y-auto">
                            <Card className="mb-4">
                                <Button onClick={generateReport} disabled={generating}>{generating ? 'ç”Ÿæˆä¸­...' : 'âœ¨ ç”Ÿæˆæœ¬é€±é€±å ±'}</Button>
                            </Card>
                            {report && <Card className="markdown-body"><div dangerouslySetInnerHTML={{ __html: md.render(report) }} /></Card>}
                        </div>
                    )}
                </div>
            );
        };

        const HistoryPage = ({ user, historyData }) => {
            const downloadCSV = async () => {
                try {
                    const snap = await db.collection('artifacts/health-tracker-v1/users/'+user.uid+'/daily_logs').get();
                    let csv = "Date,Weight,Sleep,Fatigue,Water,Steps,WorkoutType,WorkoutTime,CardioTime\n";
                    snap.forEach(doc => { const d = doc.data(); csv += `${doc.id},${d.weight||''},${d.sleep||''},${d.fatigue||''},${d.water||0},${d.steps||0},${d.workoutType||''},${d.workoutTime||0},${d.cardioTime||0}\n`; });
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `health_data_${getTodayString()}.csv`; link.click();
                } catch(e) { alert("åŒ¯å‡ºå¤±æ•—"); }
            };
            return (
                <div className="space-y-6">
                    <Card>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-primary">é«”é‡è¶¨å‹¢</h3>
                            <button onClick={downloadCSV} className="text-sm bg-secondary text-white px-3 py-1 rounded-lg flex items-center gap-1"><span className="material-icons text-sm">download</span> CSV</button>
                        </div>
                        <div className="h-64 w-full -ml-4">
                            {LineChart ? (
                                <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={historyData}>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#eee" />
                                        <XAxis dataKey="name" stroke="#6B5E52" tick={{fontSize: 12}} />
                                        <YAxis domain={['dataMin - 1', 'dataMax + 1']} stroke="#6B5E52" width={40} />
                                        <Tooltip contentStyle={{borderRadius: '10px', border:'none', boxShadow:'0 4px 12px rgba(0,0,0,0.1)'}} />
                                        <Line type="monotone" dataKey="weight" stroke="#4A5D23" strokeWidth={4} dot={{r: 4}} activeDot={{r: 8}} />
                                    </LineChart>
                                </ResponsiveContainer>
                            ) : <div className="text-center p-10">åœ–è¡¨è¼‰å…¥ä¸­...</div>}
                        </div>
                    </Card>
                </div>
            );
        };

        const SettingsPage = ({ user, targets, setTargets, apiKey, setApiKey, onSave, localSyncId, setLocalSyncId, currentId }) => {
            const [tab, setTab] = useState('rest'); 
            const [testing, setTesting] = useState(false);

            const testApi = async () => {
                setTesting(true);
                try {
                    await callGeminiAPI(apiKey, "Hi");
                    alert("âœ… é€£ç·šæˆåŠŸï¼API Key é‹ä½œæ­£å¸¸ã€‚");
                } catch(e) {
                    alert("âŒ é€£ç·šå¤±æ•—: " + e.message + "\n\nè«‹ç¢ºèªï¼š\n1. Key æ˜¯å¦ä¾†è‡ª Google AI Studio (é Vertex)\n2. æ˜¯å¦æœ‰å¤šé¤˜ç©ºæ ¼");
                } finally {
                    setTesting(false);
                }
            };

            return (
                <div className="space-y-6 pb-20">
                    <Card>
                        <h3 className="text-xl font-bold text-primary mb-4">ç‡Ÿé¤Šç›®æ¨™è¨­å®š</h3>
                        <div className="flex bg-inputBg rounded-xl p-1 mb-4">
                            <button onClick={() => setTab('rest')} className={"flex-1 py-2 rounded-lg font-bold transition-all " + (tab==='rest'?'bg-white shadow text-primary':'text-gray-400')}>ä¼‘æ¯æ—¥</button>
                            <button onClick={() => setTab('workout')} className={"flex-1 py-2 rounded-lg font-bold transition-all " + (tab==='workout'?'bg-white shadow text-primary':'text-gray-400')}>é‹å‹•æ—¥</button>
                        </div>
                        <div className="space-y-4 animate-fade-in">
                            <InputGroup label="ç›®æ¨™ç†±é‡ (kcal)" type="number" value={targets[tab].calories} onChange={e => setTargets({...targets, [tab]: {...targets[tab], calories: Number(e.target.value)}})} />
                            <div className="grid grid-cols-3 gap-2">
                                <InputGroup label="è›‹ç™½è³ª" type="number" value={targets[tab].protein} onChange={e => setTargets({...targets, [tab]: {...targets[tab], protein: Number(e.target.value)}})} />
                                <InputGroup label="ç¢³æ°´" type="number" value={targets[tab].carbs} onChange={e => setTargets({...targets, [tab]: {...targets[tab], carbs: Number(e.target.value)}})} />
                                <InputGroup label="è„‚è‚ª" type="number" value={targets[tab].fat} onChange={e => setTargets({...targets, [tab]: {...targets[tab], fat: Number(e.target.value)}})} />
                            </div>
                        </div>
                        <hr className="my-4 border-borderBeige"/>
                        <InputGroup label="æ°´åˆ†ç›®æ¨™ (ml)" type="number" value={targets.water} onChange={e => setTargets({...targets, water: Number(e.target.value)})} />
                        <InputGroup label="æ­¥æ•¸ç›®æ¨™" type="number" value={targets.steps} onChange={e => setTargets({...targets, steps: Number(e.target.value)})} />
                    </Card>
                    <Card>
                        <h3 className="text-xl font-bold text-primary mb-4">åŒæ­¥è¨­å®š</h3>
                        <div className="bg-yellow-50 p-4 rounded-xl mb-4 border border-yellow-100">
                            <p className="text-xs text-secondary mb-1">ç›®å‰ ID:</p>
                            <p className="font-mono font-bold text-primary break-all">{currentId}</p>
                        </div>
                        <p className="text-sm text-gray-500 mb-2">åŒæ­¥å…¶ä»–è£ç½® IDï¼š</p>
                        <div className="relative">
                            <input type="text" value={localSyncId} onChange={e => setLocalSyncId(e.target.value)} className="w-full bg-inputBg rounded-xl p-4 text-primary font-bold border-none" />
                            <span className="absolute right-4 top-4 text-xs bg-secondary text-white px-2 py-1 rounded cursor-pointer" onClick={() => {navigator.clipboard.writeText(localSyncId); alert("å·²è¤‡è£½ ID")}} >è¤‡è£½</span>
                        </div>
                        <p className="text-xs text-red-400 mt-2">* è²¼ä¸Šå¾Œè«‹æŒ‰ä¸‹æ–¹å„²å­˜ã€‚</p>
                    </Card>
                    <Card>
                        <h3 className="text-xl font-bold text-primary mb-4">ç³»çµ±è¨­å®š</h3>
                        <InputGroup label="Gemini API Key" type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="AIzaSy..." />
                        {apiKey && <button onClick={testApi} disabled={testing} className="text-sm text-blue-500 underline mb-2 block">{testing?'æ¸¬è©¦ä¸­...':'æ¸¬è©¦é€£ç·š'}</button>}
                        <div className="text-xs text-gray-400">
                            è«‹è‡³ <a href="https://aistudio.google.com/app/apikey" target="_blank" className="underline">Google AI Studio</a> ç”³è«‹ Key (é Vertex AI)ã€‚
                        </div>
                    </Card>
                    <Button onClick={onSave}>å„²å­˜æ‰€æœ‰è¨­å®š</Button>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [syncId, setSyncId] = useState(''); 
            const [localSyncId, setLocalSyncId] = useState('');
            const [view, setView] = useState('dashboard');
            const [loading, setLoading] = useState(true);
            const [date, setDate] = useState(getTodayString());
            const [todayData, setTodayData] = useState({ weight: '', sleep: '', fatigue: 5, water: 0, steps: 0, workoutType: '', workoutTime: 0, cardioType: '', cardioTime: 0, meals: [] });
            const [targets, setTargets] = useState({ rest: { calories: 1600, protein: 100, carbs: 150, fat: 50 }, workout: { calories: 2000, protein: 150, carbs: 200, fat: 60 }, water: 2000, steps: 8000 });
            const [apiKey, setApiKey] = useState('');
            const [historyData, setHistoryData] = useState([]);
            const [favorites, setFavorites] = useState([]);
            const [permissionError, setPermissionError] = useState(false);

            useEffect(() => { const u = auth.onAuthStateChanged(async (u) => { if (u) { setUser(u); const s = localStorage.getItem('health_log_sync_id'); const i = s ? s.trim() : u.uid; setSyncId(i); setLocalSyncId(i); } else { auth.signInAnonymously().catch(console.error); } }); return () => u(); }, []);
            useEffect(() => { 
                if(syncId) { 
                    loadUserData(syncId); 
                    const u = db.doc('artifacts/health-tracker-v1/users/'+syncId+'/daily_logs/'+date).onSnapshot(doc => { 
                        if (doc.exists) setTodayData({ ...doc.data() }); 
                        else setTodayData({ weight: '', sleep: '', fatigue: 5, water: 0, steps: 0, workoutType: '', workoutTime: 0, cardioType: '', cardioTime: 0, meals: [] }); 
                        setPermissionError(false); setLoading(false); 
                    }, (e) => { 
                        if (e.code === 'permission-denied') setPermissionError(true); 
                        setLoading(false); 
                    }); 
                    return () => u(); 
                } 
            }, [date, syncId]);

            const loadUserData = async (uid) => {
                try {
                    const s = await db.doc('artifacts/health-tracker-v1/users/'+uid+'/settings/config').get();
                    if (s.exists) { const d = s.data(); if(d.targets && d.targets.workout) setTargets(d.targets); if(d.apiKey) setApiKey(d.apiKey); if(d.favorites) setFavorites(d.favorites); }
                    const l = await db.collection('artifacts/health-tracker-v1/users/'+uid+'/daily_logs').limit(10).get();
                    setHistoryData(l.docs.map(d => ({ name: d.id.slice(5), weight: d.data().weight || 0 })).sort((a,b) => a.name.localeCompare(b.name)));
                } catch (e) { if (e.code === 'permission-denied') setPermissionError(true); }
            };

            const saveData = async (n) => { if (!syncId) return; setTodayData(p => ({...p, ...n})); await db.doc('artifacts/health-tracker-v1/users/'+syncId+'/daily_logs/'+date).set({ ...todayData, ...n }, { merge: true }); };
            const saveSettings = async () => { if(!localSyncId) return; const c = localSyncId.trim(); localStorage.setItem('health_log_sync_id', c); setSyncId(c); setLocalSyncId(c); await db.doc('artifacts/health-tracker-v1/users/'+c+'/settings/config').set({ targets, apiKey, favorites }, { merge: true }); alert("å·²å„²å­˜ï¼"); window.location.reload(); };
            const toggleFavorite = async (m) => { if (!syncId) return; const i = favorites.find(f => f.name === m.name); let n; if (i) { n = favorites.filter(f => f.name !== m.name); alert("å·²ç§»é™¤"); } else { const { id, category, ...rest } = m; n = [...favorites, rest]; alert("å·²åŠ å…¥"); } setFavorites(n); await db.doc('artifacts/health-tracker-v1/users/'+syncId+'/settings/config').set({ favorites: n }, { merge: true }); };

            const totals = useMemo(() => todayData.meals.reduce((a, m) => ({ cal: a.cal + (m.calories||0), pro: a.pro + (m.protein||0), carb: a.carb + (m.carbs||0), fat: a.fat + (m.fat||0) }), { cal: 0, pro: 0, carb: 0, fat: 0 }), [todayData.meals]);
            const isWorkoutDay = (todayData.workoutTime || 0) >= 30;
            const changeDate = (d) => setDate(p => shiftDate(p, d));
            const handleCopy = () => {
                const t = isWorkoutDay ? targets.workout : targets.rest;
                const MN = { 'breakfast': 'æ—©é¤', 'lunch': 'åˆé¤', 'dinner': 'æ™šé¤', 'snack': 'é»å¿ƒ' };
                let mt = ""; ['breakfast', 'lunch', 'dinner', 'snack'].forEach(c => { const ms = todayData.meals.filter(m => (m.category || 'snack') === c); if (ms.length > 0) mt += `\n${MN[c]}: ${ms.map(m => m.name).join(', ')}`; });
                navigator.clipboard.writeText(`ğŸ“… ${date} (${isWorkoutDay?'ğŸ”¥è¨“ç·´':'â˜•ä¼‘æ¯'})\nâš–ï¸ ${todayData.weight}kg | ğŸ˜´ ${todayData.sleep}hr\nğŸ’§ ${todayData.water}ml | ğŸ‘£ ${todayData.steps}\nğŸ‹ï¸ é‡è¨“: ${todayData.workoutType||'ç„¡'} (${todayData.workoutTime}min)\nğŸ± æ”å–: ${Math.round(totals.cal)} / ${t.calories} kcal\n(P${Math.round(totals.pro)} C${Math.round(totals.carb)} F${Math.round(totals.fat)})${mt}`); alert("å·²è¤‡è£½ï¼");
            };

            if (loading) return <Loading />;
            
            return (
                <div className="max-w-md mx-auto min-h-screen bg-bgMain relative shadow-2xl">
                    <header className="sticky top-0 z-10 bg-bgMain/95 backdrop-blur-sm p-4 border-b border-borderBeige flex flex-col justify-between items-center">
                        <div className="w-full flex justify-between items-center mb-2">
                            <h1 className="text-xl font-bold text-primary flex items-center gap-2">
                                <span className="material-icons">spa</span> Health Log
                            </h1>
                            <div className="flex items-center gap-2 bg-white rounded-full px-2 py-1 shadow-sm border border-borderBeige">
                                <button onClick={()=>changeDate(-1)} className="material-icons text-secondary text-base hover:bg-gray-100 rounded-full p-1">chevron_left</button>
                                <span className="text-primary font-bold text-sm w-24 text-center">{date}</span>
                                <button onClick={()=>changeDate(1)} className="material-icons text-secondary text-base hover:bg-gray-100 rounded-full p-1">chevron_right</button>
                            </div>
                        </div>
                        {permissionError && <div className="w-full bg-red-500 text-white px-4 py-2 rounded-lg text-center text-sm font-bold animate-pulse">âš ï¸ æ¬Šé™ä¸è¶³ï¼šè«‹æª¢æŸ¥ Firestore Rules</div>}
                    </header>
                    <main className="p-4 pb-28">
                        {view === 'dashboard' && <Dashboard data={todayData} targets={targets} totals={totals} isWorkoutDay={isWorkoutDay} onQuickAdd={(f,v)=>saveData({[f]:(todayData[f]||0)+v})} onCopy={handleCopy} />}
                        {view === 'log' && <LogPage data={todayData} onUpdate={saveData} onAddMeal={(m)=>saveData({meals:[...todayData.meals,{...m,id:Date.now()}]})} deleteMeal={(id)=>saveData({meals:todayData.meals.filter(m=>m.id!==id)})} apiKey={apiKey} favorites={favorites} onToggleFavorite={toggleFavorite} />}
                        {view === 'advisor' && <AdvisorPage user={user} apiKey={apiKey} />}
                        {view === 'history' && <HistoryPage user={user} historyData={historyData} />}
                        {view === 'settings' && <SettingsPage user={user} targets={targets} setTargets={setTargets} apiKey={apiKey} setApiKey={setApiKey} onSave={saveSettings} localSyncId={localSyncId} setLocalSyncId={setLocalSyncId} currentId={syncId} />}
                    </main>
                    <nav className="fixed bottom-0 w-full max-w-md bg-white border-t border-borderBeige flex justify-around p-2 pb-6 rounded-t-2xl shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-20">
                        {[['dashboard','ç¸½è¦½','dashboard'],['edit_note','ç´€éŒ„','log'],['smart_toy','é¡§å•','advisor'],['insights','æ­·å²','history'],['settings','è¨­å®š','settings']].map(([i,l,v])=>(<button key={v} onClick={()=>setView(v)} data-nav={v} className={"flex flex-col items-center w-14 transition-all duration-300 " + (view===v?'text-activeTab scale-110':'text-inactiveTab')}><span className="material-icons text-2xl mb-0.5">{i}</span><span className="text-[10px] font-bold">{l}</span></button>))}
                    </nav>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>