<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nicole Health Log (Lite)</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¥—</text></svg>">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4322/4322991.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#FFFBF5">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bgMain: '#FFFBF5', cardBg: '#FFFFFF', primary: '#4A5D23', secondary: '#6B5E52',
                        inputBg: '#F5F2EB', borderBeige: '#E8E4D9', activeTab: '#4A5D23', inactiveTab: '#A8A29E'
                    },
                    borderRadius: { 'xl': '14px', '2xl': '20px' }
                }
            }
        }
    </script>

    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body { background-color: #FFFBF5; color: #4A5D23; font-family: system-ui, sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        input, select, button { font-size: 16px; }
        .big-num { font-size: 42px; font-weight: 800; line-height: 1; }
        .card-shadow { box-shadow: 0 4px 12px rgba(74, 93, 35, 0.08); }
        input:focus { outline: 2px solid #4A5D23; background-color: #ffffff; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 50; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <div id="root">
        <div style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #4A5D23;">
            <div style="font-size: 40px; margin-bottom: 20px;">ğŸ¥—</div>
            <div>Health Log Lite å•Ÿå‹•ä¸­...</div>
        </div>
    </div>

    <script type="text/babel">
        // 1. Firebase åˆå§‹åŒ–
        const firebaseConfig = {
            apiKey: "AIzaSyD6FsP4PtdeeD_uuIRnWbbLzsKwHlgS9cM",
            authDomain: "health-tracker-b37e4.firebaseapp.com",
            projectId: "health-tracker-b37e4",
            storageBucket: "health-tracker-b37e4.firebasestorage.app",
            messagingSenderId: "802888614022",
            appId: "1:802888614022:web:e7ec85eef3dfc088aed107"
        };
        if (typeof firebase !== 'undefined' && !firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 2. å·¥å…·èˆ‡å‡½å¼
        const { useState, useEffect, useMemo } = React;
        const Recharts = window.Recharts || {};
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = Recharts;

        const getTodayString = () => {
            const d = new Date();
            const offset = d.getTimezoneOffset() * 60000;
            return new Date(d.getTime() - offset).toISOString().split('T')[0];
        };

        const shiftDate = (dateStr, days) => {
            const d = new Date(dateStr);
            d.setDate(d.getDate() + days);
            return d.toISOString().split('T')[0];
        };

        const MEAL_CATEGORIES = { 'breakfast': 'æ—©é¤', 'lunch': 'åˆé¤', 'dinner': 'æ™šé¤', 'snack': 'é»å¿ƒ' };
        
        const getDefaultMealCategory = () => {
            const h = new Date().getHours();
            if (h >= 5 && h < 11) return 'breakfast';
            if (h >= 11 && h < 15) return 'lunch';
            if (h >= 17 && h < 21) return 'dinner';
            return 'snack';
        };
        
        const fallbackAnalysis = (text) => {
            let c=0, p=0, cb=0, f=0; const t = text.toLowerCase();
            if (t.includes('é›') || t.includes('è‚‰') || t.includes('é­š')) { c+=200; p+=25; f+=10; }
            if (t.includes('é£¯') || t.includes('ç²¥') || t.includes('éºµ')) { c+=280; p+=4; cb+=60; }
            if (t.includes('èœ') || t.includes('è”¬')) { c+=50; cb+=10; }
            if (t.includes('è›‹')) { c+=75; p+=7; f+=5; }
            if (t.includes('é¦™è•‰')) { c+=90; cb+=23; }
            if (c===0 && t.length > 0) c=200;
            return { name: text, calories: c, protein: p, carbs: cb, fat: f };
        };

        // 3. UI å…ƒä»¶
        const Loading = () => {
            const [s, setS] = useState(false);
            useEffect(() => { const t = setTimeout(() => setS(true), 5000); return () => clearTimeout(t); }, []);
            return (
                <div className="flex h-screen items-center justify-center bg-bgMain text-primary flex-col p-6 text-center">
                    <span className="material-icons text-6xl animate-bounce mb-4">fitness_center</span>
                    <p className="text-xl font-bold mb-8">è¼‰å…¥ä¸­...</p>
                    {s && <button onClick={()=>{localStorage.removeItem('health_log_sync_id');window.location.reload()}} className="bg-red-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg">âš ï¸ é‡ç½®</button>}
                </div>
            );
        };

        const Card = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`bg-cardBg rounded-2xl p-6 card-shadow border border-borderBeige ${className}`}>{children}</div>
        );

        const Button = ({ children, onClick, variant = 'primary', className = "", disabled=false }) => {
            const s = { primary: "bg-primary text-white shadow-lg", secondary: "bg-secondary text-white", outline: "border-2 border-primary text-primary bg-transparent" };
            return (
                <button onClick={onClick} disabled={disabled} className={`w-full py-4 rounded-xl font-bold text-lg active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 ${s[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const InputGroup = ({ label, value, onChange, type = "text", placeholder }) => (
            <div className="mb-4">
                <label className="block text-secondary mb-2 font-bold">{label}</label>
                <input type={type} value={value} onChange={onChange} placeholder={placeholder} className="w-full bg-inputBg rounded-xl p-4 text-primary font-bold border-none" />
            </div>
        );

        // 4. é é¢å…ƒä»¶
        const Dashboard = ({ data, targets, totals, onQuickAdd, onCopy, isWorkoutDay }) => {
            const currentTargets = isWorkoutDay ? targets.workout : targets.rest;
            const remainingCal = currentTargets.calories - totals.cal;
            
            return (
                <div className="space-y-6 animate-fade-in">
                    <Card className="bg-primary text-white border-none">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h2 className="text-white/90 text-lg">ä»Šæ—¥å‰©é¤˜</h2>
                                <div className="big-num">{Math.round(remainingCal)}</div>
                                <div className="text-white/80 text-sm">kcal</div>
                            </div>
                            <div className="text-right">
                                <div className={`px-3 py-1 rounded-full text-sm font-bold inline-block mb-1 ${isWorkoutDay ? 'bg-orange-400 text-white' : 'bg-white/20'}`}>
                                    {isWorkoutDay ? 'ğŸ”¥ é‹å‹•æ—¥' : 'â˜• ä¼‘æ¯æ—¥'}
                                </div>
                                <div className="text-white/90 text-sm">æ”å– {Math.round(totals.cal)} / {currentTargets.calories}</div>
                            </div>
                        </div>
                        <div className="grid grid-cols-3 gap-2 mt-4">
                            <div className="bg-white/10 p-2 rounded-lg text-center"><div className="text-xs opacity-70">è›‹ç™½è³ª</div><div className="font-bold">{Math.round(totals.pro)}/{currentTargets.protein}</div></div>
                            <div className="bg-white/10 p-2 rounded-lg text-center"><div className="text-xs opacity-70">ç¢³æ°´</div><div className="font-bold">{Math.round(totals.carb)}/{currentTargets.carbs}</div></div>
                            <div className="bg-white/10 p-2 rounded-lg text-center"><div className="text-xs opacity-70">è„‚è‚ª</div><div className="font-bold">{Math.round(totals.fat)}/{currentTargets.fat}</div></div>
                        </div>
                    </Card>

                    <div className="grid grid-cols-2 gap-4">
                        <Card onClick={() => onQuickAdd('water', 250)} className="cursor-pointer active:scale-95 transition-transform relative overflow-hidden">
                            <div className="absolute right-[-10px] bottom-[-10px] opacity-10"><span className="material-icons text-8xl text-blue-500">water_drop</span></div>
                            <h3 className="text-secondary font-bold">æ°´åˆ†</h3>
                            <div className="flex items-baseline gap-1 mt-1"><span className="text-3xl font-bold text-blue-600">{data.water}</span><span className="text-sm">ml</span></div>
                            <div className="mt-2 text-xs text-secondary bg-inputBg inline-block px-2 py-1 rounded">+250ml</div>
                        </Card>
                        <Card onClick={() => onQuickAdd('steps', 500)} className="cursor-pointer active:scale-95 transition-transform relative overflow-hidden">
                            <div className="absolute right-[-10px] bottom-[-10px] opacity-10"><span className="material-icons text-8xl text-orange-500">directions_run</span></div>
                            <h3 className="text-secondary font-bold">æ­¥æ•¸</h3>
                            <div className="flex items-baseline gap-1 mt-1"><span className="text-3xl font-bold text-orange-600">{data.steps}</span><span className="text-sm">æ­¥</span></div>
                            <div className="mt-2 text-xs text-secondary bg-inputBg inline-block px-2 py-1 rounded">+500æ­¥</div>
                        </Card>
                    </div>

                    <Button variant="secondary" onClick={onCopy}>
                        <span className="material-icons">content_copy</span> è¤‡è£½çµ¦æ•™ç·´
                    </Button>
                </div>
            );
        };

        const LogPage = ({ data, onUpdate, onAddMeal, deleteMeal, apiKey, favorites, onToggleFavorite }) => {
            const [mealInput, setMealInput] = useState('');
            const [manualMode, setManualMode] = useState(false);
            const [analyzing, setAnalyzing] = useState(false);
            const [selectedCategory, setSelectedCategory] = useState(getDefaultMealCategory());
            const [manualMeal, setManualMeal] = useState({ name: '', calories: '', protein: '', carbs: '', fat: '' });
            const [showFavModal, setShowFavModal] = useState(false);

            // ä¿®æ­£ï¼šä½¿ç”¨æœ€ç©©å®šçš„ gemini-1.5-flash
            const analyzeWithAI = async (text) => {
                if (!apiKey) return fallbackAnalysis(text);
                try {
                    const prompt = `åˆ†æé£Ÿç‰©ï¼š${text}ã€‚å›å‚³ JSONï¼š{"name": "${text}", "calories": æ•¸å­—, "protein": æ•¸å­—, "carbs": æ•¸å­—, "fat": æ•¸å­—}ã€‚ç¢ºä¿æ¬„ä½å°å¯«è‹±æ–‡ã€‚`;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { response_mime_type: "application/json" }
                        })
                    });
                    
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || response.status);
                    }
                    
                    const result = await response.json();
                    const parsed = JSON.parse(result.candidates[0].content.parts[0].text);
                    return { 
                        name: parsed.name||text, 
                        calories: Number(parsed.calories)||0, 
                        protein: Number(parsed.protein)||0, 
                        carbs: Number(parsed.carbs)||0, 
                        fat: Number(parsed.fat)||0 
                    };
                } catch (e) { 
                    console.error(e);
                    alert("AI åˆ†æå¤±æ•— (" + e + ")ï¼Œå·²åˆ‡æ›è‡³ä¼°ç®—æ¨¡å¼ã€‚"); 
                    return fallbackAnalysis(text); 
                }
            };

            const handleAdd = async (override = null) => {
                let toAdd = override;
                if (!toAdd) {
                    if(manualMode) {
                        toAdd = { name: manualMeal.name || 'è‡ªè¨‚', calories: Number(manualMeal.calories), protein: Number(manualMeal.protein), carbs: Number(manualMeal.carbs), fat: Number(manualMeal.fat) };
                        setManualMeal({ name: '', calories: '', protein: '', carbs: '', fat: '' }); setManualMode(false);
                    } else {
                        if (!mealInput) return;
                        if (apiKey) { 
                            setAnalyzing(true); 
                            toAdd = await analyzeWithAI(mealInput); 
                            setAnalyzing(false); 
                        } else { 
                            toAdd = fallbackAnalysis(mealInput); 
                        }
                        setMealInput('');
                    }
                }
                if (toAdd) onAddMeal({ ...toAdd, category: selectedCategory });
            };

            const mealsByCat = useMemo(() => { 
                const g = { breakfast: [], lunch: [], dinner: [], snack: [] }; 
                (data.meals || []).forEach(m => { 
                    const c = m.category || 'snack'; 
                    if (g[c]) g[c].push(m); 
                }); 
                return g; 
            }, [data.meals]);

            return (
                <div className="space-y-6 pb-20">
                    <Card>
                        <h3 className="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                            <span className="material-icons">accessibility</span> èº«é«”èˆ‡ç‹€æ…‹
                        </h3>
                        <div className="grid grid-cols-2 gap-4">
                            <InputGroup label="é«”é‡ (kg)" type="number" value={data.weight || ''} onChange={e => onUpdate({weight: e.target.value})} placeholder="0.0" />
                            <InputGroup label="ç¡çœ  (hr)" type="number" value={data.sleep || ''} onChange={e => onUpdate({sleep: e.target.value})} placeholder="7.0" />
                        </div>
                        <div>
                            <label className="block text-secondary mb-2 font-bold flex justify-between">
                                <span>ç–²å‹åº¦ (1-10)</span><span className="text-primary font-bold">{data.fatigue}</span>
                            </label>
                            <input type="range" min="1" max="10" value={data.fatigue} onChange={e => onUpdate({fatigue: parseInt(e.target.value)})} className="w-full h-3 bg-inputBg rounded-lg appearance-none cursor-pointer accent-primary"/>
                        </div>
                    </Card>

                    <Card>
                        <h3 className="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                            <span className="material-icons">restaurant</span> é£²é£Ÿç´€éŒ„
                        </h3>
                        <div className="flex bg-inputBg rounded-xl p-1 mb-4 overflow-x-auto">
                            {Object.entries(MEAL_CATEGORIES).map(([key, label]) => (
                                <button key={key} onClick={() => setSelectedCategory(key)} className={`flex-1 py-2 px-2 rounded-lg font-bold text-sm whitespace-nowrap transition-all ${selectedCategory === key ? 'bg-white shadow text-primary' : 'text-gray-400'}`}>
                                    {label}
                                </button>
                            ))}
                        </div>
                        <div className="flex gap-2 mb-2">
                            <button onClick={() => setManualMode(false)} className={`flex-1 py-2 rounded-lg font-bold text-sm ${!manualMode ? 'bg-primary text-white' : 'bg-inputBg text-secondary'}`}>
                                {apiKey ? 'âœ¨ AI æ™ºèƒ½è¼¸å…¥' : 'å¿«é€Ÿè¼¸å…¥'}
                            </button>
                            <button onClick={() => setManualMode(true)} className={`flex-1 py-2 rounded-lg font-bold text-sm ${manualMode ? 'bg-primary text-white' : 'bg-inputBg text-secondary'}`}>
                                æ‰‹å‹•è¼¸å…¥
                            </button>
                        </div>
                        
                        {!manualMode ? (
                            <div className="flex gap-2 mb-4">
                                <button onClick={()=>setShowFavModal(true)} className="bg-yellow-400 text-white px-3 rounded-xl shadow-md flex items-center justify-center">
                                    <span className="material-icons">star</span>
                                </button>
                                <input type="text" placeholder={apiKey ? "è¼¸å…¥é¤é» (AI)" : "è¼¸å…¥é¤é»"} className="flex-1 bg-inputBg rounded-xl p-4 text-lg border-none min-w-0" value={mealInput} onChange={e => setMealInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && !analyzing && handleAdd()} />
                                <button onClick={() => handleAdd()} disabled={analyzing} className="bg-primary text-white px-4 rounded-xl text-xl shadow-md min-w-[50px] flex items-center justify-center">
                                    {analyzing ? <span className="material-icons animate-spin text-lg">sync</span> : '+'}
                                </button>
                            </div>
                        ) : (
                            <div className="bg-inputBg p-4 rounded-xl mb-4 space-y-2">
                                <input placeholder="åç¨±" className="w-full p-2 rounded" value={manualMeal.name} onChange={e=>setManualMeal({...manualMeal, name: e.target.value})}/>
                                <div className="grid grid-cols-4 gap-2">
                                    <input type="number" placeholder="ç†±" className="p-2 rounded" value={manualMeal.calories} onChange={e=>setManualMeal({...manualMeal, calories: e.target.value})}/>
                                    <input type="number" placeholder="è›‹" className="p-2 rounded" value={manualMeal.protein} onChange={e=>setManualMeal({...manualMeal, protein: e.target.value})}/>
                                    <input type="number" placeholder="ç¢³" className="p-2 rounded" value={manualMeal.carbs} onChange={e=>setManualMeal({...manualMeal, carbs: e.target.value})}/>
                                    <input type="number" placeholder="è„‚" className="p-2 rounded" value={manualMeal.fat} onChange={e=>setManualMeal({...manualMeal, fat: e.target.value})}/>
                                </div>
                                <button onClick={() => handleAdd()} className="w-full bg-secondary text-white py-2 rounded font-bold">æ–°å¢</button>
                            </div>
                        )}

                        <div className="space-y-4">
                            {['breakfast', 'lunch', 'dinner', 'snack'].map(catKey => { 
                                const list = mealsByCat[catKey]; 
                                if (!list.length) return null; 
                                return (
                                    <div key={catKey}>
                                        <h4 className="text-sm font-bold text-gray-400 mb-2 pl-1 border-b border-gray-100 pb-1">{MEAL_CATEGORIES[catKey]}</h4>
                                        <ul className="space-y-2">
                                            {list.map((m) => (
                                                <li key={m.id} className="flex justify-between items-center bg-inputBg p-3 rounded-xl">
                                                    <div className="flex-1">
                                                        <div className="text-base font-bold text-secondary flex items-center gap-1">
                                                            {m.name}
                                                            <button onClick={() => onToggleFavorite(m)} className="text-yellow-400 opacity-50 hover:opacity-100"><span className="material-icons text-base">star_border</span></button>
                                                        </div>
                                                        <div className="text-xs text-gray-500">{m.calories} kcal (P{m.protein} C{m.carbs} F{m.fat})</div>
                                                    </div>
                                                    <button onClick={() => deleteMeal(m.id)} className="text-red-400 p-2"><span className="material-icons text-lg">delete</span></button>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                ) 
                            })}
                        </div>
                    </Card>

                    <Card>
                        <h3 className="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                            <span className="material-icons">fitness_center</span> é‹å‹•ç´€éŒ„
                        </h3>
                        <div className="space-y-4">
                            <div className="grid grid-cols-3 gap-2">
                                <div className="col-span-2">
                                    <input className="w-full bg-inputBg p-3 rounded-xl" placeholder="é‡è¨“é …ç›®" value={data.workoutType || ''} onChange={e => onUpdate({workoutType: e.target.value})} />
                                </div>
                                <div className="relative">
                                    <input type="number" className="w-full bg-inputBg p-3 rounded-xl text-center" placeholder="åˆ†" value={data.workoutTime || ''} onChange={e => onUpdate({workoutTime: parseInt(e.target.value) || 0})} />
                                </div>
                            </div>
                            <div className="grid grid-cols-3 gap-2">
                                <div className="col-span-2">
                                    <input className="w-full bg-inputBg p-3 rounded-xl" placeholder="æœ‰æ°§é …ç›®" value={data.cardioType || ''} onChange={e => onUpdate({cardioType: e.target.value})} />
                                </div>
                                <div className="relative">
                                    <input type="number" className="w-full bg-inputBg p-3 rounded-xl text-center" placeholder="åˆ†" value={data.cardioTime || ''} onChange={e => onUpdate({cardioTime: parseInt(e.target.value) || 0})} />
                                </div>
                            </div>
                        </div>
                    </Card>
                    
                    {showFavModal && (
                        <div className="modal-overlay" onClick={()=>setShowFavModal(false)}>
                            <div className="bg-white p-6 rounded-2xl w-4/5 max-w-sm max-h-[80vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-primary mb-4">å¸¸ç”¨é¤é»</h3>
                                {favorites.length === 0 ? <p className="text-gray-400">é»æ“Šç´€éŒ„æ—çš„æ˜Ÿæ˜Ÿå¯åŠ å…¥å¸¸ç”¨</p> : (
                                    <ul className="space-y-2">
                                        {favorites.map((fav, i) => (
                                            <li key={i} onClick={() => { handleAdd(fav); setShowFavModal(false); }} className="bg-inputBg p-3 rounded-xl cursor-pointer hover:bg-gray-100 flex justify-between items-center">
                                                <span>{fav.name}</span>
                                                <span className="text-xs text-gray-500">{fav.calories} kcal</span>
                                            </li>
                                        ))}
                                    </ul>
                                )}
                                <button onClick={()=>setShowFavModal(false)} className="mt-4 w-full py-2 text-gray-500">é—œé–‰</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const HistoryPage = ({ user, historyData }) => {
            const downloadCSV = async () =>