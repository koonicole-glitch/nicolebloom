<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Nicole 2026 Health Log (MVP v1.2)</title>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22[http://www.w3.org/2000/svg%22](http://www.w3.org/2000/svg%22) viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ¿</text></svg>">
  <link rel="apple-touch-icon" href="[https://cdn-icons-png.flaticon.com/512/4322/4322991.png](https://cdn-icons-png.flaticon.com/512/4322/4322991.png)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#FFFBF5">

  <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bgMain: '#FFFBF5',
            cardBg: '#FFFFFF',
            primary: '#4A5D23',
            secondary: '#6B5E52',
            inputBg: '#F5F2EB',
            borderBeige: '#E8E4D9',
            danger: '#DC2626'
          },
          borderRadius: { 'xl': '14px', '2xl': '20px' }
        }
      }
    }
  </script>

  <script crossorigin src="[https://unpkg.com/react@18.2.0/umd/react.production.min.js](https://unpkg.com/react@18.2.0/umd/react.production.min.js)"></script>
  <script crossorigin src="[https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js](https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js)"></script>
  <script src="[https://unpkg.com/@babel/standalone/babel.min.js](https://unpkg.com/@babel/standalone/babel.min.js)"></script>
  <script src="[https://unpkg.com/prop-types@15.8.1/prop-types.min.js](https://unpkg.com/prop-types@15.8.1/prop-types.min.js)"></script>
  <script src="[https://unpkg.com/recharts@2.10.3/umd/Recharts.js](https://unpkg.com/recharts@2.10.3/umd/Recharts.js)"></script>

  <script src="[https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js](https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js)"></script>
  <script src="[https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js](https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js)"></script>
  <script src="[https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js](https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js)"></script>

  <link href="[https://fonts.googleapis.com/icon?family=Material+Icons](https://fonts.googleapis.com/icon?family=Material+Icons)" rel="stylesheet">

  <style>
    body { background-color: #FFFBF5; color: #4A5D23; font-family: system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
    input, select, button, textarea, p, span, div { font-size: 16px; }
    h1 { font-size: 24px; } h2 { font-size: 22px; } h3 { font-size: 18px; }
    .big-num { font-size: 40px; font-weight: 800; line-height: 1; }
    .card-shadow { box-shadow: 0 4px 12px rgba(74, 93, 35, 0.08); }
    input:focus, textarea:focus, select:focus { outline: 2px solid #4A5D23; background-color: #ffffff; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    
    /* è‡ªå®šç¾© Date Input æ¨£å¼ */
    input[type="date"]::-webkit-inner-spin-button,
    input[type="date"]::-webkit-calendar-picker-indicator {
        display: none;
        -webkit-appearance: none;
    }
    input[type="date"] {
      background: transparent;
      color: inherit;
      border: none;
      font-family: monospace;
      font-weight: bold;
      text-align: center;
      width: 110px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="root">
    <div style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #4A5D23;">
      <div style="font-size: 40px; margin-bottom: 20px;">ğŸŒ¿</div>
      <div>æ­£åœ¨å•Ÿå‹• Health Log (MVP v1.2)...</div>
      <div style="font-size: 12px; margin-top: 10px; color: #999;">å¦‚æœä¸€ç›´åœåœ¨é€™è£¡ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é‡æ–°æ•´ç†ã€‚</div>
    </div>
  </div>

  <script type="text/babel">
    // ----------------------------
    // 0) Firebase åˆå§‹åŒ–
    // ----------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyD6FsP4PtdeeD_uuIRnWbbLzsKwHlgS9cM",
      authDomain: "health-tracker-b37e4.firebaseapp.com",
      projectId: "health-tracker-b37e4",
      storageBucket: "health-tracker-b37e4.firebasestorage.app",
      messagingSenderId: "802888614022",
      appId: "1:802888614022:web:e7ec85eef3dfc088aed107"
    };

    if (typeof firebase !== 'undefined' && !firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const { useState, useEffect, useMemo, useCallback } = React;

    // ----------------------------
    // 1) å°å·¥å…·
    // ----------------------------
    const MEAL_CATEGORIES = { breakfast: 'æ—©é¤', lunch: 'åˆé¤', dinner: 'æ™šé¤', snack: 'é»å¿ƒ' };

    const getTodayString = () => {
      const d = new Date();
      const offset = d.getTimezoneOffset() * 60000;
      return new Date(d.getTime() - offset).toISOString().split('T')[0];
    };

    const shiftDate = (d, n) => {
      const dt = new Date(d + "T00:00:00");
      dt.setDate(dt.getDate() + n);
      const offset = dt.getTimezoneOffset() * 60000;
      return new Date(dt.getTime() - offset).toISOString().split('T')[0];
    };

    const formatDateTW = (d) => d ? d.replaceAll("-", "/") : "";

    const uuid = () => {
      if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
      return String(Date.now()) + "_" + String(Math.random()).slice(2);
    };

    const clampNum = (v, min=0) => {
      const n = Number(v);
      if (Number.isNaN(n)) return min;
      return n;
    };

    const safeText = (s) => (s == null ? "" : String(s)).trim();

    // ç”¨æ–¼å¿«å–éµå€¼
    const normalizeMealKey = (s) => safeText(s)
      .replace(/\u3000/g, " ")
      .replace(/\s+/g, " ")
      .trim()
      .toLowerCase();

    const numFromAny = (v) => {
      if (v == null) return NaN;
      if (typeof v === "number") return v;
      const m = String(v).match(/-?\d+(?:\.\d+)?/);
      return m ? Number(m[0]) : NaN;
    };

    let _aiWarnedOnce = false;

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    const csvEscape = (v) => {
      const s = v == null ? "" : String(v);
      if (/[",\n]/.test(s)) return '"' + s.replaceAll('"', '""') + '"';
      return s;
    };

    // ----------------------------
    // 2) UI å…ƒä»¶
    // ----------------------------
    const Card = ({ children, className = "", onClick }) => (
      <div onClick={onClick} className={`bg-cardBg rounded-2xl p-5 card-shadow border border-borderBeige ${className}`}>
        {children}
      </div>
    );

    const Button = ({ children, onClick, className = "", disabled=false, title }) => (
      <button title={title} onClick={onClick} disabled={disabled}
        className={`w-full py-4 rounded-xl font-bold text-lg text-white bg-primary shadow-lg active:scale-95 flex justify-center items-center gap-2 disabled:opacity-50 transition-all ${className}`}>
        {children}
      </button>
    );

    const SmallButton = ({ children, onClick, className = "", disabled=false, title }) => (
      <button title={title} onClick={onClick} disabled={disabled}
        className={`px-3 py-2 rounded-xl font-bold text-sm bg-primary text-white active:scale-95 disabled:opacity-50 transition-all ${className}`}>
        {children}
      </button>
    );

    const OutlineButton = ({ children, onClick, className = "", disabled=false, title }) => (
      <button title={title} onClick={onClick} disabled={disabled}
        className={`px-3 py-2 rounded-xl font-bold text-sm border border-primary text-primary bg-white active:scale-95 disabled:opacity-50 transition-all ${className}`}>
        {children}
      </button>
    );

    const InputGroup = ({ label, value, onChange, type="text", placeholder, rightHint }) => (
      <div>
        <label className="block text-secondary mb-1 font-bold flex justify-between text-sm">
          <span>{label}</span>
          {rightHint ? <span className="text-xs text-secondary/70">{rightHint}</span> : null}
        </label>
        <input type={type} value={value} onChange={onChange} placeholder={placeholder}
          className="w-full bg-inputBg rounded-xl p-3 text-primary font-bold border-none text-base focus:ring-2 focus:ring-primary/20" />
      </div>
    );

    const SectionTitle = ({ icon, title }) => (
      <h3 className="text-lg font-bold text-primary mb-3 flex items-center gap-2">
        <span className="material-icons text-xl">{icon}</span>{title}
      </h3>
    );

    const Tag = ({ children, className="" }) => (
      <span className={`px-2 py-1 rounded-full text-xs font-bold ${className}`}>{children}</span>
    );

    // ----------------------------
    // 3) AIï¼šé¤é»ç†±é‡/ç‡Ÿé¤Šç´ ä¼°ç®— (æ ¸å¿ƒä¿®å¾©å€)
    // ----------------------------
    const GEMINI_API_BASE = "[https://generativelanguage.googleapis.com](https://generativelanguage.googleapis.com)";
    const GEMINI_API_VERSION = "v1beta";
    const GEMINI_FALLBACK_MODEL = "gemini-2.0-flash";

    const fallbackAnalysis = (text) => {
      let c=0, p=0, cb=0, f=0;
      const t = (text || "").toLowerCase();
      // ç°¡æ˜“è¦å‰‡ä¼°ç®—
      if (t.includes('é›') || t.includes('è±¬') || t.includes('ç‰›') || t.includes('é­š')) { c+=220; p+=25; f+=12; }
      if (t.includes('è›‹')) { c+=75; p+=7; f+=5; }
      if (t.includes('é£¯') || t.includes('éºµ') || t.includes('ç²¥') || t.includes('åå¸') || t.includes('éºµåŒ…')) { c+=280; p+=6; cb+=55; }
      if (t.includes('æ²™æ‹‰') || t.includes('èœ') || t.includes('è”¬')) { c+=80; cb+=12; }
      if (t.includes('å¥¶') || t.includes('æ‹¿éµ') || t.includes('å„ªæ ¼')) { c+=140; p+=8; cb+=12; f+=6; }
      if (t.includes('é¦™è•‰') || t.includes('æœ')) { c+=90; cb+=23; }
      if (c===0 && t.length>0) c=200; // åŸºç¤å€¼
      return { name: text, calories: c, protein: p, carbs: cb, fat: f };
    };

    const geminiExtractText = (data) => {
      try {
        const parts = data?.candidates?.[0]?.content?.parts || [];
        const t = parts.map(p => {
          if (p?.text) return p.text;
          return "";
        }).join("").trim();
        if (t) return t;
        const raw = data?.candidates?.[0]?.content;
        if (typeof raw === "string") return raw.trim();
        return "";
      } catch { return ""; }
    };

    // å¼·åŒ–çš„ JSON è§£æå™¨ (Fix: è§£æ±º "AI å›å‚³ä¸æ˜¯å¯è§£æ JSON" çš„å•é¡Œ)
    const safeParseJsonFromText = (text) => {
      if (!text) return null;
      // 1. å»é™¤ BOM å’Œ Markdown code fence (```json ... ```)
      let t = String(text).trim().replace(/^\uFEFF/, "").replace(/```(?:json)?/gi, "").replace(/```/g, "").trim();
      
      const tryParse = (s) => { try { return JSON.parse(s); } catch { return null; } };

      // 2. ä½¿ç”¨æ‹¬è™Ÿå¹³è¡¡æ³•æŠ“å–çœŸæ­£çš„ JSON ç‰©ä»¶ (å¿½ç•¥å»¢è©±)
      const extractBalanced = (s, openCh, closeCh) => {
        const start = s.indexOf(openCh);
        if (start < 0) return null;
        let depth = 0, inStr = false;
        for (let i = start; i < s.length; i++) {
          const ch = s[i];
          // ç°¡å–®è™•ç†å­—ä¸²å…§çš„å¼•è™Ÿ
          if (inStr) { if (ch === '"' && s[i-1] !== '\\') inStr = false; continue; }
          if (ch === '"') { inStr = true; continue; }
          if (ch === openCh) depth++;
          if (ch === closeCh) depth--;
          if (depth === 0) return s.slice(start, i + 1);
        }
        return null;
      };

      let candidate = extractBalanced(t, "{", "}");
      if (!candidate) candidate = extractBalanced(t, "[", "]"); // è¬ä¸€å›å‚³é™£åˆ—
      if (candidate) t = candidate;

      let obj = tryParse(t);
      if (obj) return obj;

      // 3. å˜—è©¦ä¿®å¾©å¸¸è¦‹ JSON éŒ¯èª¤
      // çµå°¾é€—è™Ÿ
      let s = t.replace(/,\s*([}\]])/g, "$1");
      // Key æ²’åŠ å¼•è™Ÿ
      s = s.replace(/([{,]\s*)([A-Za-z_][A-Za-z0-9_]*)\s*:/g, '$1"$2":');
      // å–®å¼•è™Ÿè½‰é›™å¼•è™Ÿ
      s = s.replace(/'/g, '"');
      
      return tryParse(s);
    };

    const normalizeMealFromParsed = (parsed, fallbackName) => {
      const obj = (parsed && typeof parsed === "object") ? parsed : {};
      const pick = (...keys) => {
        for (const k of keys) if (Object.prototype.hasOwnProperty.call(obj, k) && obj[k] != null) return obj[k];
        return undefined;
      };

      const name = safeText(pick("name","meal","food","item","é¤é»","é¤é»åç¨±")) || fallbackName;
      const calories = clampNum(numFromAny(pick("calories","kcal","calorie","ç†±é‡")), 0);
      const protein  = clampNum(numFromAny(pick("protein","p","prot","è›‹ç™½è³ª")), 0);
      const carbs    = clampNum(numFromAny(pick("carbs","carb","c","ç¢³æ°´","ç¢³æ°´åŒ–åˆç‰©")), 0);
      const fat      = clampNum(numFromAny(pick("fat","f","è„‚è‚ª")), 0);
      return { name, calories, protein, carbs, fat };
    };

    const getCachedMeal = (key) => {
      try {
        const raw = localStorage.getItem("healthlog_meal_cache_v1");
        if (!raw) return null;
        return JSON.parse(raw)[key] || null;
      } catch { return null; }
    };

    const setCachedMeal = (key, value) => {
      try {
        const raw = localStorage.getItem("healthlog_meal_cache_v1");
        const obj = raw ? JSON.parse(raw) : {};
        obj[key] = value;
        const keys = Object.keys(obj);
        if (keys.length > 80) { // Limit cache size
          const keep = keys.slice(keys.length - 80);
          const next = {};
          keep.forEach(k => next[k] = obj[k]);
          localStorage.setItem("healthlog_meal_cache_v1", JSON.stringify(next));
        } else {
          localStorage.setItem("healthlog_meal_cache_v1", JSON.stringify(obj));
        }
      } catch {}
    };

    const pickGeminiModel = async (apiKey) => {
      const cacheKey = "healthlog_gemini_model_v1";
      try {
        const cached = JSON.parse(localStorage.getItem(cacheKey) || "null");
        if (cached && cached.model && (Date.now() - cached.ts < 24*60*60*1000)) return cached.model;
      } catch {}
      try {
        const res = await fetch(`${GEMINI_API_BASE}/${GEMINI_API_VERSION}/models?key=${encodeURIComponent(apiKey)}`);
        if (!res.ok) throw new Error("listModels error");
        const data = await res.json();
        const models = data?.models || [];
        const candidate = models.find(m => (m.name||"").includes("flash") && (m.supportedGenerationMethods||[]).includes("generateContent"));
        const picked = candidate?.name ? candidate.name.replace(/^models\//, "") : GEMINI_FALLBACK_MODEL;
        localStorage.setItem(cacheKey, JSON.stringify({ model: picked, ts: Date.now() }));
        return picked;
      } catch { return GEMINI_FALLBACK_MODEL; }
    };

    const analyzeMealWithGemini = async (input, apiKey) => {
      const text = safeText(input);
      if (!text) return null;
      const cacheKey = normalizeMealKey(text);
      const cached = getCachedMeal(cacheKey);
      if (cached) return cached;

      const model = await pickGeminiModel(apiKey);
      const endpoint = `${GEMINI_API_BASE}/${GEMINI_API_VERSION}/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`;
      
      // Prompt å„ªåŒ–ï¼šå¼·èª¿ "JSON Only"
      const prompt = `ä½ æ˜¯ä¸€ä½å°ç£ç‡Ÿé¤Šå¸«ï¼Œè«‹ä¼°ç®—ã€Œ${text}ã€çš„ç†±é‡èˆ‡ç‡Ÿé¤Šç´ ã€‚å›å‚³JSONæ ¼å¼:{"name":string, "calories":number, "protein":number, "carbs":number, "fat":number}ã€‚ä¸è¦Markdownï¼Œä¸è¦è§£é‡‹ã€‚`;

      for (let attempt=0; attempt<3; attempt++) {
        try {
          // ç­–ç•¥ 1: ä½¿ç”¨ responseSchema (å¼·åˆ¶çµæ§‹åŒ–è¼¸å‡ºï¼Œæœ€ç©©)
          const payloadWithSchema = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
              temperature: 0.2, 
              maxOutputTokens: 256, 
              responseMimeType: "application/json",
              responseSchema: { 
                type: "OBJECT", 
                properties: { 
                  name: {type:"STRING"}, 
                  calories: {type:"NUMBER"}, 
                  protein: {type:"NUMBER"}, 
                  carbs: {type:"NUMBER"}, 
                  fat: {type:"NUMBER"} 
                }, 
                required: ["name","calories","protein","carbs","fat"] 
              }
            }
          };
          
          // ç­–ç•¥ 2: ä¸€èˆ¬æ¨¡å¼ (Fallbackï¼Œè¬ä¸€æ¨¡å‹ä¸æ”¯æ´ Schema)
          const payloadNoSchema = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.2, maxOutputTokens: 256 } };

          let res = await fetch(endpoint, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payloadWithSchema) });
          
          // è‹¥ä¸æ”¯æ´ Schema (400 Bad Request)ï¼Œè‡ªå‹•é™ç´šä½¿ç”¨ä¸€èˆ¬æ¨¡å¼
          if (!res.ok && res.status === 400) {
             res = await fetch(endpoint, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payloadNoSchema) });
          }

          if (res.status === 429 && attempt < 2) { await sleep(1000 * (attempt + 1)); continue; }
          if (!res.ok) throw new Error("Gemini API Error " + res.status);

          const data = await res.json();
          const t = geminiExtractText(data);
          
          // ä½¿ç”¨å¼·åŒ–çš„è§£æå™¨
          const parsed = safeParseJsonFromText(t);
          if (!parsed) throw new Error("Parse Error");
          
          const out = normalizeMealFromParsed(parsed, text);
          setCachedMeal(cacheKey, out);
          return out;
        } catch (e) {
          if (attempt === 2) throw e;
        }
      }
      return null;
    };

    // ----------------------------
    // 4) ä¸»è¦é é¢ Component
    // ----------------------------
    const computeMealTotals = (meals=[]) => {
      const t = { cal: 0, pro: 0, carb: 0, fat: 0 };
      (meals || []).forEach(m => {
        t.cal += clampNum(m.calories, 0);
        t.pro += clampNum(m.protein, 0);
        t.carb += clampNum(m.carbs, 0);
        t.fat += clampNum(m.fat, 0);
      });
      return t;
    };

    const mealsToTextByCategory = (meals=[], category) => {
      const arr = (meals || []).filter(m => (m.category || "snack") === category);
      const texts = arr.map(m => safeText(m.text) || safeText(m.name)).filter(Boolean);
      return texts.length ? texts.join("ã€") : "-";
    };

    const formatCardio = (d) => {
      const min = clampNum(d?.cardioTime, 0);
      const type = safeText(d?.cardioType);
      if (!min && !type) return "-";
      return `${min}åˆ†é˜ ${type}`.trim();
    };

    const formatWorkout = (d) => {
      const min = clampNum(d?.workoutTime, 0);
      const type = safeText(d?.workoutType);
      if (!min && !type) return "-";
      if (min >= 60 && min % 60 === 0) return `${type} ${min/60} å°æ™‚`.trim();
      return `${type} ${min} åˆ†é˜`.trim();
    };

    const buildCoachReport = ({ date, today, prev }) => {
      const prevTotals = computeMealTotals(prev?.meals || []);
      return [
        `âœ… è¨˜éŒ„æ—¥æœŸï¼š${formatDateTW(date)}`,
        `âœ… ä»Šæ—¥ç©ºè…¹é«”é‡ï¼š${safeText(today?.weight) || "-"}`,
        `âœ… ä»Šæ—¥æ—©èµ·ç–²å‹åº¦ï¼š${today?.fatigue ? `${today.fatigue}/10` : "-"}`,
        `âœ… å‰ä¸€æ—¥ç¡çœ æ™‚é•·ï¼š${safeText(today?.sleep) ? `${today.sleep} hrs` : "-"}`,
        `âœ… å‰ä¸€æ—¥å–æ°´é‡ï¼š${clampNum(prev?.water, 0)} ml`,
        `âœ… å‰ä¸€æ—¥èµ°è·¯æ­¥æ•¸ï¼š${clampNum(prev?.steps, 0)} æ­¥`,
        `âœ… å‰ä¸€æ—¥æœ‰æ°§æ™‚é•·ï¼š${formatCardio(prev)}`,
        `âœ… å‰ä¸€æ—¥ç†±é‡æ”å–ï¼š${Math.round(prevTotals.cal)} kcal`,
        ``,
        `ğŸ½ é£²é£Ÿè¨˜éŒ„ï¼š`,
        `æ—©é¤ï¼š${mealsToTextByCategory(prev?.meals || [], "breakfast")}`,
        `åˆé¤ï¼š${mealsToTextByCategory(prev?.meals || [], "lunch")}`,
        `æ™šé¤ï¼š${mealsToTextByCategory(prev?.meals || [], "dinner")}`,
        `é»å¿ƒï¼š${mealsToTextByCategory(prev?.meals || [], "snack")}`,
        ``,
        `ğŸ¯ å‰ä¸€æ—¥é‹å‹•é …ç›®ï¼š`,
        `${formatWorkout(prev)}`
      ].join("\n");
    };

    // --- Page: Dashboard ---
    const DashboardPage = ({ date, data, targets, totals, onQuickAdd, onCopyCoachReport, coachPreview }) => {
      const isWorkoutDay = clampNum(data.workoutTime, 0) >= 30;
      const currentTargets = isWorkoutDay ? targets.workout : targets.rest;
      const remainingCal = clampNum(currentTargets.calories, 0) - totals.cal;

      return (
        <div className="space-y-6 pb-24">
          <Card className="bg-primary text-white border-none relative overflow-hidden">
             <div className="absolute top-0 right-0 p-4 opacity-10 text-6xl">ğŸŒ¿</div>
            <div className="flex justify-between items-start mb-4 relative z-10">
              <div>
                <div className="text-white/80 text-lg">ä»Šæ—¥ç¸½è¦½</div>
                <div className="big-num">{Math.round(remainingCal)}</div>
                <div className="text-white/70 text-sm">kcal å‰©é¤˜</div>
              </div>
              <div className="text-right">
                <div className={"px-3 py-1 rounded-full text-sm font-bold inline-block mb-1 " + (isWorkoutDay ? "bg-orange-400 text-white" : "bg-white/20")}>
                  {isWorkoutDay ? "ğŸ”¥ é‹å‹•æ—¥" : "â˜• ä¼‘æ¯æ—¥"}
                </div>
                <div className="text-white/80 text-sm">æ”å– {Math.round(totals.cal)} / {currentTargets.calories}</div>
              </div>
            </div>
            <div className="grid grid-cols-3 gap-2 mt-4 relative z-10">
              <div className="bg-white/10 p-2 rounded-lg text-center backdrop-blur-sm">
                <div className="text-xs opacity-70">è›‹ç™½è³ª</div>
                <div className="font-bold">{Math.round(totals.pro)}/{currentTargets.protein}</div>
              </div>
              <div className="bg-white/10 p-2 rounded-lg text-center backdrop-blur-sm">
                <div className="text-xs opacity-70">ç¢³æ°´</div>
                <div className="font-bold">{Math.round(totals.carb)}/{currentTargets.carbs}</div>
              </div>
              <div className="bg-white/10 p-2 rounded-lg text-center backdrop-blur-sm">
                <div className="text-xs opacity-70">è„‚è‚ª</div>
                <div className="font-bold">{Math.round(totals.fat)}/{currentTargets.fat}</div>
              </div>
            </div>
          </Card>

          <div className="grid grid-cols-2 gap-4">
            <Card className="relative overflow-hidden">
              <div className="absolute right-[-10px] bottom-[-10px] opacity-10"><span className="material-icons text-8xl">water_drop</span></div>
              <div className="flex justify-between items-center relative z-10">
                <div>
                  <div className="text-secondary font-bold text-sm">å–æ°´</div>
                  <div className="text-2xl font-extrabold text-primary">{clampNum(data.water, 0)}</div>
                  <div className="text-xs text-secondary/70">/ {targets.water}</div>
                </div>
                <SmallButton onClick={() => onQuickAdd("water", 250)} title="å¿«é€Ÿ +250ml">+250</SmallButton>
              </div>
            </Card>

            <Card className="relative overflow-hidden">
              <div className="absolute right-[-10px] bottom-[-10px] opacity-10"><span className="material-icons text-8xl">directions_walk</span></div>
              <div className="flex justify-between items-center relative z-10">
                <div>
                  <div className="text-secondary font-bold text-sm">æ­¥æ•¸</div>
                  <div className="text-2xl font-extrabold text-primary">{clampNum(data.steps, 0)}</div>
                  <div className="text-xs text-secondary/70">/ {targets.steps}</div>
                </div>
                <SmallButton onClick={() => onQuickAdd("steps", 500)} title="å¿«é€Ÿ +500æ­¥">+500</SmallButton>
              </div>
            </Card>
          </div>

          <Card>
            <SectionTitle icon="insights" title="æ•™ç·´å›å ±" />
            <div className="text-sm text-secondary whitespace-pre-wrap bg-inputBg rounded-xl p-4 border border-borderBeige font-mono leading-relaxed">
              {coachPreview || "ï¼ˆç›®å‰é‚„æ²’æœ‰è³‡æ–™ï¼‰"}
            </div>
            <div className="mt-4">
              <Button onClick={onCopyCoachReport}>
                <span className="material-icons">content_copy</span>
                è¤‡è£½æ•™ç·´å›å ±
              </Button>
            </div>
          </Card>
        </div>
      );
    };

    // --- Page: Log ---
    const LogPage = ({ date, data, targets, apiKey, presets, onUpdate, onAddMeal, onDeleteMeal, onSavePreset }) => {
      const [selectedCategory, setSelectedCategory] = useState("breakfast");
      const [mealInput, setMealInput] = useState("");
      const [analyzing, setAnalyzing] = useState(false);
      const [manualMode, setManualMode] = useState(false);
      const [manualMeal, setManualMeal] = useState({ name: "", calories: "", protein: "", carbs: "", fat: "" });
      const [selectedPresetId, setSelectedPresetId] = useState("");

      useEffect(() => {
        const hour = new Date().getHours();
        if (hour >= 5 && hour < 11) setSelectedCategory("breakfast");
        else if (hour >= 11 && hour < 15) setSelectedCategory("lunch");
        else if (hour >= 17 && hour < 21) setSelectedCategory("dinner");
        else setSelectedCategory("snack");
      }, []);

      const mealsByCat = useMemo(() => {
        const g = { breakfast: [], lunch: [], dinner: [], snack: [] };
        (data.meals || []).forEach(m => {
          const c = m.category || "snack";
          if (g[c]) g[c].push(m);
        });
        Object.keys(g).forEach(k => g[k].sort((a,b) => (b.createdAtMs||0) - (a.createdAtMs||0)));
        return g;
      }, [data.meals]);

      const analyzeAndAdd = async () => {
        if (manualMode) {
          const meal = {
            id: uuid(), category: selectedCategory,
            name: safeText(manualMeal.name) || "è‡ªè¨‚", text: safeText(manualMeal.name) || "è‡ªè¨‚",
            calories: clampNum(manualMeal.calories, 0), protein: clampNum(manualMeal.protein, 0),
            carbs: clampNum(manualMeal.carbs, 0), fat: clampNum(manualMeal.fat, 0),
            createdAtMs: Date.now()
          };
          onAddMeal(meal);
          setManualMeal({ name: "", calories: "", protein: "", carbs: "", fat: "" });
          setManualMode(false);
          return;
        }

        if (selectedPresetId) {
          const p = (presets || []).find(x => x.id === selectedPresetId);
          if (p) {
            onAddMeal({
              id: uuid(), category: selectedCategory,
              name: p.label || p.name || "å¸¸ç”¨é¤é»", text: p.text || p.label || p.name || "å¸¸ç”¨é¤é»",
              calories: clampNum(p.calories, 0), protein: clampNum(p.protein, 0),
              carbs: clampNum(p.carbs, 0), fat: clampNum(p.fat, 0),
              createdAtMs: Date.now(), source: "preset"
            });
            setSelectedPresetId("");
            return;
          }
        }

        const input = safeText(mealInput);
        if (!input) return;

        setAnalyzing(true);
        try {
          let analyzed = null;
          if (safeText(apiKey)) {
            analyzed = await analyzeMealWithGemini(input, apiKey);
          }
          if (!analyzed) analyzed = fallbackAnalysis(input);
          
          // è‹¥ AI åˆ†ææˆåŠŸï¼Œä¸€æ¨£è¦å¿«å–
          setCachedMeal(normalizeMealKey(input), analyzed);

          onAddMeal({
            id: uuid(), category: selectedCategory,
            name: analyzed.name || input, text: input,
            calories: clampNum(analyzed.calories, 0), protein: clampNum(analyzed.protein, 0),
            carbs: clampNum(analyzed.carbs, 0), fat: clampNum(analyzed.fat, 0),
            createdAtMs: Date.now(), source: safeText(apiKey) ? "gemini" : "fallback"
          });
          setMealInput("");
        } catch (e) {
          if (!_aiWarnedOnce) {
            _aiWarnedOnce = true;
            alert("AI åˆ†æå¤±æ•—ï¼š\n" + (e?.message || String(e)) + "\n\nå·²æ”¹ç”¨ä¼°ç®—æ¨¡å¼åŠ å…¥ã€‚");
          }
          const analyzed = fallbackAnalysis(input);
          setCachedMeal(normalizeMealKey(input), analyzed);
          onAddMeal({
            id: uuid(), category: selectedCategory,
            name: analyzed.name || input, text: input,
            calories: clampNum(analyzed.calories, 0), protein: clampNum(analyzed.protein, 0),
            carbs: clampNum(analyzed.carbs, 0), fat: clampNum(analyzed.fat, 0),
            createdAtMs: Date.now(), source: "fallback"
          });
          setMealInput("");
        } finally {
          setAnalyzing(false);
        }
      };

      const presetOptions = useMemo(() => {
        return (presets || []).filter(p => (p.category || "snack") === selectedCategory);
      }, [presets, selectedCategory]);

      return (
        <div className="space-y-6 pb-24">
          <Card>
            <SectionTitle icon="accessibility" title="èº«é«”èˆ‡ç‹€æ…‹" />
            <div className="grid grid-cols-2 gap-4">
              <InputGroup label="é«”é‡ (kg)" type="number" value={data.weight || ""} onChange={e => onUpdate({ weight: e.target.value })} placeholder="60.0" />
              <InputGroup label="ç¡çœ  (hr)" type="number" value={data.sleep || ""} onChange={e => onUpdate({ sleep: e.target.value })} placeholder="7" />
            </div>
            <div className="mt-4">
              <label className="block text-secondary mb-2 font-bold flex justify-between text-sm">
                <span>ç–²å‹åº¦ (1-10)</span><span className="text-primary font-bold">{data.fatigue || 5}</span>
              </label>
              <input type="range" min="1" max="10" value={data.fatigue || 5}
                onChange={e => onUpdate({ fatigue: parseInt(e.target.value, 10) })}
                className="w-full h-3 bg-inputBg rounded-lg appearance-none cursor-pointer accent-primary" />
            </div>
          </Card>

          <Card>
            <SectionTitle icon="fitness_center" title="é‹å‹•èˆ‡æ´»å‹•" />
            <div className="grid grid-cols-2 gap-4">
              <InputGroup label="å–æ°´ (ml)" type="number" value={data.water || 0} onChange={e => onUpdate({ water: parseInt(e.target.value || "0", 10) })} />
              <InputGroup label="æ­¥æ•¸" type="number" value={data.steps || 0} onChange={e => onUpdate({ steps: parseInt(e.target.value || "0", 10) })} />
            </div>

            <div className="grid grid-cols-2 gap-4 mt-4">
              <InputGroup label="æœ‰æ°§é¡å‹" value={data.cardioType || ""} onChange={e => onUpdate({ cardioType: e.target.value })} placeholder="ç„¡" />
              <InputGroup label="æœ‰æ°§åˆ†é˜" type="number" value={data.cardioTime || 0} onChange={e => onUpdate({ cardioTime: parseInt(e.target.value || "0", 10) })} />
            </div>

            <div className="grid grid-cols-2 gap-4 mt-4">
              <InputGroup label="é‡è¨“/é‹å‹•" value={data.workoutType || ""} onChange={e => onUpdate({ workoutType: e.target.value })} placeholder="ç„¡" />
              <InputGroup label="é‡è¨“åˆ†é˜" type="number" value={data.workoutTime || 0} onChange={e => onUpdate({ workoutTime: parseInt(e.target.value || "0", 10) })} />
            </div>
          </Card>

          <Card>
            <SectionTitle icon="restaurant" title="é£²é£Ÿç´€éŒ„" />

            <div className="flex bg-inputBg rounded-xl p-1 mb-4 overflow-x-auto">
              {Object.entries(MEAL_CATEGORIES).map(([key, label]) => (
                <button key={key} onClick={() => { setSelectedCategory(key); setSelectedPresetId(""); }}
                  className={"flex-1 py-2 px-2 rounded-lg font-bold text-sm whitespace-nowrap transition-all " + (selectedCategory === key ? "bg-white text-primary shadow" : "text-secondary")}>
                  {label}
                </button>
              ))}
            </div>

            <div className="grid grid-cols-3 gap-2 mb-3">
              <select className="col-span-2 bg-inputBg rounded-xl p-3 font-bold text-primary text-base"
                value={selectedPresetId} onChange={e => setSelectedPresetId(e.target.value)}>
                <option value="">ï¼ˆå¸¸ç”¨é¤é»ï¼‰</option>
                {presetOptions.map(p => (
                  <option key={p.id} value={p.id}>{p.label || p.name}</option>
                ))}
              </select>
              <OutlineButton onClick={() => setManualMode(v => !v)} title="åˆ‡æ›æ‰‹å‹•è¼¸å…¥ç‡Ÿé¤Šç´ ">
                <span className="material-icons text-base align-middle">tune</span> æ‰‹å‹•
              </OutlineButton>
            </div>

            {!manualMode ? (
              <div className="flex gap-2">
                <input value={mealInput} onChange={e => setMealInput(e.target.value)}
                  placeholder="ä¾‹å¦‚ï¼šé›èƒ¸è‚‰ 100g"
                  className="flex-1 bg-inputBg p-3 rounded-xl font-bold text-primary"
                  onKeyDown={e => e.key === "Enter" && analyzeAndAdd()} />
                <SmallButton onClick={analyzeAndAdd} disabled={analyzing} title={apiKey ? "ç”¨ AI ä¼°ç®—åŠ å…¥" : "ç”¨ç°¡å–®ä¼°ç®—åŠ å…¥"}>
                  {analyzing ? "..." : "+"}
                </SmallButton>
              </div>
            ) : (
              <div className="space-y-3 bg-inputBg/50 p-3 rounded-xl">
                <InputGroup label="åç¨±" value={manualMeal.name} onChange={e => setManualMeal({...manualMeal, name: e.target.value})} />
                <div className="grid grid-cols-4 gap-2">
                  <InputGroup label="ç†±é‡" type="number" value={manualMeal.calories} onChange={e => setManualMeal({...manualMeal, calories: e.target.value})} placeholder="0" />
                  <InputGroup label="P" type="number" value={manualMeal.protein} onChange={e => setManualMeal({...manualMeal, protein: e.target.value})} placeholder="0" />
                  <InputGroup label="C" type="number" value={manualMeal.carbs} onChange={e => setManualMeal({...manualMeal, carbs: e.target.value})} placeholder="0" />
                  <InputGroup label="F" type="number" value={manualMeal.fat} onChange={e => setManualMeal({...manualMeal, fat: e.target.value})} placeholder="0" />
                </div>
                <Button onClick={analyzeAndAdd}><span className="material-icons">add</span>åŠ å…¥ï¼ˆæ‰‹å‹•ï¼‰</Button>
              </div>
            )}

            <div className="mt-6 space-y-4">
              {Object.keys(MEAL_CATEGORIES).map(cat => (
                <div key={cat}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="font-bold text-secondary text-sm">{MEAL_CATEGORIES[cat]}</div>
                    <Tag className="bg-inputBg text-secondary">{(mealsByCat[cat] || []).length} ç­†</Tag>
                  </div>
                  <div className="space-y-2">
                    {(mealsByCat[cat] || []).map(m => (
                      <div key={m.id} className="flex justify-between items-center bg-white p-3 rounded-xl border border-borderBeige shadow-sm">
                        <div className="min-w-0 pr-2">
                          <div className="font-bold text-primary truncate">{m.name || m.text}</div>
                          <div className="text-xs text-secondary/80 mt-1">
                            {Math.round(clampNum(m.calories,0))} kcal (P{Math.round(clampNum(m.protein,0))} C{Math.round(clampNum(m.carbs,0))} F{Math.round(clampNum(m.fat,0))})
                          </div>
                        </div>
                        <div className="flex items-center gap-1">
                          <button title="å­˜æˆå¸¸ç”¨é¤é»" onClick={() => onSavePreset(m)} className="p-2 material-icons text-primary/70 hover:text-primary">star_outline</button>
                          <button title="åˆªé™¤" onClick={() => onDeleteMeal(m.id)} className="p-2 material-icons text-red-400 hover:text-red-600">delete</button>
                        </div>
                      </div>
                    ))}
                    {(mealsByCat[cat] || []).length === 0 ? <div className="text-center text-secondary/30 py-2 text-xs">ï¼ˆå°šç„¡ç´€éŒ„ï¼‰</div> : null}
                  </div>
                </div>
              ))}
            </div>
          </Card>
          <div className="text-xs text-secondary/70 text-center">
            è‹¥è¦ºå¾— AI ä¼°ç®—ä¸æº–ï¼Œå¯åˆ‡æ›ã€Œæ‰‹å‹•ã€è‡ªè¡Œè¼¸å…¥ã€‚
          </div>
        </div>
      );
    };

    // --- Page: Settings ---
    const SettingsPage = ({ syncId, localSyncId, setLocalSyncId, targets, setTargets, apiKey, setApiKey, presets, onDeletePreset, onSaveAll }) => {
      return (
        <div className="space-y-6 pb-24">
          <Card>
            <SectionTitle icon="link" title="è·¨è£ç½®åŒæ­¥" />
            <div className="text-sm text-secondary mb-3">
              è«‹åœ¨æ‰€æœ‰è£ç½®è¼¸å…¥ç›¸åŒçš„åŒæ­¥ä»£è™Ÿã€‚
              <br/>âš ï¸ è«‹å‹¿å¤–æµï¼Œé€™æ˜¯æ‚¨çš„è³‡æ–™é‘°åŒ™ã€‚
            </div>
            <InputGroup
              label="åŒæ­¥ä»£è™Ÿ"
              value={localSyncId}
              onChange={e => setLocalSyncId(e.target.value)}
              placeholder="ä¾‹å¦‚ï¼šnicole-2026"
              rightHint={"ç›®å‰ï¼š" + (syncId || "-")}
            />
            <div className="mt-4">
              <Button onClick={onSaveAll}><span className="material-icons">save</span>å„²å­˜è¨­å®š</Button>
            </div>
          </Card>

          <Card>
            <SectionTitle icon="key" title="Gemini API Key" />
            <div className="text-sm text-secondary mb-3">
              åªå­˜æ–¼æ­¤è£ç½®ï¼Œä¸å¾ Firebase åŒæ­¥ã€‚ä¸å¡«å‰‡ä½¿ç”¨ç°¡æ˜“è¦å‰‡ä¼°ç®—ã€‚
            </div>
            <InputGroup label="API Key" type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="AIzaSy..." />
          </Card>

          <Card>
            <SectionTitle icon="flag" title="ç‡Ÿé¤Šç›®æ¨™" />
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-3">
                <div className="font-bold text-secondary text-sm">â˜• ä¼‘æ¯æ—¥</div>
                <InputGroup label="ç†±é‡" type="number" value={targets.rest.calories} onChange={e => setTargets({...targets, rest:{...targets.rest, calories: parseInt(e.target.value||"0",10)}})} />
                <InputGroup label="P" type="number" value={targets.rest.protein} onChange={e => setTargets({...targets, rest:{...targets.rest, protein: parseInt(e.target.value||"0",10)}})} />
                <InputGroup label="C" type="number" value={targets.rest.carbs} onChange={e => setTargets({...targets, rest:{...targets.rest, carbs: parseInt(e.target.value||"0",10)}})} />
                <InputGroup label="F" type="number" value={targets.rest.fat} onChange={e => setTargets({...targets, rest:{...targets.rest, fat: parseInt(e.target.value||"0",10)}})} />
              </div>
              <div className="space-y-3">
                <div className="font-bold text-secondary text-sm">ğŸ”¥ é‹å‹•æ—¥</div>
                <InputGroup label="ç†±é‡" type="number" value={targets.workout.calories} onChange={e => setTargets({...targets, workout:{...targets.workout, calories: parseInt(e.target.value||"0",10)}})} />
                <InputGroup label="P" type="number" value={targets.workout.protein} onChange={e => setTargets({...targets, workout:{...targets.workout, protein: parseInt(e.target.value||"0",10)}})} />
                <InputGroup label="C" type="number" value={targets.workout.carbs} onChange={e => setTargets({...targets, workout:{...targets.workout, carbs: parseInt(e.target.value||"0",10)}})} />
                <InputGroup label="F" type="number" value={targets.workout.fat} onChange={e => setTargets({...targets, workout:{...targets.workout, fat: parseInt(e.target.value||"0",10)}})} />
              </div>
            </div>
          </Card>

          <Card>
            <SectionTitle icon="star" title="å¸¸ç”¨é¤é»ç®¡ç†" />
            <div className="space-y-2">
              {(presets || []).length ? presets.map(p => (
                <div key={p.id} className="flex justify-between items-center bg-white p-3 rounded-xl border border-borderBeige">
                  <div className="min-w-0 pr-2">
                    <div className="font-bold text-primary truncate">{p.label || p.name}</div>
                    <div className="text-xs text-secondary/70">
                      {Math.round(clampNum(p.calories,0))} kcal
                    </div>
                  </div>
                  <button className="p-2 material-icons text-red-400 hover:text-red-600" onClick={() => onDeletePreset(p.id)}>delete</button>
                </div>
              )) : (
                <div className="text-center text-secondary/50 py-4 text-xs">ï¼ˆç›®å‰é‚„æ²’æœ‰å¸¸ç”¨é¤é»ï¼‰</div>
              )}
            </div>
          </Card>
        </div>
      );
    };

    // --- Page: History ---
    const HistoryPage = ({ history, onExportCsv }) => {
      const { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid } = Recharts;
      return (
        <div className="space-y-6 pb-24">
          <Card>
            <SectionTitle icon="show_chart" title="é«”é‡è¶¨å‹¢" />
            {history.length ? (
              <div style={{ width: "100%", height: 260 }}>
                <ResponsiveContainer>
                  <LineChart data={history}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="date" tick={{ fontSize: 12 }} />
                    <YAxis tick={{ fontSize: 12 }} domain={['dataMin - 1', 'dataMax + 1']} />
                    <Tooltip />
                    <Line type="monotone" dataKey="weight" stroke="#4A5D23" strokeWidth={3} dot={false} />
                  </LineChart>
                </ResponsiveContainer>
              </div>
            ) : (
              <div className="text-center text-secondary/50 py-10">ï¼ˆé‚„æ²’æœ‰é«”é‡ç´€éŒ„ï¼‰</div>
            )}
          </Card>
          <Card>
            <SectionTitle icon="download" title="åŒ¯å‡ºè³‡æ–™" />
            <div className="text-sm text-secondary mb-4">
              ä¸‹è¼‰ CSV å¯ç”¨æ–¼ Excel åˆ†ææˆ–å‚™ä»½ã€‚æ ¼å¼å·²å°é½Šæ•™ç·´å›å ±ã€‚
            </div>
            <Button onClick={onExportCsv}><span className="material-icons">download</span>ä¸‹è¼‰ CSV</Button>
          </Card>
        </div>
      );
    };

    // ----------------------------
    // 5) Appï¼šè³‡æ–™è®€å¯«èˆ‡è·¯ç”±
    // ----------------------------
    const DEFAULT_TARGETS = {
      rest: { calories: 1600, protein: 100, carbs: 150, fat: 50 },
      workout: { calories: 2000, protein: 150, carbs: 200, fat: 60 },
      water: 2000, steps: 8000
    };
    const DEFAULT_DAY = {
      weight: "", sleep: "", fatigue: 5, water: 0, steps: 0,
      workoutType: "", workoutTime: 0, cardioType: "", cardioTime: 0, meals: []
    };

    const App = () => {
      const [user, setUser] = useState(null);
      const [syncId, setSyncId] = useState("");
      const [localSyncId, setLocalSyncId] = useState("");
      const [permissionError, setPermissionError] = useState(false);
      const [view, setView] = useState("dashboard");
      const [date, setDate] = useState(getTodayString());
      const [data, setData] = useState(DEFAULT_DAY);
      const [prevData, setPrevData] = useState(DEFAULT_DAY);
      const [targets, setTargets] = useState(DEFAULT_TARGETS);
      const [presets, setPresets] = useState([]);
      const [apiKey, setApiKey] = useState(localStorage.getItem("healthlog_gemini_key") || "");
      const [loading, setLoading] = useState(true);
      const [history, setHistory] = useState([]);

      const baseUserPath = useMemo(() => {
        if (!syncId) return "";
        return `artifacts/health-tracker-v1/users/${syncId}`;
      }, [syncId]);

      const dayDocRef = useCallback((d) => {
        if (!baseUserPath) return null;
        return db.doc(`${baseUserPath}/daily_logs/${d}`);
      }, [baseUserPath]);

      const settingsRef = useMemo(() => {
        if (!baseUserPath) return null;
        return db.doc(`${baseUserPath}/settings/config`);
      }, [baseUserPath]);

      useEffect(() => {
        const unsub = auth.onAuthStateChanged(async (u) => {
          if (u) {
            setUser(u);
            const s = localStorage.getItem("health_log_sync_id");
            const id = (s && s.trim()) ? s.trim() : u.uid;
            setSyncId(id); setLocalSyncId(id);
          } else {
            auth.signInAnonymously().catch(console.error);
          }
        });
        return () => unsub();
      }, []);

      useEffect(() => { localStorage.setItem("healthlog_gemini_key", apiKey || ""); }, [apiKey]);

      useEffect(() => {
        if (!settingsRef) return;
        let unsub = () => {};
        (async () => {
          unsub = settingsRef.onSnapshot((doc) => {
            if (doc.exists) {
              const d = doc.data() || {};
              if (d.targets && d.targets.workout && d.targets.rest) setTargets(d.targets);
              if (Array.isArray(d.presets)) setPresets(d.presets);
            }
            setPermissionError(false);
          }, (e) => {
            if (e.code === "permission-denied") setPermissionError(true);
          });
        })();
        return () => unsub();
      }, [settingsRef]);

      useEffect(() => {
        if (!syncId) return;
        setLoading(true); setPermissionError(false);
        const todayRef = dayDocRef(date);
        const prevRef = dayDocRef(shiftDate(date, -1));
        if (!todayRef || !prevRef) return;

        const unsubToday = todayRef.onSnapshot((doc) => {
          if (doc.exists) setData({ ...DEFAULT_DAY, ...doc.data() });
          else setData(DEFAULT_DAY);
          setLoading(false);
        }, (e) => {
          if (e.code === "permission-denied") setPermissionError(true);
          setLoading(false);
        });

        const unsubPrev = prevRef.onSnapshot((doc) => {
          if (doc.exists) setPrevData({ ...DEFAULT_DAY, ...doc.data() });
          else setPrevData(DEFAULT_DAY);
        }, (e) => { if (e.code === "permission-denied") setPermissionError(true); });

        return () => { unsubToday(); unsubPrev(); };
      }, [date, syncId, dayDocRef]);

      const loadHistory = useCallback(async () => {
        if (!baseUserPath) return;
        try {
          const col = db.collection(`${baseUserPath}/daily_logs`);
          const q = col.orderBy(firebase.firestore.FieldPath.documentId(), "asc").limit(400);
          const snap = await q.get();
          const list = [];
          snap.forEach(doc => {
            const w = Number(doc.data()?.weight);
            if (!Number.isNaN(w) && w > 0) list.push({ date: doc.id.slice(5), weight: w });
          });
          setHistory(list);
        } catch (e) { if (e.code === "permission-denied") setPermissionError(true); }
      }, [baseUserPath]);

      useEffect(() => { loadHistory(); }, [loadHistory, date]);

      const totals = useMemo(() => computeMealTotals(data.meals || []), [data.meals]);

      const incrementField = async (field, amount) => {
        if (!baseUserPath) return;
        const ref = dayDocRef(date);
        if (!ref) return;
        setData(prev => ({ ...prev, [field]: clampNum(prev[field], 0) + amount }));
        try {
          await ref.set({
            [field]: firebase.firestore.FieldValue.increment(amount),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        } catch (e) { if (e.code === "permission-denied") setPermissionError(true); }
      };

      const updateDay = async (patch) => {
        if (!baseUserPath) return;
        const ref = dayDocRef(date);
        if (!ref) return;
        setData(prev => ({ ...prev, ...patch }));
        try {
          await ref.set({ ...patch, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
        } catch (e) { if (e.code === "permission-denied") setPermissionError(true); }
      };

      const addMeal = async (meal) => {
        if (!baseUserPath) return;
        const ref = dayDocRef(date);
        if (!ref) return;
        try {
          await db.runTransaction(async (tx) => {
            const doc = await tx.get(ref);
            const cur = doc.exists ? (doc.data() || {}) : {};
            const meals = Array.isArray(cur.meals) ? cur.meals : [];
            tx.set(ref, { meals: [...meals, meal], updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
          });
          loadHistory();
        } catch (e) { alert("æ–°å¢å¤±æ•—ï¼š" + e.message); }
      };

      const deleteMeal = async (mealId) => {
        if (!baseUserPath) return;
        const ref = dayDocRef(date);
        if (!ref) return;
        try {
          await db.runTransaction(async (tx) => {
            const doc = await tx.get(ref);
            const cur = doc.exists ? (doc.data() || {}) : {};
            const meals = Array.isArray(cur.meals) ? cur.meals : [];
            const next = meals.filter(m => m.id !== mealId);
            tx.set(ref, { meals: next, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
          });
          loadHistory();
        } catch (e) { alert("åˆªé™¤å¤±æ•—ï¼š" + e.message); }
      };

      const savePresetFromMeal = async (meal) => {
        const defaultLabel = safeText(meal.name) || "å¸¸ç”¨é¤é»";
        const label = prompt("è«‹å¹«é€™å€‹å¸¸ç”¨é¤é»å–åå­—", defaultLabel);
        if (!label) return;
        const preset = {
          id: uuid(), label: safeText(label), category: meal.category || "snack",
          text: safeText(meal.text) || safeText(meal.name) || safeText(label),
          calories: clampNum(meal.calories, 0), protein: clampNum(meal.protein, 0),
          carbs: clampNum(meal.carbs, 0), fat: clampNum(meal.fat, 0), createdAtMs: Date.now()
        };
        if (!settingsRef) return;
        try {
          await db.runTransaction(async (tx) => {
            const doc = await tx.get(settingsRef);
            const cur = doc.exists ? (doc.data() || {}) : {};
            const list = Array.isArray(cur.presets) ? cur.presets : [];
            const filtered = list.filter(p => (p.label || p.name) !== preset.label);
            tx.set(settingsRef, { targets, presets: [...filtered, preset], updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
          });
          alert("å·²å­˜æˆå¸¸ç”¨é¤é»ï¼š" + preset.label);
        } catch (e) { alert("å„²å­˜å¤±æ•—ï¼š" + e.message); }
      };

      const deletePreset = async (presetId) => {
        if (!settingsRef) return;
        try {
          await db.runTransaction(async (tx) => {
            const doc = await tx.get(settingsRef);
            const cur = doc.exists ? (doc.data() || {}) : {};
            const list = Array.isArray(cur.presets) ? cur.presets : [];
            const next = list.filter(p => p.id !== presetId);
            tx.set(settingsRef, { targets, presets: next, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
          });
        } catch (e) { alert("åˆªé™¤å¤±æ•—ï¼š" + e.message); }
      };

      const saveAllSettings = async () => {
        const id = safeText(localSyncId);
        if (!id) { alert("åŒæ­¥ä»£è™Ÿä¸å¯ç‚ºç©º"); return; }
        localStorage.setItem("health_log_sync_id", id);
        setSyncId(id);
        try {
          await db.doc(`artifacts/health-tracker-v1/users/${id}/settings/config`).set({
            targets, presets, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
          alert("å·²å„²å­˜è¨­å®šï¼\nè«‹é‡æ–°æ•´ç†é é¢ç¢ºä¿åŒæ­¥ç”Ÿæ•ˆã€‚");
          window.location.reload();
        } catch (e) { alert("å„²å­˜å¤±æ•—ï¼š" + e.message); }
      };

      const coachPreview = useMemo(() => {
        const hasAny = safeText(data.weight) || safeText(data.sleep) || (data.meals || []).length || clampNum(prevData.water,0) || clampNum(prevData.steps,0) || (prevData.meals||[]).length;
        if (!hasAny) return "ï¼ˆé‚„æ²’æœ‰è³‡æ–™ã€‚å…ˆåˆ°ã€Œç´€éŒ„ã€é å¡«è³‡æ–™ï¼Œæˆ–å¡«æ˜¨å¤©çš„å–æ°´/æ­¥æ•¸/é‹å‹•/é£²é£Ÿã€‚ï¼‰";
        return buildCoachReport({ date, today: data, prev: prevData });
      }, [date, data, prevData]);

      const copyCoachReport = async () => {
        const text = buildCoachReport({ date, today: data, prev: prevData });
        try {
          await navigator.clipboard.writeText(text);
          alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ âœ…");
        } catch {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ âœ…");
        }
      };

      const exportCsv = async () => {
        if (!baseUserPath) return;
        try {
          const col = db.collection(`${baseUserPath}/daily_logs`);
          const snap = await col.orderBy(firebase.firestore.FieldPath.documentId(), "asc").limit(400).get();
          const map = {};
          const dates = [];
          snap.forEach(doc => { map[doc.id] = { ...DEFAULT_DAY, ...doc.data() }; dates.push(doc.id); });

          const header = ["record_date","fasting_weight_kg","morning_fatigue_1to10","sleep_hours_prev_day","water_ml_prev_day","steps_prev_day","cardio_prev_day","calories_prev_day","protein_prev_day","carbs_prev_day","fat_prev_day","breakfast_prev_day","lunch_prev_day","dinner_prev_day","snack_prev_day","workout_prev_day"];
          const rows = [header.join(",")];
          dates.forEach(d => {
            const today = map[d] || DEFAULT_DAY;
            const prevId = shiftDate(d, -1);
            const prev = map[prevId] || DEFAULT_DAY;
            const prevTotals = computeMealTotals(prev.meals || []);
            rows.push([d, safeText(today.weight), today.fatigue || "", safeText(today.sleep), clampNum(prev.water, 0), clampNum(prev.steps, 0), formatCardio(prev), Math.round(prevTotals.cal), Math.round(prevTotals.pro), Math.round(prevTotals.carb), Math.round(prevTotals.fat), mealsToTextByCategory(prev.meals || [], "breakfast"), mealsToTextByCategory(prev.meals || [], "lunch"), mealsToTextByCategory(prev.meals || [], "dinner"), mealsToTextByCategory(prev.meals || [], "snack"), formatWorkout(prev)].map(csvEscape).join(","));
          });
          const blob = new Blob([rows.join("\n")], { type: "text/csv;charset=utf-8;" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `healthlog_coach_report_${date}.csv`;
          a.click();
          URL.revokeObjectURL(url);
        } catch (e) { alert("åŒ¯å‡ºå¤±æ•—ï¼š" + e.message); }
      };

      if (permissionError) {
        return (
          <div className="min-h-screen p-6 max-w-md mx-auto">
            <Card className="border-danger">
              <SectionTitle icon="error" title="Firebase æ¬Šé™éŒ¯èª¤" />
              <div className="text-secondary space-y-2 text-sm">
                <div>Firestore æ‹’çµ•å­˜å–ã€‚è«‹ç¢ºèªä½ çš„åŒæ­¥ä»£è™Ÿæ˜¯å¦æ­£ç¢ºã€‚</div>
                <div className="mono text-xs bg-inputBg p-3 rounded-xl border border-borderBeige">artifacts/health-tracker-v1/users/{syncId}/...</div>
                <OutlineButton className="mt-4" onClick={() => window.location.reload()}>é‡æ–°æ•´ç†</OutlineButton>
              </div>
            </Card>
          </div>
        );
      }

      return (
        <div className="min-h-screen max-w-md mx-auto pb-20">
          <header className="sticky top-0 z-10 bg-bgMain/95 backdrop-blur border-b border-borderBeige px-4 py-4">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-xs text-secondary/70">Nicole 2026 Health Log</div>
                <div className="font-extrabold text-primary text-xl">ä»Šæ—¥ç¸½è¦½</div>
              </div>
              <div className="flex items-center gap-2 bg-white rounded-xl border border-borderBeige px-2 shadow-sm">
                <button onClick={() => setDate(shiftDate(date, -1))} className="p-2 text-primary material-icons">chevron_left</button>
                <div className="relative">
                  <input type="date" value={date} onChange={e => setDate(e.target.value)} required />
                </div>
                <button onClick={() => setDate(shiftDate(date, 1))} className="p-2 text-primary material-icons">chevron_right</button>
              </div>
            </div>
            <div className="mt-2 text-xs text-secondary/70">åŒæ­¥ä»£è™Ÿï¼š<span className="mono">{syncId || "-"}</span></div>
          </header>

          <main className="p-4">
            {loading ? <div className="text-center text-secondary/70 py-10">è¼‰å…¥ä¸­...</div> : (
              <>
                {view === "dashboard" && <DashboardPage date={date} data={data} targets={targets} totals={totals} onQuickAdd={(f,v)=>incrementField(f,v)} onCopyCoachReport={copyCoachReport} coachPreview={coachPreview} />}
                {view === "log" && <LogPage date={date} data={data} targets={targets} apiKey={apiKey} presets={presets} onUpdate={updateDay} onAddMeal={addMeal} onDeleteMeal={deleteMeal} onSavePreset={savePresetFromMeal} />}
                {view === "history" && <HistoryPage history={history} onExportCsv={exportCsv} />}
                {view === "settings" && <SettingsPage syncId={syncId} localSyncId={localSyncId} setLocalSyncId={setLocalSyncId} targets={targets} setTargets={setTargets} apiKey={apiKey} setApiKey={setApiKey} presets={presets} onDeletePreset={deletePreset} onSaveAll={saveAllSettings} />}
              </>
            )}
          </main>

          <nav className="fixed bottom-0 w-full max-w-md bg-white border-t border-borderBeige flex justify-around p-2 pb-6 z-20 shadow-lg">
            <button onClick={() => setView("dashboard")} className={"flex flex-col items-center w-16 transition-colors " + (view==="dashboard" ? "text-primary" : "text-secondary/50")}>
              <span className="material-icons">dashboard</span><span className="text-xs font-bold">ç¸½è¦½</span>
            </button>
            <button onClick={() => setView("log")} className={"flex flex-col items-center w-16 transition-colors " + (view==="log" ? "text-primary" : "text-secondary/50")}>
              <span className="material-icons">edit_note</span><span className="text-xs font-bold">ç´€éŒ„</span>
            </button>
            <button onClick={() => setView("history")} className={"flex flex-col items-center w-16 transition-colors " + (view==="history" ? "text-primary" : "text-secondary/50")}>
              <span className="material-icons">show_chart</span><span className="text-xs font-bold">æ­·å²</span>
            </button>
            <button onClick={() => setView("settings")} className={"flex flex-col items-center w-16 transition-colors " + (view==="settings" ? "text-primary" : "text-secondary/50")}>
              <span className="material-icons">settings</span><span className="text-xs font-bold">è¨­å®š</span>
            </button>
          </nav>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>