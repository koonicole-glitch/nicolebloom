<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nicole 2026 ç¾å¤¢æˆçœŸè¨ˆç•« v1.1</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ¿</text></svg>">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4322/4322991.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Health Log">
    <meta name="theme-color" content="#FFFBF5">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bgMain: '#FFFBF5',
                        cardBg: '#FFFFFF',
                        primary: '#4A5D23',
                        secondary: '#6B5E52',
                        inputBg: '#F5F2EB',
                        borderBeige: '#E8E4D9',
                        activeTab: '#4A5D23',
                        inactiveTab: '#A8A29E'
                    },
                    borderRadius: { 'xl': '14px', '2xl': '20px' }
                }
            }
        }
    </script>

    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/markdown-it@13.0.1/dist/markdown-it.min.js"></script>

    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body { 
            background-color: #FFFBF5; 
            color: #4A5D23; 
            font-family: system-ui, -apple-system, sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        input, select, button, textarea, p, span, div { font-size: 18px; }
        h1 { font-size: 24px; } h2 { font-size: 22px; } h3 { font-size: 20px; }
        .big-num { font-size: 48px; font-weight: 800; line-height: 1; }
        .card-shadow { box-shadow: 0 4px 12px rgba(74, 93, 35, 0.08); }
        input:focus, textarea:focus { outline: 2px solid #4A5D23; background-color: #ffffff; }
        .markdown-body p { margin-bottom: 1em; line-height: 1.6; }
        .markdown-body ul { list-style: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body ol { list-style: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body strong { color: #4A5D23; }
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; line-height: 1.5; margin-bottom: 8px; position: relative; }
        .chat-user { background-color: #4A5D23; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-ai { background-color: #F5F2EB; color: #4A5D23; align-self: flex-start; border-bottom-left-radius: 4px; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 50; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <div id="root">
        <div style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #4A5D23;">
            <div style="font-size: 40px; margin-bottom: 20px;">ğŸŒ¿</div>
            <div>æ­£åœ¨å•Ÿå‹• Health Log...</div>
            <div id="error-msg" style="font-size: 12px; margin-top: 20px; color: red; max-width: 80%; text-align: center;"></div>
        </div>
    </div>

    <script>
        window.onerror = function(msg, url, line) {
            document.getElementById('error-msg').innerText = "ç³»çµ±åµæ¸¬åˆ°éŒ¯èª¤: " + msg + " (Line: " + line + ")";
        };
    </script>

    <script type="text/babel">
        // --- 1. Firebase åˆå§‹åŒ– ---
        const firebaseConfig = {
            apiKey: "AIzaSyD6FsP4PtdeeD_uuIRnWbbLzsKwHlgS9cM",
            authDomain: "health-tracker-b37e4.firebaseapp.com",
            projectId: "health-tracker-b37e4",
            storageBucket: "health-tracker-b37e4.firebasestorage.app",
            messagingSenderId: "802888614022",
            appId: "1:802888614022:web:e7ec85eef3dfc088aed107"
        };

        if (typeof firebase !== 'undefined' && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else if (typeof firebase === 'undefined') {
            document.getElementById('error-msg').innerText = "Firebase è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š";
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. å·¥å…·å‡½æ•¸èˆ‡å¸¸æ•¸ ---
        const { useState, useEffect, useMemo, useRef } = React;
        // ä¿®æ­£ï¼šå°‡ Recharts å’Œ markdownit çš„åˆå§‹åŒ–ç§»åˆ°ä½¿ç”¨æ™‚ï¼Œé¿å…å…¨åŸŸéŒ¯èª¤
        const Recharts = window.Recharts || {};
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = Recharts;

        const getTodayString = () => {
            const d = new Date();
            const offset = d.getTimezoneOffset() * 60000;
            return new Date(d.getTime() - offset).toISOString().split('T')[0];
        };

        const shiftDate = (dateStr, days) => {
            const d = new Date(dateStr);
            d.setDate(d.getDate() + days);
            return d.toISOString().split('T')[0];
        };

        const getDefaultMealCategory = () => {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 11) return 'breakfast';
            if (hour >= 11 && hour < 15) return 'lunch';
            if (hour >= 17 && hour < 21) return 'dinner';
            return 'snack';
        };

        const MEAL_CATEGORIES = {
            'breakfast': 'æ—©é¤',
            'lunch': 'åˆé¤',
            'dinner': 'æ™šé¤',
            'snack': 'é»å¿ƒ'
        };

        const fallbackAnalysis = (text) => {
            let c=0, p=0, cb=0, f=0;
            const t = text.toLowerCase();
            // åŸºç¤é—œéµå­—æ¯”å°
            if (t.includes('é›æ’') || t.includes('ç‚¸é›')) { c+=600; p+=40; f+=35; cb+=20; }
            else if (t.includes('é›') || t.includes('è‚‰') || t.includes('é­š')) { c+=200; p+=25; f+=10; }
            if (t.includes('èŠ‹æ³¥') || t.includes('èŠ‹é ­')) { c+=150; cb+=35; f+=5; }
            if (t.includes('ç”œä¸è¾£')) { c+=200; cb+=30; f+=10; p+=5; }
            if (t.includes('é£¯') || t.includes('ç²¥')) { c+=280; p+=4; cb+=60; }
            if (t.includes('éºµ')) { c+=300; p+=8; cb+=50; }
            if (t.includes('èœ') || t.includes('è”¬') || t.includes('æ²™æ‹‰')) { c+=50; cb+=10; }
            if (t.includes('ä¾¿ç•¶')) { c=800; p=25; cb=80; f=35; }
            if (t.includes('å¥¶') || t.includes('æ‹¿éµ')) { c+=150; p+=8; f+=8; cb+=10; }
            if (t.includes('ç‚¸') && !t.includes('é›æ’')) { c+=150; f+=15; }
            if (t.includes('è›‹')) { c+=75; p+=7; f+=5; }
            if (t.includes('é¦™è•‰')) { c+=100; cb+=25; } // æ–°å¢å¸¸è¦‹æ°´æœ
            
            if (c===0 && t.length > 0) c=200; // çœŸçš„æ‰¾ä¸åˆ°æ™‚çš„é è¨­å€¼
            return { name: text, calories: c, protein: p, carbs: cb, fat: f };
        };

        // --- 3. UI Components ---
        const Loading = () => {
            const [showReset, setShowReset] = useState(false);
            useEffect(() => {
                const timer = setTimeout(() => setShowReset(true), 5000); // å»¶é•·åˆ°5ç§’
                return () => clearTimeout(timer);
            }, []);
            const handleReset = () => {
                if(confirm('é€™å°‡æ¸…é™¤æ­¤è£ç½®ä¸Šçš„åŒæ­¥è¨­å®šä¸¦é‡æ–°è¼‰å…¥ï¼Œç¢ºå®šå—ï¼Ÿ(æ‚¨çš„é›²ç«¯è³‡æ–™ä¸æœƒæ¶ˆå¤±)')) {
                    localStorage.removeItem('health_log_sync_id');
                    window.location.reload();
                }
            };
            return (
                <div className="flex h-screen items-center justify-center bg-bgMain text-primary flex-col p-6 text-center">
                    <span className="material-icons text-6xl animate-bounce mb-4">fitness_center</span>
                    <p className="text-xl font-bold mb-8">è¼‰å…¥è³‡æ–™ä¸­...</p>
                    {showReset && (
                        <div className="animate-fade-in">
                            <p className="text-secondary mb-2 text-sm">è¼‰å…¥ä¼¼ä¹å¡ä½äº†ï¼Ÿ</p>
                            <button onClick={handleReset} className="bg-red-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform flex items-center gap-2">
                                <span className="material-icons">restart_alt</span> âš ï¸ é»æ­¤é‡ç½®ç³»çµ±
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        const Card = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`bg-cardBg rounded-2xl p-6 card-shadow border border-borderBeige ${className}`}>
                {children}
            </div>
        );

        const Button = ({ children, onClick, variant = 'primary', className = "", disabled=false }) => {
            const baseStyle = "w-full py-4 rounded-xl font-bold text-lg transition-transform active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed";
            const styles = {
                primary: "bg-primary text-white shadow-lg shadow-primary/30",
                secondary: "bg-secondary text-white",
                outline: "border-2 border-primary text-primary bg-transparent",
                ghost: "bg-inputBg text-secondary"
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${styles[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const InputGroup = ({ label, value, onChange, type = "text", placeholder, suffix }) => (
            <div className="mb-4">
                <label className="block text-secondary mb-2 font-bold">{label}</label>
                <div className="relative">
                    <input type={type} value={value} onChange={onChange} placeholder={placeholder}
                        className="w-full bg-inputBg rounded-xl p-4 text-primary font-bold border-none" />
                    {suffix && <span className="absolute right-4 top-4 text-secondary">{suffix}</span>}
                </div>
            </div>
        );

        // --- 4. ä¸»è¦é é¢çµ„ä»¶ ---
        const Dashboard = ({ data, targets, totals, onQuickAdd, onCopy, isWorkoutDay }) => {
            const currentTargets = isWorkoutDay ? targets.workout : targets.rest;
            const remainingCal = currentTargets.calories - totals.cal;
            const getAdvice = () => {
                if (data.water < targets.water * 0.5) return { icon: 'water_drop', text: "æ°´åˆ†æ”å–ä¸è¶³ï¼Œå¿«å–æ¯æ°´ï¼", color: "text-blue-500" };
                if (totals.pro < currentTargets.protein * 0.4) return { icon: 'egg_alt', text: "è›‹ç™½è³ªé€²åº¦è½å¾Œï¼Œæ™šé¤å¤šåƒé»è‚‰æˆ–è›‹ã€‚", color: "text-primary" };
                if (data.sleep > 0 && data.sleep < 6) return { icon: 'bedtime', text: "æ˜¨æ™šç¡å¤ªå°‘å›‰ï¼Œä»Šæ™šæ—©é»ä¼‘æ¯ï¼", color: "text-purple-500" };
                if (isWorkoutDay) return { icon: 'fitness_center', text: "ä»Šå¤©æ˜¯è¨“ç·´æ—¥ï¼Œç›®æ¨™å·²è‡ªå‹•èª¿é«˜ï¼", color: "text-orange-500" };
                return { icon: 'thumb_up', text: "ä»Šå¤©ç‹€æ…‹ä¸éŒ¯ï¼Œç¹¼çºŒä¿æŒï¼", color: "text-primary" };
            };
            const advice = getAdvice();

            return (
                <div className="space-y-6 animate-fade-in">
                    <Card className="bg-primary text-white border-none">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h2 className="text-white/90 text-lg">ä»Šæ—¥å‰©é¤˜</h2>
                                <div className="big-num">{Math.round(remainingCal)}</div>
                                <div className="text-white/80 text-sm">kcal</div>
                            </div>
                            <div className="text-right">
                                <div className={`px-3 py-1 rounded-full text-sm font-bold inline-block mb-1 ${isWorkoutDay ? 'bg-orange-400 text-white' : 'bg-white/20'}`}>
                                    {isWorkoutDay ? 'ğŸ”¥ é‹å‹•æ—¥' : 'â˜• ä¼‘æ¯æ—¥'}
                                </div>
                                <div className="text-white/90 text-sm">æ”å– {Math.round(totals.cal)} / {currentTargets.calories}</div>
                            </div>
                        </div>
                        <div className="grid grid-cols-3 gap-2 mt-4">
                            <div className="bg-white/10 p-2 rounded-lg text-center">
                                <div className="text-xs opacity-70">è›‹ç™½è³ª</div>
                                <div className="font-bold">{Math.round(totals.pro)}/{currentTargets.protein}</div>
                            </div>
                            <div className="bg-white/10 p-2 rounded-lg text-center">
                                <div className="text-xs opacity-70">ç¢³æ°´</div>
                                <div className="font-bold">{Math.round(totals.carb)}/{currentTargets.carbs}</div>
                            </div>
                            <div className="bg-white/10 p-2 rounded-lg text-center">
                                <div className="text-xs opacity-70">è„‚è‚ª</div>
                                <div className="font-bold">{Math.round(totals.fat)}/{currentTargets.fat}</div>
                            </div>
                        </div>
                    </Card>
                    <Card className="flex items-center gap-4 bg-yellow-50 border-yellow-100">
                        <span className={`material-icons text-3xl ${advice.color}`}>{advice.icon}</span>
                        <div>
                            <h3 className="font-bold text-secondary">AI å°åŠ©æ‰‹</h3>
                            <p className="text-sm text-secondary">{advice.text}</p>
                        </div>
                    </Card>
                    <div className="grid grid-cols-2 gap-4">
                        <Card onClick={() => onQuickAdd('water', 250)} className="cursor-pointer active:scale-95 transition-transform relative overflow-hidden">
                            <div className="absolute right-[-10px] bottom-[-10px] opacity-10"><span className="material-icons text-8xl text-blue-500">water_drop</span></div>
                            <h3 className="text-secondary font-bold">æ°´åˆ†</h3>
                            <div className="flex items-baseline gap-1 mt-1"><span className="text-3xl font-bold text-blue-600">{data.water}</span><span className="text-sm">ml</span></div>
                            <div className="mt-2 text-xs text-secondary bg-inputBg inline-block px-2 py-1 rounded">+250ml</div>
                        </Card>
                        <Card onClick={() => onQuickAdd('steps', 500)} className="cursor-pointer active:scale-95 transition-transform relative overflow-hidden">
                             <div className="absolute right-[-10px] bottom-[-10px] opacity-10"><span className="material-icons text-8xl text-orange-500">directions_run</span></div>
                            <h3 className="text-secondary font-bold">æ­¥æ•¸</h3>
                            <div className="flex items-baseline gap-1 mt-1"><span className="text-3xl font-bold text-orange-600">{data.steps}</span><span className="text-sm">æ­¥</span></div>
                            <div className="mt-2 text-xs text-secondary bg-inputBg inline-block px-2 py-1 rounded">+500æ­¥</div>
                        </Card>
                    </div>
                    <Button variant="secondary" onClick={onCopy}>
                        <span className="material-icons">content_copy</span> è¤‡è£½çµ¦æ•™ç·´
                    </Button>
                </div>
            );
        };

        const LogPage = ({ data, onUpdate, onAddMeal, deleteMeal, apiKey, favorites, onToggleFavorite }) => {
            const [mealInput, setMealInput] = useState('');
            const [manualMode, setManualMode] = useState(false);
            const [analyzing, setAnalyzing] = useState(false);
            const [selectedCategory, setSelectedCategory] = useState(getDefaultMealCategory());
            const [manualMeal, setManualMeal] = useState({ name: '', calories: '', protein: '', carbs: '', fat: '' });
            const [showFavModal, setShowFavModal] = useState(false);

            const analyzeWithAI = async (text) => {
                if (!apiKey) return fallbackAnalysis(text);
                try {
                    // é‡è¦ä¿®æ­£ï¼šå¼·åˆ¶ JSON å›å‚³æ¨¡å¼
                    const prompt = `åˆ†æä»¥ä¸‹é£Ÿç‰©çš„ç‡Ÿé¤Šæˆåˆ†ã€‚é£Ÿç‰©åç¨±ï¼š${text}ã€‚
                    è«‹å›å‚³ä¸€å€‹ JSON ç‰©ä»¶ï¼Œæ ¼å¼å¿…é ˆç‚ºï¼š
                    {"name": "${text}", "calories": æ•¸å­—(å¤§å¡), "protein": æ•¸å­—(g), "carbs": æ•¸å­—(g), "fat": æ•¸å­—(g)}ã€‚
                    å¦‚æœæ˜¯ç‚¸ç‰©è«‹é©ç•¶åŠ é«˜ç†±é‡ã€‚è«‹ç¢ºä¿æ¬„ä½åç¨±å®Œå…¨æ­£ç¢ºä¸”ç‚ºå°å¯«è‹±æ–‡ã€‚`;
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { response_mime_type: "application/json" } // é—œéµä¿®æ­£ï¼šå¼·åˆ¶ JSON æ¨¡å¼
                        })
                    });
                    const result = await response.json();
                    
                    // è§£æå›å‚³çš„ JSON
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedData = JSON.parse(jsonText);
                    
                    // ç¢ºä¿æ•¸å€¼å‹åˆ¥æ­£ç¢º
                    return {
                        name: parsedData.name || text,
                        calories: Number(parsedData.calories) || 0,
                        protein: Number(parsedData.protein) || 0,
                        carbs: Number(parsedData.carbs) || 0,
                        fat: Number(parsedData.fat) || 0
                    };

                } catch (e) {
                    console.error("AI Analysis failed", e);
                    alert("AI åˆ†æå¤±æ•—ï¼Œå·²åˆ‡æ›è‡³ä¼°ç®—æ¨¡å¼ã€‚åŸå› ï¼š" + e.message);
                    return fallbackAnalysis(text);
                }
            };

            const handleAdd = async (mealDataOverride = null) => {
                let mealToAdd = mealDataOverride;

                if (!mealToAdd) {
                    if(manualMode) {
                        mealToAdd = {
                            name: manualMeal.name || 'è‡ªè¨‚é¤é»',
                            calories: Number(manualMeal.calories),
                            protein: Number(manualMeal.protein),
                            carbs: Number(manualMeal.carbs),
                            fat: Number(manualMeal.fat)
                        };
                        setManualMeal({ name: '', calories: '', protein: '', carbs: '', fat: '' });
                        setManualMode(false);
                    } else {
                        if (!mealInput) return;
                        if (apiKey) {
                            setAnalyzing(true);
                            mealToAdd = await analyzeWithAI(mealInput);
                            setAnalyzing(false);
                        } else {
                            mealToAdd = fallbackAnalysis(mealInput);
                        }
                        setMealInput('');
                    }
                }

                if (mealToAdd) {
                    onAddMeal({ ...mealToAdd, category: selectedCategory });
                }
            };

            const mealsByCategory = useMemo(() => {
                const groups = { breakfast: [], lunch: [], dinner: [], snack: [] };
                (data.meals || []).forEach(m => {
                    const cat = m.category || 'snack';
                    if (groups[cat]) groups[cat].push(m);
                });
                return groups;
            }, [data.meals]);

            return (
                <div className="space-y-6 pb-20">
                    <Card>
                        <h3 className="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                            <span className="material-icons">accessibility</span> èº«é«”èˆ‡ç‹€æ…‹
                        </h3>
                        <div className="grid grid-cols-2 gap-4">
                            <InputGroup label="é«”é‡ (kg)" type="number" value={data.weight || ''} 
                                onChange={e => onUpdate({weight: e.target.value})} placeholder="0.0" />
                            <InputGroup label="ç¡çœ  (hr)" type="number" value={data.sleep || ''} 
                                onChange={e => onUpdate({sleep: e.target.value})} placeholder="7.0" />
                        </div>
                        <div>
                            <label className="block text-secondary mb-2 font-bold flex justify-between">
                                <span>ç–²å‹åº¦ (1-10)</span>
                                <span className="text-primary font-bold">{data.fatigue}</span>
                            </label>
                            <input type="range" min="1" max="10" value={data.fatigue} 
                                onChange={e => onUpdate({fatigue: parseInt(e.target.value)})}
                                className="w-full h-3 bg-inputBg rounded-lg appearance-none cursor-pointer accent-primary"/>
                        </div>
                    </Card>

                    <Card>
                        <h3 className="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                            <span className="material-icons">restaurant</span> é£²é£Ÿç´€éŒ„
                        </h3>
                        
                        {/* é¤åˆ¥é¸æ“‡ */}
                        <div className="flex bg-inputBg rounded-xl p-1 mb-4 overflow-x-auto">
                            {Object.entries(MEAL_CATEGORIES).map(([key, label]) => (
                                <button key={key} onClick={() => setSelectedCategory(key)}
                                    className={`flex-1 py-2 px-2 rounded-lg font-bold text-sm whitespace-nowrap transition-all ${selectedCategory === key ? 'bg-white shadow text-primary' : 'text-gray-400'}`}>
                                    {label}
                                </button>
                            ))}
                        </div>

                        <div className="flex gap-2 mb-2">
                            <button onClick={() => setManualMode(false)} className={`flex-1 py-2 rounded-lg font-bold text-sm ${!manualMode ? 'bg-primary text-white' : 'bg-inputBg text-secondary'}`}>
                                {apiKey ? 'âœ¨ AI æ™ºèƒ½è¼¸å…¥' : 'å¿«é€Ÿè¼¸å…¥'}
                            </button>
                            <button onClick={() => setManualMode(true)} className={`flex-1 py-2 rounded-lg font-bold text-sm ${manualMode ? 'bg-primary text-white' : 'bg-inputBg text-secondary'}`}>
                                æ‰‹å‹•è¼¸å…¥
                            </button>
                        </div>

                        {!manualMode ? (
                            <div className="flex gap-2 mb-4">
                                <button onClick={()=>setShowFavModal(true)} className="bg-yellow-400 text-white px-3 rounded-xl shadow-md flex items-center justify-center">
                                    <span className="material-icons">star</span>
                                </button>
                                <input type="text" placeholder={apiKey ? "è¼¸å…¥é¤é» (AI è‡ªå‹•åˆ†æ)" : "è¼¸å…¥é¤é»"}
                                    className="flex-1 bg-inputBg rounded-xl p-4 text-lg border-none min-w-0"
                                    value={mealInput} onChange={e => setMealInput(e.target.value)} 
                                    onKeyDown={e => e.key === 'Enter' && !analyzing && handleAdd()}
                                />
                                <button onClick={() => handleAdd()} disabled={analyzing} className="bg-primary text-white px-4 rounded-xl text-xl shadow-md min-w-[50px] flex items-center justify-center">
                                    {analyzing ? <span className="material-icons animate-spin text-lg">sync</span> : '+'}
                                </button>
                            </div>
                        ) : (
                            <div className="bg-inputBg p-4 rounded-xl mb-4 space-y-2">
                                <input placeholder="åç¨±" className="w-full p-2 rounded" value={manualMeal.name} onChange={e=>setManualMeal({...manualMeal, name: e.target.value})}/>
                                <div className="grid grid-cols-4 gap-2">
                                    <input type="number" placeholder="ç†±é‡" className="p-2 rounded" value={manualMeal.calories} onChange={e=>setManualMeal({...manualMeal, calories: e.target.value})}/>
                                    <input type="number" placeholder="è›‹" className="p-2 rounded" value={manualMeal.protein} onChange={e=>setManualMeal({...manualMeal, protein: e.target.value})}/>
                                    <input type="number" placeholder="ç¢³" className="p-2 rounded" value={manualMeal.carbs} onChange={e=>setManualMeal({...manualMeal, carbs: e.target.value})}/>
                                    <input type="number" placeholder="è„‚" className="p-2 rounded" value={manualMeal.fat} onChange={e=>setManualMeal({...manualMeal, fat: e.target.value})}/>
                                </div>
                                <button onClick={() => handleAdd()} className="w-full bg-secondary text-white py-2 rounded font-bold">æ–°å¢</button>
                            </div>
                        )}

                        {/* åˆ—è¡¨é¡¯ç¤º (åˆ†çµ„) */}
                        <div className="space-y-4">
                            {['breakfast', 'lunch', 'dinner', 'snack'].map(catKey => {
                                const groupMeals = mealsByCategory[catKey];
                                if (!groupMeals.length) return null;
                                return (
                                    <div key={catKey}>
                                        <h4 className="text-sm font-bold text-gray-400 mb-2 pl-1 border-b border-gray-100 pb-1">{MEAL_CATEGORIES[catKey]}</h4>
                                        <ul className="space-y-2">
                                            {groupMeals.map((m) => (
                                                <li key={m.id} className="flex justify-between items-center bg-inputBg p-3 rounded-xl">
                                                    <div className="flex-1">
                                                        <div className="text-base font-bold text-secondary flex items-center gap-1">
                                                            {m.name}
                                                            <button onClick={() => onToggleFavorite(m)} className="text-yellow-400 opacity-50 hover:opacity-100">
                                                                <span className="material-icons text-base">star_border</span>
                                                            </button>
                                                        </div>
                                                        <div className="text-xs text-gray-500">
                                                            {m.calories} kcal (P{m.protein} C{m.carbs} F{m.fat})
                                                        </div>
                                                    </div>
                                                    <button onClick={() => deleteMeal(m.id)} className="text-red-400 p-2">
                                                        <span className="material-icons text-lg">delete</span>
                                                    </button>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )
                            })}
                            {(!data.meals || data.meals.length === 0) && (
                                <div className="text-center text-gray-400 py-4 text-sm">å°šç„¡ç´€éŒ„</div>
                            )}
                        </div>
                    </Card>

                    <Card>
                        <h3 className="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                            <span className="material-icons">fitness_center</span> é‹å‹•ç´€éŒ„
                        </h3>
                        <div className